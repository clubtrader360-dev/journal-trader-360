<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Club Trader 360 - Journal de Trading Professionnel</title>
    <!-- 
    VERSION V46 DEBUG - Trade Duration Performance
    
    PROBL√àME: Le graphique Trade Duration Performance affiche toujours 30 minutes
    malgr√© l'ajout des heures de sortie (exitTime).
    
    LOGS DE DEBUG AJOUT√âS:
    1. Dans addTrade() : Collecte de exitTime depuis le formulaire
    2. Dans addTrade() : V√©rification tradeData avant sauvegarde
    3. Dans addTrade() : V√©rification apr√®s sauvegarde localStorage
    4. Dans loadFromStorage() : V√©rification trades charg√©s au d√©marrage
    5. Dans updateDurationChart() : Calcul de dur√©e pour chaque trade
    
    INSTRUCTIONS:
    1. Ouvrir la console du navigateur (F12)
    2. Ajouter un nouveau trade avec entryTime et exitTime
    3. Observer les logs dans la console
    4. Partager les logs pour diagnostic
    
    Rechercher dans console: "DEBUG addTrade", "DEBUG loadFromStorage", "DEBUG Duration"
    -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --trader-blue: #000B25;
            --trader-gold: #ac862b;
            --trader-light-blue: #E8F4FD;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--trader-blue) 0%, #2c3e50 100%);
            min-height: 100vh;
        }
        
        .trader-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 11, 37, 0.1);
            border: 1px solid rgba(172, 134, 43, 0.2);
        }
        
        .trader-btn {
            background: linear-gradient(135deg, var(--trader-gold) 0%, #b8932c 100%);
            color: var(--trader-blue);
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .trader-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(172, 134, 43, 0.3);
        }
        
        .trader-btn-secondary {
            background: var(--trader-blue);
            color: var(--trader-gold);
            border: 2px solid var(--trader-gold);
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .trader-btn-secondary:hover {
            background: var(--trader-gold);
            color: var(--trader-blue);
        }
        
        .sidebar {
            background: var(--trader-blue);
            color: white;
            width: 250px;
            min-height: 100vh;
        }
        
        .sidebar-item {
            padding: 16px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        
        .sidebar-item:hover, .sidebar-item.active, .sidebar-item.coach-active {
            background: rgba(172, 134, 43, 0.1);
            border-left-color: var(--trader-gold);
        }
        
        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 15px rgba(0, 11, 37, 0.1);
            border-left: 4px solid var(--trader-gold);
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--trader-blue);
        }
        
        .metric-label {
            color: #666;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
        
        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--trader-gold) 0%, #b8932c 100%);
            color: var(--trader-blue);
            border: none;
            border-radius: 50%;
            box-shadow: 0 8px 25px rgba(172, 134, 43, 0.4);
            cursor: pointer;
            font-size: 24px;
            transition: all 0.3s ease;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .refresh-btn:hover {
            transform: scale(1.1) rotate(180deg);
            box-shadow: 0 12px 35px rgba(172, 134, 43, 0.6);
        }
        
        .refresh-btn:active {
            transform: scale(0.95) rotate(180deg);
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: var(--trader-blue);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--trader-blue);
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--trader-gold);
        }
        
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--trader-blue) 0%, #2c3e50 100%);
        }
        
        .auth-card {
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }
        
        .logo {
            text-align: center;
            margin-bottom: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .logo img {
            display: block;
            margin: 0 auto;
        }
        
        .trade-row {
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .trade-row:hover {
            background-color: var(--trader-light-blue);
        }
        
        .action-btn {
            padding: 6px 12px;
            margin: 0 2px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }
        
        .btn-modify {
            background: #3498db;
            color: white;
        }
        
        .btn-note {
            background: var(--trader-gold);
            color: var(--trader-blue);
        }
        
        .btn-delete {
            background: #e74c3c;
            color: white;
        }
        
        .action-btn:hover {
            transform: scale(1.05);
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .account-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
            margin: 4px 0;
        }

        .account-item:hover {
            background: rgba(172, 134, 43, 0.1);
        }

        .account-checkbox {
            margin-right: 12px;
            width: 18px;
            height: 18px;
            accent-color: var(--trader-gold);
        }

        .account-info {
            flex: 1;
            min-width: 0;
        }

        .account-name {
            font-weight: 600;
            font-size: 14px;
        }

        .account-size {
            font-size: 12px;
            color: #ccc;
        }

        .account-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 8px;
        }

        .account-delete-btn {
            background: transparent;
            border: none;
            color: #ef4444;
            cursor: pointer;
            padding: 8px 10px;
            border-radius: 6px;
            transition: all 0.3s ease;
            font-size: 14px;
            margin-left: 8px;
            opacity: 0.7;
        }

        .account-delete-btn:hover {
            background: rgba(239, 68, 68, 0.1);
            opacity: 1;
            transform: scale(1.1);
        }

        .account-delete-btn:active {
            transform: scale(0.95);
        }

        /* TradersZella Style Top Banner */
        .traderzella-banner {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 32px;
        }

        .metric-item {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            min-width: 150px;
        }

        .metric-item.net-pnl {
            min-width: 200px;
        }

        .metric-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        .metric-main {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
        }

        .metric-value-large {
            font-size: 28px;
            font-weight: 700;
            color: #10b981;
        }

        .metric-value-medium {
            font-size: 24px;
            font-weight: 700;
            color: #000B25;
        }

        /* Barres horizontales simples pour les m√©triques */
        .metric-bar-container {
            width: 100px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .metric-bar-bg {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .metric-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease, background-color 0.3s ease;
        }

        .metric-bar-fill.green {
            background: #10b981;
        }

        .metric-bar-fill.orange {
            background: #f59e0b;
        }

        .metric-bar-fill.red {
            background: #ef4444;
        }

        .win-loss-bars {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .win-bar, .loss-bar {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .bar {
            width: 40px;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 12px;
        }

        .win-bar .bar {
            background: #10b981;
        }

        .loss-bar .bar {
            background: #ef4444;
        }

        .bar-label {
            font-size: 14px;
            font-weight: 600;
        }

        .win-bar .bar-label {
            color: #10b981;
        }

        .loss-bar .bar-label {
            color: #ef4444;
        }

        .metric-counts {
            display: flex;
            gap: 8px;
            font-size: 12px;
            margin-top: 4px;
        }

        .count-item {
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .count-item::before {
            content: attr(data-label);
            font-weight: 400;
            opacity: 0.8;
            font-size: 10px;
        }

        .count-win {
            background: #dcfce7;
            color: #166534;
        }

        .count-neutral {
            background: #f3f4f6;
            color: #374151;
        }

        .count-loss {
            background: #fef2f2;
            color: #dc2626;
        }
        
        /* Styles pour le menu des param√®tres du calendrier */
        #calendarSettings {
            position: absolute;
            right: 0;
            margin-top: 8px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 11, 37, 0.2);
            border: 1px solid rgba(172, 134, 43, 0.3);
            padding: 16px;
            min-width: 250px;
            z-index: 1000;
        }
        
        #calendarSettings h4 {
            color: var(--trader-blue);
            margin-bottom: 12px;
            font-size: 14px;
        }
        
        /* Ajuster la taille des cellules du calendrier pour plus d'infos */
        #calendarGrid > div {
            min-height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding-top: 8px;
        }
        
        /* Tooltips pour les ic√¥nes info */
        .info-icon {
            position: relative;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .info-icon:hover {
            color: var(--trader-gold) !important;
        }
        
        .tooltip {
            display: none;
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-top: 10px;
            padding: 10px 14px;
            background: linear-gradient(135deg, rgba(0, 11, 37, 0.98) 0%, rgba(0, 24, 69, 0.98) 100%);
            color: #ffffff;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 400;
            line-height: 1.4;
            white-space: normal;
            width: 240px;
            text-align: left;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(172, 134, 43, 0.6);
            z-index: 1000;
            backdrop-filter: blur(10px);
        }
        
        .tooltip::after {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-bottom-color: rgba(0, 11, 37, 0.98);
        }
        
        .info-icon:hover .tooltip,
        .info-icon.active .tooltip {
            display: block;
        }

        
        /* Modal styles pour boutons Voir */
        .view-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
        }
        
        .view-modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .view-modal-close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .view-modal-close:hover {
            color: #000;
        }
        
        .view-modal-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 10px;
        }
        
        .view-modal-label {
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 5px;
            display: block;
        }
        
        .view-modal-value {
            color: #111827;
            font-size: 1.1rem;
        }
        
        .image-zoom-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.95);
        }
        
        .image-zoom-content {
            position: relative;
            margin: auto;
            width: 90%;
            height: 90%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .image-zoom-content img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 10px;
        }
        
        .image-zoom-close {
            position: absolute;
            top: 20px;
            right: 40px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }
    </style>
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Scripts Supabase d√©plac√©s avant </body> -->
</head>
<body>
    <!-- Auth Screen -->
    <div id="authScreen" class="auth-container">
        <div class="auth-card">
            <div class="logo">
                <img src="https://page.gensparksite.com/v1/base64_upload/3b1a581410ba30561b2214b0a075af1a" alt="Trader 360 Logo" style="width: 120px; height: auto;">
                <div style="color: #666; font-size: 0.875rem; margin-top: 15px;">Journal de Trading Professionnel</div>
            </div>
            
            <div id="loginForm">
                <h2 class="text-2xl font-bold text-center mb-6" style="color: #000B25;">Connexion</h2>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" placeholder="votre@email.com">
                </div>
                <div class="form-group">
                    <label>Mot de passe</label>
                    <input type="password" id="loginPassword" placeholder="Votre mot de passe">
                </div>
                <button onclick="login()" class="trader-btn w-full mb-4">Se connecter</button>
                <button onclick="showRegisterForm()" class="trader-btn-secondary w-full mb-4">Cr√©er un compte</button>
                <button onclick="showCoachLogin()" class="trader-btn-secondary w-full">Connexion Coach</button>
                <div id="loginError" class="text-red-500 text-sm mt-4 hidden"></div>
            </div>
            
            <div id="registerForm" style="display: none;">
                <h2 class="text-2xl font-bold text-center mb-6" style="color: #000B25;">Inscription</h2>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="registerEmail" placeholder="votre@email.com">
                </div>
                <div class="form-group">
                    <label>Mot de passe</label>
                    <input type="password" id="registerPassword" placeholder="Choisissez un mot de passe">
                </div>
                <div class="form-group">
                    <label>Confirmer le mot de passe</label>
                    <input type="password" id="confirmPassword" placeholder="Confirmez votre mot de passe">
                </div>
                <button onclick="register()" class="trader-btn w-full mb-4">S'inscrire</button>
                <button onclick="showLoginForm()" class="trader-btn-secondary w-full">Retour √† la connexion</button>
                <div id="registerError" class="text-red-500 text-sm mt-4 hidden"></div>
            </div>
            
            <div id="coachLoginForm" style="display: none;">
                <h2 class="text-2xl font-bold text-center mb-6" style="color: #000B25;">Connexion Coach</h2>
                <div class="form-group">
                    <label>Email Coach</label>
                    <input type="email" id="coachEmail" placeholder="coach@exemple.com">
                </div>
                <div class="form-group">
                    <label>Code Coach</label>
                    <input type="password" id="coachCode" placeholder="trader3602025">
                </div>
                <button onclick="coachLogin()" class="trader-btn w-full mb-4">Connexion Coach</button>
                <button onclick="showLoginForm()" class="trader-btn-secondary w-full">Retour</button>
                <div id="coachError" class="text-red-500 text-sm mt-4 hidden"></div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" style="display: none;" class="flex">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="p-6 border-b border-gray-700" style="text-align: center;">
                <img src="https://page.gensparksite.com/v1/base64_upload/3b1a581410ba30561b2214b0a075af1a" alt="Trader 360 Logo" style="width: 80px; height: auto; margin: 0 auto;">
                <div class="text-gray-300 text-sm mt-3" id="userInfo"></div>
            </div>
            
            <!-- Accounts Section -->
            <div class="p-4 border-b border-gray-700">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-sm font-semibold text-gray-300">Mes Comptes</h3>
                    <button onclick="showAddAccountModal()" class="text-xs bg-transparent border border-gold text-gold px-2 py-1 rounded hover:bg-gold hover:text-blue transition-colors" style="border-color: #ac862b; color: #ac862b;">
                        +
                    </button>
                </div>
                <div id="accountsList">
                    <!-- Accounts will be populated here -->
                </div>
            </div>
            
            <nav class="mt-6">
                <div class="sidebar-item active" onclick="showSection('dashboard')">
                    <i class="fas fa-tachometer-alt mr-3"></i>Tableau de bord
                </div>
                <div class="sidebar-item" onclick="showSection('tradelog')">
                    <i class="fas fa-list mr-3"></i>Journal des Trades
                </div>
                <div class="sidebar-item" onclick="showSection('dailyjournal')">
                    <i class="fas fa-book mr-3"></i>Journal Quotidien
                </div>
                <div class="sidebar-item" onclick="showSection('accounting')">
                    <i class="fas fa-wallet mr-3"></i>Comptabilit√©
                </div>
                <div class="sidebar-item" onclick="logout()" style="margin-top: 20px; border-top: 1px solid #374151; padding-top: 20px;">
                    <i class="fas fa-sign-out-alt mr-3"></i>D√©connexion
                </div>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="flex-1 p-8 bg-gray-50">
            <!-- Section Tableau de bord -->
            <div id="dashboard" class="section">
                <!-- TradersZella Style Top Banner -->
                <div class="traderzella-banner">
                    <!-- Net P&L -->
                    <div class="metric-item net-pnl">
                        <div class="metric-header">
                            Net P&L <i class="fas fa-info-circle info-icon" style="color: #ccc;"><span class="tooltip">le p&l net repr√©sente votre profit ou perte total sur tous vos trades. c'est la somme de tous les gains moins toutes les pertes.</span></i>
                        </div>
                        <div class="metric-main">
                            <div class="metric-value-large" id="netPnlValue">$0.00</div>
                            <i class="fas fa-chart-line" style="color: #10b981; font-size: 20px;"></i>
                        </div>
                    </div>

                    <!-- Trade win % -->
                    <div class="metric-item">
                        <div class="metric-header">
                            Trade win % <i class="fas fa-info-circle info-icon" style="color: #ccc;"><span class="tooltip">le pourcentage de trades gagnants. calcul√© en divisant le nombre de trades gagnants par le nombre total de trades.</span></i>
                        </div>
                        <div class="metric-main">
                            <div class="metric-value-medium" id="tradeWinValue">0%</div>
                            <div class="metric-bar-container">
                                <div class="metric-bar-bg">
                                    <div class="metric-bar-fill green" id="tradeWinBar" style="width: 0%;"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Profit factor -->
                    <div class="metric-item">
                        <div class="metric-header">
                            Profit factor <i class="fas fa-info-circle info-icon" style="color: #ccc;"><span class="tooltip">ratio entre les profits bruts et les pertes brutes. un profit factor > 1 signifie que vous gagnez plus que vous ne perdez. > 2 est excellent.</span></i>
                        </div>
                        <div class="metric-main">
                            <div class="metric-value-medium" id="profitFactorValue">0.00</div>
                            <div class="metric-bar-container">
                                <div class="metric-bar-bg">
                                    <div class="metric-bar-fill green" id="profitFactorBar" style="width: 0%;"></div>
                                </div>
                                <!-- Pas de compteurs pour Profit Factor -->
                            </div>
                        </div>
                    </div>

                    <!-- Day win % -->
                    <div class="metric-item">
                        <div class="metric-header">
                            Day win % <i class="fas fa-info-circle info-icon" style="color: #ccc;"><span class="tooltip">le pourcentage de journ√©es gagnantes. calcul√© en divisant le nombre de jours avec p&l positif par le nombre total de jours trad√©s.</span></i>
                        </div>
                        <div class="metric-main">
                            <div class="metric-value-medium" id="dayWinValue">0%</div>
                            <div class="metric-bar-container">
                                <div class="metric-bar-bg">
                                    <div class="metric-bar-fill green" id="dayWinBar" style="width: 0%;"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Avg win/loss trade -->
                    <div class="metric-item">
                        <div class="metric-header">
                            Avg win/loss trade <i class="fas fa-info-circle info-icon" style="color: #ccc;"><span class="tooltip">le ratio entre le gain moyen par trade gagnant et la perte moyenne par trade perdant. un ratio > 1 signifie que vos gains moyens d√©passent vos pertes moyennes.</span></i>
                        </div>
                        <div class="metric-main">
                            <div class="metric-value-medium" id="avgWinLossValue">0.00</div>
                            <div style="display: flex; justify-content: center; gap: 20px; margin-top: 8px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 16px; font-weight: 600; color: #10b981;" id="avgWinLabel">$0</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 16px; font-weight: 600; color: #ef4444;" id="avgLossLabel">-$0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Monthly Navigation and Calendar -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Calendar Section -->
                    <div class="lg:col-span-2">
                        <div class="trader-card p-6">
                            <div class="flex justify-between items-center mb-6">
                                <button onclick="previousMonth()" class="text-gray-600 hover:text-gray-800">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <div style="position: relative;">
                                    <span id="currentMonth" class="text-xl font-bold">January 2025</span>
                                    <div class="text-sm text-gray-600 mt-1">
                                        Ce mois-ci &nbsp;&nbsp;&nbsp; Stats mensuelles: <span id="monthlyPnl" class="font-semibold">$0.00</span> &nbsp; <span id="monthlyDays">0 jours</span> &nbsp; 
                                        <button onclick="updateCalendar(); console.log('üîÑ Calendrier manuellement rafra√Æchi');" class="text-blue-600 hover:text-blue-800" title="Rafra√Æchir le calendrier">
                                            <i class="fas fa-sync-alt"></i>
                                        </button>
                                        <button onclick="toggleCalendarSettings()" class="text-gray-600 hover:text-gray-800" title="Param√®tres d'affichage">
                                            <i class="fas fa-cog"></i>
                                        </button>
                                    </div>
                                    
                                    <!-- Menu des param√®tres d'affichage -->
                                    <div id="calendarSettings" style="display: none;" class="absolute right-0 mt-2 bg-white rounded-lg shadow-lg border border-gray-200 p-4 z-50" style="min-width: 250px;">
                                        <h4 class="font-bold text-gray-700 mb-3">Affichage du calendrier</h4>
                                        <div class="space-y-2">
                                            <label class="flex items-center cursor-pointer hover:bg-gray-50 p-2 rounded">
                                                <input type="checkbox" id="showPnl" checked onchange="updateCalendarDisplay()" class="mr-2">
                                                <span class="text-sm">P&L par jour</span>
                                            </label>
                                            <label class="flex items-center cursor-pointer hover:bg-gray-50 p-2 rounded">
                                                <input type="checkbox" id="showTradeCount" onchange="updateCalendarDisplay()" class="mr-2">
                                                <span class="text-sm">Nombre de trades</span>
                                            </label>
                                            <label class="flex items-center cursor-pointer hover:bg-gray-50 p-2 rounded">
                                                <input type="checkbox" id="showWinRate" onchange="updateCalendarDisplay()" class="mr-2">
                                                <span class="text-sm">Win rate %</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <button onclick="nextMonth()" class="text-gray-600 hover:text-gray-800">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>

                            <div class="grid grid-cols-7 gap-2 mb-4">
                                <div class="text-center font-semibold text-gray-600 py-2">Dim</div>
                                <div class="text-center font-semibold text-gray-600 py-2">Lun</div>
                                <div class="text-center font-semibold text-gray-600 py-2">Mar</div>
                                <div class="text-center font-semibold text-gray-600 py-2">Mer</div>
                                <div class="text-center font-semibold text-gray-600 py-2">Jeu</div>
                                <div class="text-center font-semibold text-gray-600 py-2">Ven</div>
                                <div class="text-center font-semibold text-gray-600 py-2">Sam</div>
                            </div>

                            <div id="calendarGrid" class="grid grid-cols-7 gap-2">
                                <!-- Calendar will be populated by JavaScript -->
                            </div>

                            <!-- Weekly Performance Summary -->
                            <div class="mt-6 space-y-3" id="weeklyStatsContainer">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Semaine 1</span>
                                    <div class="text-right">
                                        <div class="text-lg font-bold" id="week1Pnl">$0.00</div>
                                        <div class="text-xs text-gray-500" id="week1Days">0 jour</div>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Semaine 2</span>
                                    <div class="text-right">
                                        <div class="text-lg font-bold" id="week2Pnl">$0.00</div>
                                        <div class="text-xs text-gray-500" id="week2Days">0 jour</div>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Semaine 3</span>
                                    <div class="text-right">
                                        <div class="text-lg font-bold" id="week3Pnl">$0.00</div>
                                        <div class="text-xs text-gray-500" id="week3Days">0 jour</div>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Semaine 4</span>
                                    <div class="text-right">
                                        <div class="text-lg font-bold" id="week4Pnl">$0.00</div>
                                        <div class="text-xs text-gray-500" id="week4Days">0 jour</div>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600">Semaine 5</span>
                                    <div class="text-right">
                                        <div class="text-lg font-bold" id="week5Pnl">$0.00</div>
                                        <div class="text-xs text-gray-500" id="week5Days">0 jour</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Sidebar -->
                    <div class="space-y-6">
                        <!-- Recent Trades Module -->
                        <div class="trader-card p-4">
                            <div class="flex border-b border-gray-200 mb-4">
                                <button class="px-4 py-2 text-sm font-semibold text-purple-600 border-b-2 border-purple-600">Trades r√©cents</button>
                                <button class="px-4 py-2 text-sm text-gray-600 cursor-not-allowed opacity-50" disabled title="Non disponible">Positions ouvertes</button>
                            </div>
                            <div id="recentTradesContainer" class="space-y-3">
                                <!-- Les trades r√©cents seront ins√©r√©s ici dynamiquement -->
                                <div class="text-center text-gray-500 py-8">
                                    <i class="fas fa-inbox text-4xl mb-2"></i>
                                    <p>Aucun trade r√©cent</p>
                                </div>
                            </div>
                        </div>
                    
                        <!-- Protection Analysis Module -->
                        <div class="trader-card p-4 mt-6">
                            <h3 class="text-lg font-semibold mb-4 flex items-center">
                                <i class="fas fa-shield-alt text-purple-600 mr-2"></i>
                                Analyse des Protections
                            </h3>
                            <div id="protectionAnalysisContainer" class="space-y-3">
                                <!-- Les analyses de protections seront ins√©r√©es ici -->
                                <div class="text-center text-gray-500 py-6">
                                    <i class="fas fa-chart-bar text-3xl mb-2"></i>
                                    <p class="text-sm">Aucune donn√©e disponible</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mt-8">
                    <!-- Trader 360 Score -->
                    <div class="trader-card p-6">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            Trader 360 Score <i class="fas fa-info-circle info-icon text-gray-400 ml-2"><span class="tooltip">score global √©valuant votre performance de trading sur plusieurs crit√®res : win rate, profit factor, consistency, et gestion du risque.</span></i>
                        </h3>
                        <div class="chart-container" style="height: 250px;">
                            <canvas id="traderScoreChart"></canvas>
                        </div>
                        <div class="mt-4 text-center">
                            <div class="text-sm text-gray-600">Your Trader 360 Score</div>
                            <div class="text-3xl font-bold text-orange-500" id="traderScore">75.2</div>
                            <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                                <div class="bg-gradient-to-r from-red-500 via-yellow-500 to-green-500 h-2 rounded-full" style="width: 75.2%"></div>
                            </div>
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>0</span>
                                <span>20</span>
                                <span>40</span>
                                <span>60</span>
                                <span>80</span>
                                <span>100</span>
                            </div>
                        </div>
                    </div>

                    <!-- Trade Time Performance -->
                    <div class="trader-card p-6">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            Performance par heure <i class="fas fa-info-circle info-icon text-gray-400 ml-2"><span class="tooltip">analyse de vos performances par heure de trading. identifiez les heures o√π vous √™tes le plus performant.</span></i>
                        </h3>
                        <div class="chart-container">
                            <canvas id="tradeTimeChart"></canvas>
                        </div>
                    </div>

                    <!-- Net Daily P&L -->
                    <div class="trader-card p-6">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            P&L quotidien net <i class="fas fa-info-circle info-icon text-gray-400 ml-2"><span class="tooltip">graphique montrant votre profit/perte net par jour. visualisez vos jours gagnants (vert) et perdants (rouge).</span></i>
                        </h3>
                        <div class="chart-container">
                            <canvas id="dailyPnlChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Bottom Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mt-8">
                    <!-- Daily Cumulative P&L -->
                    <div class="trader-card p-6">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            P&L cumul√© net quotidien <i class="fas fa-info-circle info-icon text-gray-400 ml-2"><span class="tooltip">courbe de votre p&l cumul√© au fil du temps. une courbe ascendante indique une croissance constante de votre capital.</span></i>
                        </h3>
                        <div class="chart-container">
                            <canvas id="cumulativePnlChart"></canvas>
                        </div>
                    </div>

                    <!-- Drawdown -->
                    <div class="trader-card p-6">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            Drawdown <i class="fas fa-info-circle info-icon text-gray-400 ml-2"><span class="tooltip">le drawdown mesure la baisse maximale de votre capital depuis un pic. un drawdown √©lev√© indique un risque important.</span></i>
                        </h3>
                        <div class="chart-container">
                            <canvas id="drawdownChart"></canvas>
                        </div>
                    </div>

                    <!-- Trade Duration Performance -->
                    <div class="trader-card p-6">
                        <h3 class="text-lg font-semibold mb-4 flex items-center">
                            Performance par dur√©e de trade <i class="fas fa-info-circle text-gray-400 ml-2"></i>
                        </h3>
                        <div class="chart-container">
                            <canvas id="durationChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section Journal des Trades -->
            <div id="tradelog" class="section hidden">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800 mb-2">Journal des Trades</h1>
                        <p class="text-gray-600">G√©rez vos positions SP500</p>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="showImportCSVModal()" class="trader-btn-secondary">
                            <i class="fas fa-file-csv mr-2"></i>Importer CSV
                        </button>
                        <button onclick="showAddTradeModal()" class="trader-btn">
                            <i class="fas fa-plus mr-2"></i>Ajouter un Trade
                        </button>
                    </div>
                </div>

                <div class="trader-card">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Compte</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Symbole</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Entr√©e</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sortie</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Quantit√©</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">P&L</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Setup</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tradesTableBody">
                                <tr>
                                    <td colspan="10" class="px-6 py-4 text-center text-gray-500">
                                        Aucun trade enregistr√©. Cliquez sur "Ajouter un Trade" pour commencer.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Section Journal Quotidien -->
            <div id="dailyjournal" class="section hidden">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800 mb-2">Journal Quotidien</h1>
                        <p class="text-gray-600">Notez vos observations et analyses</p>
                    </div>
                    <button onclick="showAddNoteModal()" class="trader-btn">
                        <i class="fas fa-plus mr-2"></i>Ajouter une Note
                    </button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2">
                        <div class="trader-card p-6">
                            <h3 class="text-lg font-semibold mb-4">Entr√©es R√©centes</h3>
                            <div id="journalEntries">
                                <p class="text-gray-500 text-center py-8">Aucune note ajout√©e. Commencez par ajouter une entr√©e.</p>
                            </div>
                        </div>
                    </div>
                    <div>
                        <div class="trader-card p-6">
                            <h3 class="text-lg font-semibold mb-4">Statistiques du Journal</h3>
                            <div class="space-y-4">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Total entr√©es:</span>
                                    <span class="font-semibold" id="totalEntries">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Cette semaine:</span>
                                    <span class="font-semibold" id="weeklyEntries">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Avec images:</span>
                                    <span class="font-semibold" id="entriesWithImages">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Other Sections (Placeholders) -->
            <div id="playbook" class="section hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-4">Playbook</h1>
                <div class="trader-card p-8 text-center">
                    <i class="fas fa-play text-6xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500">Section Playbook en d√©veloppement...</p>
                </div>
            </div>

            <div id="calendar" class="section hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-4">Calendrier</h1>
                <div class="trader-card p-8 text-center">
                    <i class="fas fa-calendar text-6xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500">Section Calendar en d√©veloppement...</p>
                </div>
            </div>

            <div id="insights" class="section hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-4">Insights</h1>
                <div class="trader-card p-8 text-center">
                    <i class="fas fa-lightbulb text-6xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500">Section Insights en d√©veloppement...</p>
                </div>
            </div>

            <!-- Section Comptabilit√© / Payouts -->
            <div id="accounting" class="section hidden">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">Comptabilit√© & Payouts</h1>
                    <div class="flex gap-3">
                        <button onclick="showAddAccountCostModal()" class="trader-btn">
                            <i class="fas fa-credit-card mr-2"></i>Ajouter un compte achet√©
                        </button>
                        <button onclick="showAddPayoutModal()" class="trader-btn" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                            <i class="fas fa-money-bill-wave mr-2"></i>Ajouter un payout
                        </button>
                    </div>
                </div>

                <!-- KPIs Comptabilit√© -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div class="trader-card p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm mb-1">Total Investi</p>
                                <p class="text-2xl font-bold" id="totalInvested" style="color: #dc2626;">$0.00</p>
                            </div>
                            <div class="w-12 h-12 rounded-full flex items-center justify-center" style="background-color: rgba(220, 38, 38, 0.1);">
                                <i class="fas fa-arrow-down" style="color: #dc2626;"></i>
                            </div>
                        </div>
                    </div>

                    <div class="trader-card p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm mb-1">Total Payouts</p>
                                <p class="text-2xl font-bold" id="totalPayouts" style="color: #10b981;">$0.00</p>
                            </div>
                            <div class="w-12 h-12 rounded-full flex items-center justify-center" style="background-color: rgba(16, 185, 129, 0.1);">
                                <i class="fas fa-arrow-up" style="color: #10b981;"></i>
                            </div>
                        </div>
                    </div>

                    <div class="trader-card p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm mb-1">B√©n√©fice Net</p>
                                <p class="text-2xl font-bold" id="netProfit">$0.00</p>
                            </div>
                            <div class="w-12 h-12 rounded-full flex items-center justify-center" id="netProfitIcon">
                                <i class="fas fa-equals"></i>
                            </div>
                        </div>
                    </div>

                    <div class="trader-card p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm mb-1">ROI</p>
                                <p class="text-2xl font-bold" id="roi">0%</p>
                            </div>
                            <div class="w-12 h-12 rounded-full flex items-center justify-center" style="background-color: rgba(172, 134, 43, 0.1);">
                                <i class="fas fa-percent" style="color: #ac862b;"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Graphique √©volution -->
                <div class="trader-card p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800">
                        <i class="fas fa-chart-line mr-2" style="color: #ac862b;"></i>
                        √âvolution Comptable
                    </h3>
                    <canvas id="accountingChart" height="80"></canvas>
                </div>

                <!-- Tableaux -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Comptes achet√©s -->
                    <div class="trader-card p-6">
                        <h3 class="text-lg font-semibold mb-4 text-gray-800">
                            <i class="fas fa-credit-card mr-2" style="color: #dc2626;"></i>
                            Comptes Achet√©s
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b">
                                        <th class="text-left py-3 px-2 text-sm font-semibold text-gray-700">Date</th>
                                        <th class="text-left py-3 px-2 text-sm font-semibold text-gray-700">Compte</th>
                                        <th class="text-right py-3 px-2 text-sm font-semibold text-gray-700">Co√ªt</th>
                                        <th class="text-center py-3 px-2 text-sm font-semibold text-gray-700">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="accountCostsTable">
                                    <tr>
                                        <td colspan="4" class="text-center py-8 text-gray-500">
                                            <i class="fas fa-inbox text-4xl mb-2 opacity-30"></i>
                                            <p>Aucun compte enregistr√©</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Payouts re√ßus -->
                    <div class="trader-card p-6">
                        <h3 class="text-lg font-semibold mb-4 text-gray-800">
                            <i class="fas fa-money-bill-wave mr-2" style="color: #10b981;"></i>
                            Payouts Re√ßus
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b">
                                        <th class="text-left py-3 px-2 text-sm font-semibold text-gray-700">Date</th>
                                        <th class="text-left py-3 px-2 text-sm font-semibold text-gray-700">Compte</th>
                                        <th class="text-right py-3 px-2 text-sm font-semibold text-gray-700">Montant</th>
                                        <th class="text-center py-3 px-2 text-sm font-semibold text-gray-700">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="payoutsTable">
                                    <tr>
                                        <td colspan="4" class="text-center py-8 text-gray-500">
                                            <i class="fas fa-inbox text-4xl mb-2 opacity-30"></i>
                                            <p>Aucun payout enregistr√©</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Account Modal -->
    <div id="addAccountModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addAccountModal')">&times;</span>
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Ajouter un Compte</h2>
            
            <form id="accountForm">
                <div class="form-group">
                    <label>Nom du compte</label>
                    <input type="text" id="accountName" placeholder="Ex: Compte 100K" required>
                </div>
                <div class="form-group">
                    <label>Taille du compte</label>
                    <input type="text" id="accountSize" placeholder="Ex: 100000 ou 100K" required>
                </div>
                
                <div class="flex gap-4 mt-6">
                    <button type="button" onclick="addAccount()" class="trader-btn flex-1">Ajouter</button>
                    <button type="button" onclick="closeModal('addAccountModal')" class="trader-btn-secondary flex-1">Annuler</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Trade Modal -->
    <div id="addTradeModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addTradeModal')">&times;</span>
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Ajouter un Trade SP500</h2>
            
            <form id="tradeForm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group">
                        <label>Compte</label>
                        <select id="tradeAccount" required>
                            <option value="">S√©lectionner un compte...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="tradeDate" required>
                    </div>
                    <div class="form-group">
                        <label>Heure d'entr√©e</label>
                        <input type="time" id="entryTime" required>
                    </div>
                    <div class="form-group">
                        <label>Heure de sortie</label>
                        <input type="time" id="exitTime" required>
                    </div>
                    <div class="form-group">
                        <label>Symbole</label>
                        <select id="symbol" required onchange="toggleManualPnL()">
                            <option value="ES">ES (E-mini S&P 500 - $50/point)</option>
                            <option value="MES">MES (Micro E-mini S&P 500 - $5/point)</option>
                            <option value="DEMO">DEMO (Saisie manuelle du P&L)</option>
                        </select>
                    </div>
                    <div class="form-group" id="manualPnLGroup" style="display: none;">
                        <label>P&L Manuel ($) <span style="color: #ac862b;">*</span></label>
                        <input type="number" step="0.01" id="manualPnL" placeholder="Ex: 150.00 ou -75.50">
                        <small style="color: #666; font-size: 0.85em; display: block; margin-top: 4px;">üí° Entrez le montant gagn√© (positif) ou perdu (n√©gatif)</small>
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="tradeType" required>
                            <option value="">S√©lectionner...</option>
                            <option value="Long">Long</option>
                            <option value="Short">Short</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Prix d'entr√©e</label>
                        <input type="number" step="0.01" id="entryPrice" required>
                    </div>
                    <div class="form-group">
                        <label>Prix de sortie</label>
                        <input type="number" step="0.01" id="exitPrice" required>
                    </div>
                    <div class="form-group">
                        <label>Quantit√© (contrats)</label>
                        <input type="number" min="1" id="quantity" required>
                    </div>
                    <div class="form-group">
                        <label>Stop Loss</label>
                        <input type="number" step="0.01" id="stopLoss">
                    </div>
                    <div class="form-group">
                        <label>Take Profit</label>
                        <input type="number" step="0.01" id="takeProfit">
                    </div>
                    <div class="form-group">
                        <label>Setup</label>
                        <select id="setup" required>
                            <option value="">S√©lectionner...</option>
                            <option value="Breakout">Breakout</option>
                            <option value="Pullback">Pullback</option>
                            <option value="Reversal">Reversal</option>
                            <option value="Range Trading">Range Trading</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Notes du trade</label>
                    <textarea id="tradeNotes" rows="4" placeholder="D√©crivez votre analyse, votre plan de trade, vos observations..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>Protections utilis√©es (s√©lection multiple)</label>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 8px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="protectionVWAP" value="VWAP" style="width: 18px; height: 18px; accent-color: #ac862b;">
                            <span>VWAP</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="protectionMM20" value="MM20" style="width: 18px; height: 18px; accent-color: #ac862b;">
                            <span>MM20</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="protectionPivot" value="Pivot" style="width: 18px; height: 18px; accent-color: #ac862b;">
                            <span>Pivot</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="protectionClotureVeille" value="Cl√¥ture veille" style="width: 18px; height: 18px; accent-color: #ac862b;">
                            <span>Cl√¥ture veille</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="protectionLiquidite" value="Liquidit√© 30m/H1/H4" style="width: 18px; height: 18px; accent-color: #ac862b;">
                            <span>Liquidit√© 30m/H1/H4</span>
                        </label>
                    </div>
                </div>
                
                <div class="flex gap-4 mt-6">
                    <button type="button" onclick="addTrade()" class="trader-btn flex-1">Ajouter le Trade</button>
                    <button type="button" onclick="closeModal('addTradeModal')" class="trader-btn-secondary flex-1">Annuler</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Note Modal -->
    <div id="addNoteModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addNoteModal')">&times;</span>
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Ajouter une Note Quotidienne</h2>
            
            <form id="noteForm">
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="noteDate" required>
                </div>
                
                <div class="form-group">
                    <label>Note/Observation</label>
                    <textarea id="noteText" rows="6" placeholder="D√©crivez votre journ√©e de trading, vos observations, vos erreurs, vos succ√®s..." required></textarea>
                </div>
                
                <div class="form-group">
                    <label>√âmotion avant trading</label>
                    <select id="emotionBefore">
                        <option value="">S√©lectionner...</option>
                        <option value="Confiant">Confiant</option>
                        <option value="Nerveux">Nerveux</option>
                        <option value="Calme">Calme</option>
                        <option value="Excit√©">Excit√©</option>
                        <option value="Inquiet">Inquiet</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>√âmotion apr√®s trading</label>
                    <select id="emotionAfter">
                        <option value="">S√©lectionner...</option>
                        <option value="Satisfait">Satisfait</option>
                        <option value="Frustr√©">Frustr√©</option>
                        <option value="D√©√ßu">D√©√ßu</option>
                        <option value="Euphorique">Euphorique</option>
                        <option value="Neutre">Neutre</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>√âvaluation de la session</label>
                    <div class="flex gap-2">
                        <button type="button" class="star-rating" data-rating="1">‚≠ê</button>
                        <button type="button" class="star-rating" data-rating="2">‚≠ê</button>
                        <button type="button" class="star-rating" data-rating="3">‚≠ê</button>
                        <button type="button" class="star-rating" data-rating="4">‚≠ê</button>
                        <button type="button" class="star-rating" data-rating="5">‚≠ê</button>
                    </div>
                    <input type="hidden" id="sessionRating" value="0">
                </div>
                
                <div class="form-group">
                    <label>üì∑ Ajouter une image (plan de trading, screenshot...)</label>
                    <input type="file" id="noteImage" accept="image/*" onchange="previewImage(this)">
                    <div id="imagePreview" class="mt-4 hidden">
                        <img id="previewImg" src="" alt="Preview" class="max-w-full h-48 object-contain border rounded">
                        <button type="button" onclick="removeImage()" class="mt-2 text-red-500 text-sm">Supprimer l'image</button>
                    </div>
                </div>
                
                <div class="flex gap-4 mt-6">
                    <button type="button" onclick="addNote()" class="trader-btn flex-1">Ajouter la Note</button>
                    <button type="button" onclick="closeModal('addNoteModal')" class="trader-btn-secondary flex-1">Annuler</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Account Cost Modal -->
    <div id="addAccountCostModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addAccountCostModal')">&times;</span>
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Ajouter un Compte Achet√©</h2>
            
            <form id="accountCostForm">
                <div class="form-group">
                    <label>Date d'achat</label>
                    <input type="date" id="accountCostDate" required>
                </div>
                
                <div class="form-group">
                    <label>Nom du compte / Prop Firm</label>
                    <input type="text" id="accountCostName" placeholder="Ex: Tradeday 150K, FTMO 100K..." required>
                </div>
                
                <div class="form-group">
                    <label>Co√ªt ($)</label>
                    <input type="number" step="0.01" id="accountCostAmount" placeholder="Ex: 450.00" required>
                </div>
                
                <div class="form-group">
                    <label>Notes (optionnel)</label>
                    <textarea id="accountCostNotes" rows="3" placeholder="D√©tails sur le compte, challenge, objectifs..."></textarea>
                </div>
                
                <div class="flex gap-4 mt-6">
                    <button type="button" onclick="addAccountCost()" class="trader-btn flex-1">Ajouter</button>
                    <button type="button" onclick="closeModal('addAccountCostModal')" class="trader-btn-secondary flex-1">Annuler</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Payout Modal -->
    <div id="addPayoutModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addPayoutModal')">&times;</span>
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Ajouter un Payout</h2>
            
            <form id="payoutForm">
                <div class="form-group">
                    <label>Date du payout</label>
                    <input type="date" id="payoutDate" required>
                </div>
                
                <div class="form-group">
                    <label>Compte source</label>
                    <input type="text" id="payoutAccount" placeholder="Ex: Tradeday 150K" required>
                </div>
                
                <div class="form-group">
                    <label>Montant ($)</label>
                    <input type="number" step="0.01" id="payoutAmount" placeholder="Ex: 1500.00" required>
                </div>
                
                <div class="form-group">
                    <label>Notes (optionnel)</label>
                    <textarea id="payoutNotes" rows="3" placeholder="D√©tails sur le payout, d√©lai de traitement..."></textarea>
                </div>
                
                <div class="flex gap-4 mt-6">
                    <button type="button" onclick="addPayout()" class="trader-btn flex-1" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">Ajouter</button>
                    <button type="button" onclick="closeModal('addPayoutModal')" class="trader-btn-secondary flex-1">Annuler</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Import CSV Modal -->
    <div id="importCSVModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="close" onclick="closeModal('importCSVModal')">&times;</span>
            <h2 class="text-2xl font-bold mb-6 text-gray-800">
                <i class="fas fa-file-csv mr-2" style="color: #ac862b;"></i>
                Importer des trades depuis CSV
            </h2>
            
            <!-- √âtape 1: Upload fichier -->
            <div id="csvUploadStep">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <div class="flex items-start">
                        <i class="fas fa-info-circle text-blue-500 mt-1 mr-3"></i>
                        <div>
                            <h3 class="font-semibold text-blue-900 mb-2">Format CSV attendu</h3>
                            <p class="text-sm text-blue-800 mb-2">Votre fichier CSV doit contenir au minimum ces colonnes :</p>
                            <ul class="text-sm text-blue-800 list-disc list-inside space-y-1">
                                <li><strong>Date</strong> (format: JJ/MM/AAAA ou AAAA-MM-JJ)</li>
                                <li><strong>Symbole</strong> (ES, MES, ou autre)</li>
                                <li><strong>Type</strong> (Long/Short ou Buy/Sell)</li>
                                <li><strong>Prix d'entr√©e</strong> (Entry Price)</li>
                                <li><strong>Prix de sortie</strong> (Exit Price)</li>
                                <li><strong>Quantit√©</strong> (Quantity/Contracts)</li>
                                <li><strong>P&L</strong> (optionnel si ES/MES, obligatoire si DEMO)</li>
                            </ul>
                            <p class="text-sm text-blue-800 mt-2"><strong>Note :</strong> Les noms des colonnes seront d√©tect√©s automatiquement</p>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>S√©lectionner le compte de destination</label>
                    <select id="csvTargetAccount" required>
                        <option value="">Choisir un compte...</option>
                    </select>
                </div>

                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-gold transition-colors cursor-pointer" onclick="document.getElementById('csvFileInput').click()">
                    <i class="fas fa-cloud-upload-alt text-6xl text-gray-400 mb-4"></i>
                    <p class="text-gray-600 mb-2">Cliquez pour s√©lectionner un fichier CSV</p>
                    <p class="text-sm text-gray-500">ou glissez-d√©posez le fichier ici</p>
                    <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleCSVUpload(event)">
                </div>

                <div id="csvFileName" class="mt-4 text-center text-gray-600" style="display: none;">
                    <i class="fas fa-file-csv mr-2"></i>
                    <span id="csvFileNameText"></span>
                </div>
            </div>

            <!-- √âtape 2: Pr√©visualisation et validation -->
            <div id="csvPreviewStep" style="display: none;">
                <div class="mb-4">
                    <h3 class="text-lg font-semibold mb-2">
                        <i class="fas fa-eye mr-2" style="color: #ac862b;"></i>
                        Pr√©visualisation des trades (√† importer: <span id="csvTradeCount">0</span>)
                    </h3>
                    <p class="text-sm text-gray-600">V√©rifiez les donn√©es avant l'import. Vous pourrez modifier chaque trade apr√®s validation.</p>
                </div>

                <div class="overflow-x-auto max-h-96 overflow-y-auto border rounded-lg">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Symbole</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Entr√©e</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Sortie</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Qty</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">P&L</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Statut</th>
                            </tr>
                        </thead>
                        <tbody id="csvPreviewTable">
                        </tbody>
                    </table>
                </div>

                <div class="flex gap-4 mt-6">
                    <button type="button" onclick="cancelCSVImport()" class="trader-btn-secondary flex-1">
                        <i class="fas fa-times mr-2"></i>Annuler
                    </button>
                    <button type="button" onclick="confirmCSVImport()" class="trader-btn flex-1">
                        <i class="fas fa-check mr-2"></i>Importer <span id="csvImportCount">0</span> trade(s)
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bouton de rafra√Æchissement global -->
    <button class="refresh-btn" onclick="refreshAllModules()" title="Rafra√Æchir tous les modules">
        <i class="fas fa-sync-alt"></i>
    </button>

    <script>
        // Global variables
        let currentUser = null;
        let allUsers = []; // Tous les utilisateurs (√©l√®ves + coach)
        let trades = [];
        let journalEntries = [];
        let accounts = [];
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let traderScoreChart = null;
        let tradeTimeChart = null;
        let dailyPnlChart = null;
        let cumulativePnlChart = null;
        
        // Param√®tres d'affichage du calendrier
        let calendarDisplay = {
            showPnl: true,
            showTradeCount: false,
            showWinRate: false
        };
        let drawdownChart = null;
        let durationChart = null;
        let accountingChart = null;
        
        // Variables comptabilit√©
        let accountCosts = [];
        let payouts = [];
        
        // Variables import CSV
        let csvParsedTrades = [];

        // FONCTION HELPER: Obtenir les trades filtr√©s par compte
        function getFilteredTrades() {
            // Si aucun compte n'existe, retourner tous les trades
            if (accounts.length === 0) {
                return trades;
            }
            // Sinon, filtrer par comptes actifs
            const activeAccountIds = accounts.filter(a => a.active).map(a => a.id);
            return trades.filter(t => activeAccountIds.includes(t.accountId));
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadFromStorage();
            setCurrentDate();
            setupStarRatings();
            initializeDefaultAccounts();
            loadCalendarPreferences(); // Charger les pr√©f√©rences d'affichage
            
            // Initialiser les graphiques et mettre √† jour tout
            initCharts();
            updateDashboard();
            updateBanner();
            updateCharts();
            updateCalendar();
            updateRecentTrades();
            updateProtectionAnalysis();
            
            console.log('‚úÖ Application charg√©e - Trades:', trades.length);
        });

        function initializeDefaultAccounts() {
            if (accounts.length === 0) {
                accounts = [
                    { id: 1, name: 'Compte 50K', size: '50000', active: true, color: '#ef4444' },
                    { id: 2, name: 'Compte 150K', size: '150000', active: true, color: '#22c55e' }
                ];
                saveToStorage();
            }
            updateAccountsList();
        }

        function setCurrentDate() {
            const today = new Date().toISOString().split('T')[0];
            const dateInputs = document.querySelectorAll('input[type="date"]');
            dateInputs.forEach(input => {
                if (!input.value) input.value = today;
            });
        }

        function setupStarRatings() {
            document.querySelectorAll('.star-rating').forEach(star => {
                star.addEventListener('click', function() {
                    const rating = parseInt(this.getAttribute('data-rating'));
                    document.getElementById('sessionRating').value = rating;
                    
                    document.querySelectorAll('.star-rating').forEach((s, index) => {
                        if (index < rating) {
                            s.style.opacity = '1';
                            s.style.color = '#FFD700';
                        } else {
                            s.style.opacity = '0.3';
                            s.style.color = '#ccc';
                        }
                    });
                });
            });
        }

        // Account Management
        function updateAccountsList() {
            const container = document.getElementById('accountsList');
            const tradeAccountSelect = document.getElementById('tradeAccount');
            
            container.innerHTML = accounts.map(account => `
                <div class="account-item">
                    <input type="checkbox" class="account-checkbox" ${account.active ? 'checked' : ''} 
                           onchange="toggleAccount(${account.id})">
                    <div class="account-info">
                        <div class="account-name">${account.name}</div>
                        <div class="account-size">${formatAccountSize(account.size)}</div>
                    </div>
                    <div class="account-indicator" style="background-color: ${account.color}"></div>
                    <button onclick="deleteAccount(${account.id})" class="account-delete-btn" title="Supprimer le compte et tous ses trades">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');

            if (tradeAccountSelect) {
                tradeAccountSelect.innerHTML = '<option value="">S√©lectionner un compte...</option>' +
                    accounts.map(account => `<option value="${account.id}">${account.name}</option>`).join('');
            }
        }

        function formatAccountSize(size) {
            const num = parseInt(size);
            if (num >= 1000000) return (num / 1000000) + 'M';
            if (num >= 1000) return (num / 1000) + 'K';
            return num.toString();
        }

        function toggleAccount(accountId) {
            const account = accounts.find(a => a.id === accountId);
            if (account) {
                account.active = !account.active;
                saveToStorage();
                updateDashboard();
                updateBanner(); // Mise √† jour des barres visuelles
                updateCharts();
                updateCalendar(); // Mise √† jour du calendrier (inclut updateWeeklyStats)
            }
        }

        function showAddAccountModal() {
            document.getElementById('addAccountModal').style.display = 'block';
        }

        function addAccount_DISABLED() { return; // D√âSACTIV√â - Voir supabase-trades.js
            const name = document.getElementById('accountName').value.trim();
            const size = document.getElementById('accountSize').value.trim();

            if (!name || !size) {
                alert('Veuillez remplir tous les champs');
                return;
            }

            const colors = ['#3b82f6', '#8b5cf6', '#f59e0b', '#06b6d4', '#84cc16', '#f97316'];
            
            // G√©n√©rer un ID s√©curis√©
            const maxId = accounts.length > 0 ? Math.max(...accounts.map(a => a.id)) : 0;
            const newAccount = {
                id: maxId + 1,
                name: name,
                size: size.replace(/[^0-9]/g, ''),
                active: true,
                color: colors[accounts.length % colors.length]
            };

            console.log('üÜï DEBUG addAccount - Nouveau compte cr√©√©:', newAccount);
            
            accounts.push(newAccount);
            console.log('üÜï Comptes apr√®s ajout:', accounts.map(a => ({ id: a.id, name: a.name })));
            
            saveToStorage();
            updateAccountsList();
            
            // Mettre √† jour le select dans le modal addTradeModal s'il est ouvert
            const tradeAccountSelect = document.getElementById('tradeAccount');
            console.log('üÜï Select trouv√©:', tradeAccountSelect ? 'OUI' : 'NON');
            
            if (tradeAccountSelect) {
                tradeAccountSelect.innerHTML = '<option value="">S√©lectionner un compte...</option>' +
                    accounts.map(account => `<option value="${account.id}">${account.name}</option>`).join('');
                
                console.log('üÜï HTML du select mis √† jour:', tradeAccountSelect.innerHTML);
                
                // S√©lectionner automatiquement le nouveau compte
                tradeAccountSelect.value = newAccount.id;
                console.log('üÜï Valeur du select apr√®s s√©lection:', tradeAccountSelect.value);
            } else {
                console.error('‚ùå Select #tradeAccount NOT FOUND!');
            }
            
            closeModal('addAccountModal');
            
            // Attendre que le modal soit ferm√©, puis remettre √† jour le select
            setTimeout(() => {
                const tradeAccountSelect2 = document.getElementById('tradeAccount');
                if (tradeAccountSelect2) {
                    console.log('üîÑ Mise √† jour FINALE du select apr√®s fermeture modal');
                    tradeAccountSelect2.innerHTML = '<option value="">S√©lectionner un compte...</option>' +
                        accounts.map(account => `<option value="${account.id}">${account.name}</option>`).join('');
                    tradeAccountSelect2.value = newAccount.id;
                    console.log('üîÑ Valeur finale du select:', tradeAccountSelect2.value);
                }
            }, 100);
            
            // Notification de succ√®s
            alert(`‚úÖ Compte "${newAccount.name}" cr√©√© avec succ√®s !\n\nVous pouvez maintenant l'utiliser pour vos trades.`);
        }

        function deleteAccount_DISABLED(accountId) { return; // D√âSACTIV√â - Voir supabase-trades.js
            const account = accounts.find(a => a.id === accountId);
            if (!account) {
                alert('Compte non trouv√©');
                return;
            }
            
            // Compter le nombre de trades associ√©s √† ce compte
            const associatedTrades = trades.filter(t => t.accountId === accountId);
            const tradesCount = associatedTrades.length;
            
            // Message de confirmation d√©taill√©
            const confirmMessage = tradesCount > 0 
                ? `‚ö†Ô∏è ATTENTION !‚ö†Ô∏è\n\n√ätes-vous s√ªr de vouloir supprimer le compte "${account.name}" ?\n\nCette action supprimera √©galement ${tradesCount} trade(s) associ√©(s) √† ce compte.\n\nCette action est IRR√âVERSIBLE !`
                : `√ätes-vous s√ªr de vouloir supprimer le compte "${account.name}" ?`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Supprimer tous les trades associ√©s √† ce compte
            const initialTradesCount = trades.length;
            trades = trades.filter(t => t.accountId !== accountId);
            const deletedTradesCount = initialTradesCount - trades.length;
            
            // Supprimer le compte
            accounts = accounts.filter(a => a.id !== accountId);
            
            // Supprimer les co√ªts associ√©s au compte
            accountCosts = accountCosts.filter(c => c.accountId !== accountId);
            
            // Supprimer les payouts associ√©s au compte
            payouts = payouts.filter(p => p.accountId !== accountId);
            
            console.log(`üóëÔ∏è Compte supprim√©: ${account.name}`);
            console.log(`üóëÔ∏è ${deletedTradesCount} trade(s) supprim√©(s)`);
            
            // Sauvegarder et rafra√Æchir
            saveToStorage();
            updateAccountsList();
            refreshAllModules();
            
            // Notification de succ√®s
            const successMessage = deletedTradesCount > 0
                ? `‚úÖ Compte "${account.name}" et ${deletedTradesCount} trade(s) supprim√©(s) avec succ√®s`
                : `‚úÖ Compte "${account.name}" supprim√© avec succ√®s`;
            
            alert(successMessage);
        }

        // Auth functions
        function showLoginForm() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('coachLoginForm').style.display = 'none';
            clearErrors();
        }

        function showRegisterForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            document.getElementById('coachLoginForm').style.display = 'none';
            clearErrors();
        }

        function showCoachLogin() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('coachLoginForm').style.display = 'block';
            clearErrors();
        }

        function clearErrors() {
            document.querySelectorAll('[id$="Error"]').forEach(el => {
                el.classList.add('hidden');
                el.textContent = '';
            });
        }

        function showError(elementId, message) {
            const errorEl = document.getElementById(elementId);
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
        }

        // register() d√©plac√© vers supabase-auth.js

        // login() d√©plac√© vers supabase-auth.js

        // coachLogin() d√©plac√© vers supabase-auth.js

        function logout() {
            currentUser = null;
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            
            document.querySelectorAll('input[type="email"], input[type="password"]').forEach(input => {
                input.value = '';
            });
            
            showLoginForm();
        }

        function showMainApp() {
            document.getElementById('authScreen').style.display = 'none';
            
            // V√©rifier si c'est le coach ou un √©l√®ve
            if (currentUser.role === 'coach') {
                // Afficher l'interface Coach
                document.getElementById('mainApp').style.display = 'none';
                document.getElementById('coachApp').style.display = 'flex';
                document.getElementById('coachUserInfo').textContent = currentUser.email;
                
                // Charger les donn√©es pour le dashboard coach
                loadCoachDashboard();
            } else {
                // Afficher l'interface √âl√®ve (normale)
                document.getElementById('mainApp').style.display = 'flex';
                document.getElementById('coachApp').style.display = 'none';
                document.getElementById('userInfo').textContent = currentUser.email;
                
                // Charger les donn√©es de l'√©l√®ve
                loadUserData(currentUser.id);
                updateAccountsList();
                updateDashboard();
                updateCalendar();
                initCharts();
            }
        }

        // Navigation
        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            
            document.getElementById(sectionName).classList.remove('hidden');
            event.target.classList.add('active');
            
            if (sectionName === 'dashboard') {
                updateDashboard();
                updateBanner(); // Mise √† jour des barres visuelles
                updateCharts();
            } else if (sectionName === 'tradelog') {
                updateTradesTable();
            } else if (sectionName === 'dailyjournal') {
                updateJournalEntries();
            }
        }

        // Modal functions
        function showAddTradeModal() {
            updateAccountsList(); // Refresh account options
            
            // R√©initialiser le symbole √† ES par d√©faut
            document.getElementById('symbol').value = 'ES';
            
            // Masquer le champ P&L manuel
            document.getElementById('manualPnLGroup').style.display = 'none';
            document.getElementById('manualPnL').value = '';
            document.getElementById('manualPnL').required = false;
            
            // Changer le titre pour "Ajouter un Trade"
            document.querySelector('#addTradeModal h2').textContent = 'Ajouter un Trade';
            
            document.getElementById('addTradeModal').style.display = 'block';
        }

        function showAddNoteModal() {
            const modal = document.getElementById('addNoteModal');
            delete modal.dataset.editingTimestamp;
            const btn = document.querySelector('#addNoteModal button[onclick="addNote()"]');
            if (btn) btn.textContent = 'Ajouter la Note';
            modal.style.display = 'block';
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                // Supprimer l'ID d'√©dition s'il existe
                delete modal.dataset.editingId;
            }
            
            if (modalId === 'addTradeModal') {
                const form = document.getElementById('tradeForm');
                if (form) {
                    // NE PAS reset le select du compte
                    const currentAccountValue = document.getElementById('tradeAccount').value;
                    console.log('üíæ closeModal - Sauvegarde valeur compte:', currentAccountValue);
                    form.reset();
                    // Restaurer la valeur du compte apr√®s reset
                    if (currentAccountValue) {
                        document.getElementById('tradeAccount').value = currentAccountValue;
                        console.log('üíæ closeModal - Valeur compte restaur√©e:', document.getElementById('tradeAccount').value);
                    }
                }
                setCurrentDate();
            } else if (modalId === 'addNoteModal') {
                const form = document.getElementById('noteForm');
                if (form) form.reset();
                removeImage();
                resetStarRating();
                setCurrentDate();
            } else if (modalId === 'addAccountModal') {
                const form = document.getElementById('accountForm');
                if (form) form.reset();
            }
        }

        function resetStarRating() {
            document.querySelectorAll('.star-rating').forEach(star => {
                star.style.opacity = '0.3';
                star.style.color = '#ccc';
            });
            document.getElementById('sessionRating').value = '0';
        }

        // Toggle manual P&L field for DEMO symbol
        function toggleManualPnL() {
            const symbol = document.getElementById('symbol').value;
            const manualPnLGroup = document.getElementById('manualPnLGroup');
            const manualPnLInput = document.getElementById('manualPnL');
            
            if (symbol === 'DEMO') {
                manualPnLGroup.style.display = 'block';
                manualPnLInput.required = true;
            } else {
                manualPnLGroup.style.display = 'none';
                manualPnLInput.required = false;
                manualPnLInput.value = ''; // Reset value
            }
        }

        // Trade functions
        function addTrade_DISABLED() { return; // D√âSACTIV√â - Voir supabase-trades.js
            const modal = document.getElementById('addTradeModal');
            const editingId = modal.dataset.editingId;
            const isEditing = editingId && editingId !== '';
            
            const accountValue = document.getElementById('tradeAccount').value;
            
            // DEBUG: Logs d√©taill√©s
                        console.log('accountValue brut:', accountValue, 'type:', typeof accountValue);
            console.log('Comptes disponibles:', accounts.map(a => ({ id: a.id, name: a.name })));
            
            // V√©rifier si le select existe
            const selectElement = document.getElementById('tradeAccount');
            console.log('Select element:', selectElement);
            console.log('Options dans le select:', selectElement ? selectElement.innerHTML : 'SELECT NOT FOUND');
            
            // Meilleure validation
            if (!accountValue || accountValue === "" || accountValue === "0") {
                console.error('‚ùå Validation √©chou√©e: accountValue vide ou 0');
                alert('Veuillez s√©lectionner un compte');
                return;
            }
            
            const accountId = parseInt(accountValue);
            console.log('accountId apr√®s parseInt:', accountId, 'isNaN:', isNaN(accountId));
            
            if (isNaN(accountId)) {
                console.error('‚ùå Validation √©chou√©e: accountId est NaN');
                console.log('Tentative avec parseFloat:', parseFloat(accountValue));
                alert('Compte invalide. Veuillez s√©lectionner un compte valide.');
                return;
            }
            
            const account = accounts.find(a => a.id === accountId);
            console.log('Compte trouv√©:', account);
            
            if (!account) {
                console.error('‚ùå Compte non trouv√© dans le tableau accounts');
                console.log('Recherche avec ID:', accountId);
                console.log('Tous les IDs disponibles:', accounts.map(a => a.id));
                alert('Compte non trouv√©. Veuillez r√©essayer.');
                return;
            }
            
            console.log('‚úÖ Validation compte r√©ussie:', account.name);

            // Collecter les protections coch√©es
            const protections = [];
            if (document.getElementById('protectionVWAP').checked) protections.push('VWAP');
            if (document.getElementById('protectionMM20').checked) protections.push('MM20');
            if (document.getElementById('protectionPivot').checked) protections.push('Pivot');
            if (document.getElementById('protectionClotureVeille').checked) protections.push('Cl√¥ture veille');
            if (document.getElementById('protectionLiquidite').checked) protections.push('Liquidit√© 30m/H1/H4');
            
            // DEBUG: Verification collecte exitTime
            const entryTimeValue = document.getElementById('entryTime').value;
            const exitTimeValue = document.getElementById('exitTime').value;
            console.log('DEBUG addTrade - Collecte horaires:', {
                entryTime: entryTimeValue,
                exitTime: exitTimeValue,
                exitTimeExists: !!exitTimeValue
            });
            
            const tradeData = {
                id: Date.now(),
                accountId: accountId,
                accountName: account.name,
                date: document.getElementById('tradeDate').value,
                entryTime: entryTimeValue,
                exitTime: exitTimeValue,
                symbol: document.getElementById('symbol').value,
                type: document.getElementById('tradeType').value,
                entryPrice: parseFloat(document.getElementById('entryPrice').value),
                exitPrice: parseFloat(document.getElementById('exitPrice').value),
                quantity: parseInt(document.getElementById('quantity').value),
                stopLoss: parseFloat(document.getElementById('stopLoss').value) || null,
                takeProfit: parseFloat(document.getElementById('takeProfit').value) || null,
                setup: document.getElementById('setup').value,
                protections: protections,
                notes: document.getElementById('tradeNotes').value,
                timestamp: new Date().toISOString()
            };

            // DEBUG: Verification tradeData avant sauvegarde
            console.log('DEBUG addTrade - TradeData complet:', {
                id: tradeData.id,
                entryTime: tradeData.entryTime,
                exitTime: tradeData.exitTime,
                hasExitTime: !!tradeData.exitTime
            });
            
            // Calculate P&L
            if (tradeData.symbol === 'DEMO') {
                // Utiliser le P&L manuel pour les comptes DEMO
                tradeData.pnl = parseFloat(document.getElementById('manualPnL').value) || 0;
            } else {
                // Calcul automatique pour ES et MES (ES = $50/point, MES = $5/point)
                const pointsDiff = tradeData.exitPrice - tradeData.entryPrice;
                const multiplier = tradeData.symbol === 'MES' ? 5 : 50;
                tradeData.pnl = pointsDiff * tradeData.quantity * multiplier;
                
                if (tradeData.type === 'Short') {
                    tradeData.pnl = -tradeData.pnl;
                }
            }

            if (isEditing) {
                // Modifier le trade existant
                // FIX: Utiliser parseFloat pour g√©rer les IDs d√©cimaux (trades CSV)
                const editId = parseFloat(editingId);
                const index = trades.findIndex(t => t.id === editId);
                if (index !== -1) {
                    tradeData.id = editId; // Garder l'ancien ID (avec d√©cimales)
                    trades[index] = tradeData;
                    console.log('‚úÖ Trade modifi√© avec succ√®s - ID:', editId);
                } else {
                    console.error('‚ùå Trade non trouv√© pour √©dition - ID recherch√©:', editId);
                    console.log('IDs disponibles:', trades.map(t => t.id));
                }
                delete modal.dataset.editingId;
            } else {
                // Ajouter un nouveau trade
                trades.push(tradeData);
            }
            saveToStorage();
            
            // DEBUG: Verification apres sauvegarde
            console.log('üîç DEBUG - Nombre de trades dans le tableau:', trades.length);
            console.log('üîç DEBUG - Dernier trade ajout√©:', trades[trades.length - 1]);
            
            // Fermer la modale AVANT les mises √† jour
            closeModal('addTradeModal');
            
            // IMPORTANT: Petit d√©lai pour s'assurer que le DOM est pr√™t
            setTimeout(() => {
                console.log('‚è∞ DEBUT du rafra√Æchissement apr√®s ajout trade...');
                console.log('‚è∞ Trades disponibles:', trades.length);
                
                // Forcer le rafra√Æchissement complet de TOUS les modules
                refreshAllModules();
                
                console.log('‚úÖ Trade ajout√© et tous les modules rafra√Æchis');
            }, 100);
        }

        function updateTradesTable() {
            console.log("  ‚Üí updateTradesTable() appel√©e");
            const tbody = document.getElementById('tradesTableBody');
            const activeAccounts = accounts.filter(a => a.active).map(a => a.id);
            let filteredTrades = trades.filter(trade => activeAccounts.includes(trade.accountId));
            
            // Trier par date et heure (du plus r√©cent au plus ancien)
            filteredTrades = filteredTrades.sort((a, b) => {
                const dateA = new Date(a.date + ' ' + (a.entryTime || '00:00:00'));
                const dateB = new Date(b.date + ' ' + (b.entryTime || '00:00:00'));
                return dateB - dateA; // Ordre d√©croissant (plus r√©cent en premier)
            });
            
            if (filteredTrades.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="px-6 py-4 text-center text-gray-500">
                            Aucun trade enregistr√© pour les comptes s√©lectionn√©s.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredTrades.map((trade, index) => {
                const pnlClass = trade.pnl >= 0 ? 'text-green-600 font-semibold' : 'text-red-600 font-semibold';
                const account = accounts.find(a => a.id === trade.accountId);
                return `
                    <tr class="trade-row border-b hover:bg-gray-50">
                        <td class="px-6 py-4 text-sm">${trade.date}</td>
                        <td class="px-6 py-4 text-sm">
                            <span class="px-2 py-1 rounded text-xs" style="background-color: ${account?.color}20; color: ${account?.color}">
                                ${trade.accountName}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm font-medium">${trade.symbol}</td>
                        <td class="px-6 py-4 text-sm">
                            <span class="px-2 py-1 rounded text-xs ${trade.type === 'Long' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${trade.type}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm">$${trade.entryPrice}</td>
                        <td class="px-6 py-4 text-sm">$${trade.exitPrice}</td>
                        <td class="px-6 py-4 text-sm">${trade.quantity}</td>
                        <td class="px-6 py-4 text-sm ${pnlClass}">$${trade.pnl.toFixed(2)}</td>
                        <td class="px-6 py-4 text-sm">${trade.setup}</td>
                        <td class="px-6 py-4 text-sm">
                            <button onclick="viewTrade(${trade.id})" class="action-btn" style="color: #10b981; margin-right: 8px;" title="Voir">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="editTrade(${trade.id})" class="action-btn btn-modify" title="Modifier" style="margin-right: 8px;">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteTrade(${trade.id})" class="action-btn btn-delete" title="Supprimer">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function editTrade(tradeId) {
            const trade = trades.find(t => t.id === tradeId);
            if (!trade) {
                alert('Trade non trouv√©');
                return;
            }
            
            // Remplir le formulaire avec les donn√©es du trade
            document.getElementById('tradeAccount').value = trade.accountId;
            document.getElementById('tradeDate').value = trade.date;
            document.getElementById('entryTime').value = trade.entryTime || '';
            document.getElementById('symbol').value = trade.symbol || 'ES';
            
            // Si c'est un trade DEMO, afficher et remplir le champ P&L manuel
            toggleManualPnL();
            if (trade.symbol === 'DEMO') {
                document.getElementById('manualPnL').value = trade.pnl || 0;
            }
            
            document.getElementById('tradeType').value = trade.type;
            document.getElementById('entryPrice').value = trade.entryPrice;
            document.getElementById('exitPrice').value = trade.exitPrice;
            document.getElementById('quantity').value = trade.quantity;
            document.getElementById('stopLoss').value = trade.stopLoss || '';
            document.getElementById('takeProfit').value = trade.takeProfit || '';
            document.getElementById('setup').value = trade.setup || '';
            document.getElementById('tradeNotes').value = trade.notes || '';
            
            // Cocher les protections
            if (trade.protections && Array.isArray(trade.protections)) {
                document.getElementById('protectionVWAP').checked = trade.protections.includes('VWAP');
                document.getElementById('protectionMM20').checked = trade.protections.includes('MM20');
                document.getElementById('protectionPivot').checked = trade.protections.includes('Pivot');
                document.getElementById('protectionClotureVeille').checked = trade.protections.includes('Cl√¥ture veille');
                document.getElementById('protectionLiquidite').checked = trade.protections.includes('Liquidit√© 30m/H1/H4');
            }
            
            // Stocker l'ID du trade en cours de modification
            document.getElementById('addTradeModal').dataset.editingId = tradeId;
            
            // Changer le titre et le bouton
            document.querySelector('#addTradeModal h2').textContent = 'Modifier le Trade';
            document.querySelector('#addTradeModal .trader-btn').textContent = 'Enregistrer les modifications';
            
            // Ouvrir le modal
            document.getElementById('addTradeModal').style.display = 'block';
        }
        
        function deleteTrade_DISABLED(tradeId) { return; // D√âSACTIV√â - Voir supabase-trades.js
            if (confirm('√ätes-vous s√ªr de vouloir supprimer ce trade ?')) {
                // FIX: Trouver l'index du trade par son ID (pas par position dans le tableau filtr√©)
                const tradeIdFloat = parseFloat(tradeId); // G√©rer les IDs d√©cimaux (trades CSV)
                const index = trades.findIndex(t => t.id === tradeIdFloat);
                
                if (index !== -1) {
                    console.log('üóëÔ∏è Suppression du trade ID:', tradeIdFloat, '√† l\'index:', index);
                    trades.splice(index, 1);
                    saveToStorage();
                    
                    console.log('üóëÔ∏è Trade supprim√©, rafra√Æchissement...');
                    refreshAllModules();
                } else {
                    console.error('‚ùå Trade non trouv√© pour suppression - ID:', tradeIdFloat);
                    alert('Erreur: Trade non trouv√©');
                }
            }
        }

        // Journal functions
        function addNote() {
            const modal = document.getElementById('addNoteModal');
            const editingTimestamp = modal.dataset.editingTimestamp;
            const isEditing = editingTimestamp && editingTimestamp !== '';
            
            const noteData = {
                date: document.getElementById('noteDate').value,
                text: document.getElementById('noteText').value,
                emotionBefore: document.getElementById('emotionBefore').value,
                emotionAfter: document.getElementById('emotionAfter').value,
                rating: parseInt(document.getElementById('sessionRating').value),
                image: null,
                timestamp: isEditing ? editingTimestamp : new Date().toISOString()
            };

            const imageFile = document.getElementById('noteImage').files[0];
            
            if (isEditing) {
                // Mode √©dition
                const index = journalEntries.findIndex(e => e.timestamp === editingTimestamp);
                if (index !== -1) {
                    // Garder l'ancienne image si pas de nouvelle
                    if (!imageFile) {
                        noteData.image = journalEntries[index].image;
                    }
                    
                    if (imageFile) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            noteData.image = e.target.result;
                            journalEntries[index] = noteData;
                            saveToStorage();
                            updateJournalEntries();
                            closeModal('addNoteModal');
                            delete modal.dataset.editingTimestamp;
                        };
                        reader.readAsDataURL(imageFile);
                    } else {
                        journalEntries[index] = noteData;
                        saveToStorage();
                        updateJournalEntries();
                        closeModal('addNoteModal');
                        delete modal.dataset.editingTimestamp;
                    }
                }
            } else {
                // Mode ajout
                if (imageFile) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        noteData.image = e.target.result;
                        journalEntries.push(noteData);
                        saveToStorage();
                        updateJournalEntries();
                        closeModal('addNoteModal');
                    };
                    reader.readAsDataURL(imageFile);
                } else {
                    journalEntries.push(noteData);
                    saveToStorage();
                    updateJournalEntries();
                    closeModal('addNoteModal');
                }
            }
        }

        function previewImage(input) {
            const preview = document.getElementById('imagePreview');
            const img = document.getElementById('previewImg');
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function removeImage() {
            document.getElementById('noteImage').value = '';
            document.getElementById('imagePreview').classList.add('hidden');
        }

        // Fonction pour filtrer le journal par date
        function filterJournalByDate(dateString) {
            const container = document.getElementById('journalEntries');
            const filtered = journalEntries.filter(entry => entry.date === dateString);
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-gray-500 mb-4">Aucune note pour le ${formatDateFR(dateString)}</p>
                        <button onclick="clearJournalFilter()" class="trader-btn-secondary">
                            Voir toutes les notes
                        </button>
                    </div>
                `;
            } else {
                let html = `
                    <div class="mb-4 flex justify-between items-center bg-blue-50 p-3 rounded">
                        <div>
                            <span class="text-blue-800 font-semibold">üìÖ Notes du ${formatDateFR(dateString)}</span>
                            <span class="text-blue-600 ml-2">(${filtered.length} note${filtered.length > 1 ? 's' : ''})</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="navigateJournalDate(-1)" class="text-blue-600 hover:text-blue-800 px-3 py-1 rounded hover:bg-blue-100" title="Jour pr√©c√©dent">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button onclick="clearJournalFilter()" class="trader-btn-secondary text-sm">
                                Voir tout
                            </button>
                            <button onclick="navigateJournalDate(1)" class="text-blue-600 hover:text-blue-800 px-3 py-1 rounded hover:bg-blue-100" title="Jour suivant">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                html += filtered
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                    .map(entry => {
                        const stars = '‚≠ê'.repeat(entry.rating);
                        return `
                            <div class="border-b pb-4 mb-4 last:border-b-0">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="flex-1">
                                        <h4 class="font-semibold text-gray-800">${entry.date}</h4>
                                        <span class="text-sm text-gray-500">${stars}</span>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="viewJournalEntry('${entry.timestamp}')" class="text-green-600 hover:text-green-800 px-2 py-1 rounded hover:bg-green-50" title="Voir">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button onclick="editJournalEntry('${entry.timestamp}')" class="text-blue-600 hover:text-blue-800 px-2 py-1 rounded hover:bg-blue-50" title="Modifier">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="deleteJournalEntry('${entry.timestamp}')" class="text-red-600 hover:text-red-800 px-2 py-1 rounded hover:bg-red-50" title="Supprimer">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                ${entry.emotionBefore || entry.emotionAfter ? `
                                    <div class="text-sm text-gray-600 mb-2">
                                        ${entry.emotionBefore ? `Avant: ${entry.emotionBefore}` : ''}
                                        ${entry.emotionBefore && entry.emotionAfter ? ' | ' : ''}
                                        ${entry.emotionAfter ? `Apr√®s: ${entry.emotionAfter}` : ''}
                                    </div>
                                ` : ''}
                                <p class="text-gray-700 whitespace-pre-wrap">${entry.text}</p>
                                ${entry.image ? `
                                    <div class="mt-3">
                                        <img src="${entry.image}" alt="Note image" class="max-w-full h-48 object-contain border rounded cursor-pointer hover:opacity-80 transition" onclick="viewImageZoom('${entry.image}')" title="Cliquer pour agrandir">
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('');
                
                container.innerHTML = html;
            }
        }
        
        // Fonction pour formater une date en fran√ßais
        function formatDateFR(dateString) {
            const date = new Date(dateString + 'T12:00:00'); // Forcer midi pour √©viter d√©calage
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('fr-FR', options);
        }
        
        // Fonction pour naviguer entre les jours
        function navigateJournalDate(direction) {
            if (!window.selectedJournalDate) return;
            
            const currentDate = new Date(window.selectedJournalDate + 'T12:00:00');
            currentDate.setDate(currentDate.getDate() + direction);
            
            const year = currentDate.getFullYear();
            const month = String(currentDate.getMonth() + 1).padStart(2, '0');
            const day = String(currentDate.getDate()).padStart(2, '0');
            const newDateString = `${year}-${month}-${day}`;
            
            window.selectedJournalDate = newDateString;
            document.getElementById('noteDate').value = newDateString;
            
            filterJournalByDate(newDateString);
            
            // Afficher les trades de la nouvelle date
            const dayTrades = trades.filter(t => t.date.split('T')[0] === newDateString);
            displayTradesForDate(newDateString, dayTrades);
        }
        
        // Fonction pour effacer le filtre
        function clearJournalFilter() {
            window.selectedJournalDate = null;
            updateJournalEntries();
            
            // Effacer l'affichage des trades du jour
            const tradesDisplay = document.getElementById('dailyTradesDisplay');
            if (tradesDisplay) {
                tradesDisplay.innerHTML = '';
            }
        }
        
        // Fonction pour afficher les trades d'une date
        function displayTradesForDate(dateString, dayTrades) {
            let tradesDisplay = document.getElementById('dailyTradesDisplay');
            
            // Cr√©er l'√©l√©ment s'il n'existe pas
            if (!tradesDisplay) {
                const journalSection = document.getElementById('dailyjournal');
                if (journalSection) {
                    tradesDisplay = document.createElement('div');
                    tradesDisplay.id = 'dailyTradesDisplay';
                    tradesDisplay.className = 'mb-6';
                    // Ins√©rer avant le conteneur des notes
                    const journalEntries = document.getElementById('journalEntries');
                    if (journalEntries && journalEntries.parentNode) {
                        journalEntries.parentNode.insertBefore(tradesDisplay, journalEntries);
                    }
                }
            }
            
            if (!tradesDisplay) return;
            
            if (dayTrades.length === 0) {
                tradesDisplay.innerHTML = '';
                return;
            }
            
            const dayPnl = dayTrades.reduce((sum, t) => sum + t.pnl, 0);
            const pnlClass = dayPnl >= 0 ? 'text-green-600' : 'text-red-600';
            
            let html = `
                <div class="trader-card p-4 bg-gradient-to-r ${dayPnl >= 0 ? 'from-green-50 to-white' : 'from-red-50 to-white'}">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-lg font-bold text-gray-800">
                            üìà Trades du ${formatDateFR(dateString)}
                        </h3>
                        <div class="${pnlClass} font-bold text-xl">
                            ${dayPnl >= 0 ? '+' : ''}$${dayPnl.toFixed(2)}
                        </div>
                    </div>
                    <div class="space-y-2">
            `;
            
            dayTrades.forEach(trade => {
                const tradePnlClass = trade.pnl >= 0 ? 'text-green-600' : 'text-red-600';
                html += `
                    <div class="flex justify-between items-center p-3 bg-white rounded border hover:shadow-md transition">
                        <div class="flex-1">
                            <div class="flex items-center gap-3">
                                <span class="font-semibold">${trade.symbol}</span>
                                <span class="px-2 py-1 rounded text-xs ${trade.type === 'Long' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                    ${trade.type}
                                </span>
                                ${trade.entryTime ? `<span class="text-xs text-gray-500">${trade.entryTime}</span>` : ''}
                            </div>
                            ${trade.setup ? `<div class="text-sm text-gray-600 mt-1">${trade.setup}</div>` : ''}
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="${tradePnlClass} font-bold">${trade.pnl >= 0 ? '+' : ''}$${trade.pnl.toFixed(2)}</span>
                            <button onclick="viewTrade(${trade.id})" class="text-blue-600 hover:text-blue-800 px-2 py-1 rounded hover:bg-blue-50" title="Voir d√©tails">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            tradesDisplay.innerHTML = html;
        }

        function updateJournalEntries() {
            const container = document.getElementById('journalEntries');
            
            if (journalEntries.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Aucune note ajout√©e. Commencez par ajouter une entr√©e.</p>';
            } else {
                container.innerHTML = journalEntries
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                    .map((entry, index) => {
                        const stars = '‚≠ê'.repeat(entry.rating);
                        return `
                            <div class="border-b pb-4 mb-4 last:border-b-0">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="flex-1">
                                        <h4 class="font-semibold text-gray-800">${entry.date}</h4>
                                        <span class="text-sm text-gray-500">${stars}</span>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="editJournalEntry('${entry.timestamp}')" class="text-blue-600 hover:text-blue-800 px-2 py-1 rounded hover:bg-blue-50" title="Modifier">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="deleteJournalEntry('${entry.timestamp}')" class="text-red-600 hover:text-red-800 px-2 py-1 rounded hover:bg-red-50" title="Supprimer">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                ${entry.emotionBefore || entry.emotionAfter ? `
                                    <div class="text-sm text-gray-600 mb-2">
                                        ${entry.emotionBefore ? `Avant: ${entry.emotionBefore}` : ''}
                                        ${entry.emotionBefore && entry.emotionAfter ? ' | ' : ''}
                                        ${entry.emotionAfter ? `Apr√®s: ${entry.emotionAfter}` : ''}
                                    </div>
                                ` : ''}
                                <p class="text-gray-700 whitespace-pre-wrap">${entry.text}</p>
                                ${entry.image ? `
                                    <div class="mt-3">
                                        <img src="${entry.image}" alt="Note image" class="max-w-full h-48 object-contain border rounded cursor-pointer hover:opacity-80 transition" onclick="viewImageZoom(\'${entry.image}\')" title="Cliquer pour agrandir">
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('');
            }
            
            // Update stats
            document.getElementById('totalEntries').textContent = journalEntries.length;
            
            const thisWeek = new Date();
            thisWeek.setDate(thisWeek.getDate() - 7);
            const weeklyCount = journalEntries.filter(entry => 
                new Date(entry.timestamp) > thisWeek
            ).length;
            document.getElementById('weeklyEntries').textContent = weeklyCount;
            
            const withImages = journalEntries.filter(entry => entry.image).length;
            document.getElementById('entriesWithImages').textContent = withImages;
        }

        // Fonction pour modifier une note
        function editJournalEntry(timestamp) {
            const entry = journalEntries.find(e => e.timestamp === timestamp);
            if (!entry) {
                alert('Note non trouv√©e');
                return;
            }
            
            // Pr√©-remplir le formulaire
            document.getElementById('noteDate').value = entry.date;
            document.getElementById('noteText').value = entry.text;
            document.getElementById('emotionBefore').value = entry.emotionBefore || '';
            document.getElementById('emotionAfter').value = entry.emotionAfter || '';
            document.getElementById('sessionRating').value = entry.rating;
            
            // Mettre √† jour les √©toiles
            document.querySelectorAll('.star-rating').forEach((star, index) => {
                if (index < entry.rating) {
                    star.style.opacity = '1';
                    star.style.color = '#FFD700';
                } else {
                    star.style.opacity = '0.3';
                    star.style.color = '#ccc';
                }
            });
            
            // Si image, afficher preview
            if (entry.image) {
                document.getElementById('previewImg').src = entry.image;
                document.getElementById('imagePreview').classList.remove('hidden');
            }
            
            // Marquer le modal en mode √©dition
            const modal = document.getElementById('addNoteModal');
            modal.dataset.editingTimestamp = timestamp;
            modal.style.display = 'block';
            
            // Changer le texte du bouton
            document.querySelector('#addNoteModal button[onclick="addNote()"]').textContent = 'Modifier la Note';
        }

        // Fonction pour supprimer une note
        // deleteJournalEntry d√©plac√© vers supabase-journal.js

        // Dashboard functions

        function refreshAllModules() {
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üîÑ REFRESH - D√©but du rafra√Æchissement...');
            console.log('üîÑ REFRESH - Nombre total de trades:', trades.length);
            console.log('üîÑ REFRESH - Array trades:', trades);
            
            const activeAccounts = accounts.filter(a => a.active).map(a => a.id);
            console.log('üîÑ REFRESH - Comptes actifs:', activeAccounts);
            console.log('üîÑ REFRESH - Tous les comptes:', accounts);
            
            const filteredTrades = activeAccounts.length > 0 
                ? trades.filter(trade => activeAccounts.includes(trade.accountId))
                : trades;
            
            console.log('üîÑ REFRESH - Trades filtr√©s:', filteredTrades.length);
            console.log('üîÑ REFRESH - D√©tail trades filtr√©s:', filteredTrades);
            
            // Mise √† jour de tous les modules
            console.log('üìä Appel updateTradesTable()...');
            updateTradesTable();
            
            console.log('üìä Appel updateDashboard()...');
            updateDashboard();
            
            console.log('üìä Appel updateBanner()...');
            updateBanner();
            
            console.log('üìä Appel updateCharts()...');
            updateCharts();
            
            console.log('üìä Appel updateCalendar()...');
            updateCalendar();
            
            console.log('üìä Appel updateRecentTrades()...');
            updateRecentTrades();
            
            console.log('üìä Appel updateProtectionAnalysis()...');
            updateProtectionAnalysis();
            
            console.log('‚úÖ Rafra√Æchissement termin√©');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            
            // Notification visuelle
            showNotification('Tous les modules ont √©t√© rafra√Æchis', 'success');
        }
        
        function showNotification(message, type = 'info') {
            // Cr√©er une notification temporaire
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#10b981' : '#3b82f6'};
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                z-index: 10000;
                font-weight: 600;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }

        function updateDashboard() {
            console.log("  ‚Üí updateDashboard() appel√©e");
            // Si aucun compte actif, utiliser tous les trades
            const activeAccounts = accounts.filter(a => a.active).map(a => a.id);
            const filteredTrades = activeAccounts.length === 0 
                ? trades 
                : trades.filter(trade => activeAccounts.includes(trade.accountId));

            console.log('üìä updateDashboard - Trades filtr√©s:', filteredTrades.length, 'sur', trades.length, 'total');

            if (filteredTrades.length === 0) {
                resetDashboard();
                return;
            }

            // Calculer les m√©triques correctement
            const totalPnl = filteredTrades.reduce((sum, trade) => sum + trade.pnl, 0);
            const winningTrades = filteredTrades.filter(trade => trade.pnl > 0);
            const losingTrades = filteredTrades.filter(trade => trade.pnl < 0);
            const neutralTrades = filteredTrades.filter(trade => trade.pnl === 0);
            
            const tradeWinRate = filteredTrades.length > 0 ? (winningTrades.length / filteredTrades.length) * 100 : 0;
            
            const grossProfit = winningTrades.reduce((sum, trade) => sum + trade.pnl, 0);
            const grossLoss = Math.abs(losingTrades.reduce((sum, trade) => sum + trade.pnl, 0));
            const profitFactor = grossLoss > 0 ? grossProfit / grossLoss : (grossProfit > 0 ? 99.99 : 0);
            
            const avgWin = winningTrades.length > 0 ? grossProfit / winningTrades.length : 0;
            const avgLoss = losingTrades.length > 0 ? grossLoss / losingTrades.length : 0;
            const avgRatio = avgLoss > 0 ? avgWin / avgLoss : (avgWin > 0 ? 99.99 : 0);

            // Grouper par jour pour day win %
            const tradesByDay = {};
            filteredTrades.forEach(trade => {
                if (!tradesByDay[trade.date]) {
                    tradesByDay[trade.date] = 0;
                }
                tradesByDay[trade.date] += trade.pnl;
            });
            
            const dayResults = Object.values(tradesByDay);
            const winningDays = dayResults.filter(d => d > 0).length;
            const dayWinRate = dayResults.length > 0 ? (winningDays / dayResults.length) * 100 : 0;

            // Mettre √† jour le bandeau avec les BONNES valeurs
            const netPnlEl = document.getElementById('netPnlValue');
            if (netPnlEl) {
                netPnlEl.textContent = `$${totalPnl.toFixed(2)}`;
                netPnlEl.style.color = totalPnl < 0 ? '#ef4444' : '#10b981'; // Rouge si n√©gatif, vert sinon
            }
            
            const tradeWinEl = document.getElementById('tradeWinValue');
            if (tradeWinEl) tradeWinEl.textContent = `${tradeWinRate.toFixed(1)}%`;
            
            const profitFactorEl = document.getElementById('profitFactorValue');
            if (profitFactorEl) profitFactorEl.textContent = profitFactor.toFixed(2);
            
            const dayWinEl = document.getElementById('dayWinValue');
            if (dayWinEl) dayWinEl.textContent = `${dayWinRate.toFixed(1)}%`;
            
            const avgRatioEl = document.getElementById('avgWinLossValue');
            if (avgRatioEl) avgRatioEl.textContent = avgRatio.toFixed(2);
        }

        function resetDashboard() {
            const netPnlEl = document.getElementById('netPnlValue');
            if (netPnlEl) {
                netPnlEl.textContent = '$0.00';
                netPnlEl.style.color = '#10b981'; // Vert pour $0
            }
            document.getElementById('tradeWinValue').textContent = '0%';
            document.getElementById('profitFactorValue').textContent = '0.00';
            document.getElementById('dayWinValue').textContent = '0%';
            document.getElementById('avgWinLossValue').textContent = '0.00';
        }

        // Calendar functions
        function updateCalendar() {
            console.log("  ‚Üí updateCalendar() appel√©e");
            const monthNames = ["Janvier", "F√©vrier", "Mars", "Avril", "Mai", "Juin",
                "Juillet", "Ao√ªt", "Septembre", "Octobre", "Novembre", "D√©cembre"];
            
            document.getElementById('currentMonth').textContent = `${monthNames[currentMonth]} ${currentYear}`;
            
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            const calendarGrid = document.getElementById('calendarGrid');
            if (!calendarGrid) return; // Protection si √©l√©ment n'existe pas
            
            calendarGrid.innerHTML = '';
            
            // Filtrer par comptes actifs
            const filteredTrades = getFilteredTrades();
            const activeAccountIds = accounts.length > 0 ? accounts.filter(a => a.active).map(a => a.id) : [];
            
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate.getTime());
                date.setDate(date.getDate() + i);
                
                const isCurrentMonth = date.getMonth() === currentMonth;
                // CORRECTION: Utiliser la date locale au lieu d'UTC pour √©viter le d√©calage
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const dateString = `${year}-${month}-${day}`; // Format YYYY-MM-DD en heure locale
                
                // Comparer les dates en normalisant les deux c√¥t√©s
                const dayTrades = filteredTrades.filter(trade => {
                    // Filtrage d√©j√† fait par getFilteredTrades(), pas besoin de re-filtrer par compte
                    
                    // Normaliser la date du trade (enlever l'heure si pr√©sente)
                    const tradeDate = trade.date.split('T')[0]; // Prendre seulement YYYY-MM-DD
                    const isMatch = tradeDate === dateString;
                    
                    // DEBUG: Logger les comparaisons pour les trades r√©cents (20-21 octobre)
                    if (dateString === '2025-10-20' || tradeDate === '2025-10-20' || 
                        dateString === '2025-10-21' || tradeDate === '2025-10-21') {
                        console.log(`üìÖ Calendar check: cellDate=${dateString} vs tradeDate=${tradeDate} => ${isMatch ? '‚úÖ MATCH' : '‚ùå NO MATCH'}`);
                    }
                    
                    return isMatch;
                });
                
                const dayPnl = dayTrades.reduce((sum, trade) => sum + trade.pnl, 0);
                
                let className = 'text-center py-3 cursor-pointer rounded transition-all';
                if (!isCurrentMonth) {
                    className += ' text-gray-300';
                } else if (dayTrades.length > 0) {
                    className += dayPnl > 0 ? ' bg-green-100 text-green-800 hover:bg-green-200' : ' bg-red-100 text-red-800 hover:bg-red-200';
                } else {
                    className += ' text-gray-700 hover:bg-gray-100';
                }
                
                const dayElement = document.createElement('div');
                dayElement.className = className;
                
                // Construire le contenu de la cellule
                let cellContent = `<div class="font-semibold">${date.getDate()}</div>`;
                
                if (dayTrades.length > 0 && isCurrentMonth) {
                    // Calculer les statistiques du jour
                    const tradeCount = dayTrades.length;
                    const winningTrades = dayTrades.filter(t => t.pnl > 0).length;
                    const winRate = ((winningTrades / tradeCount) * 100).toFixed(0);
                    
                    let statsHtml = '<div class="text-xs mt-1 space-y-0.5">';
                    
                    // Afficher selon les pr√©f√©rences
                    if (calendarDisplay.showPnl) {
                        statsHtml += `<div class="font-semibold">${dayPnl > 0 ? '+' : ''}$${dayPnl.toFixed(0)}</div>`;
                    }
                    if (calendarDisplay.showTradeCount) {
                        statsHtml += `<div class="opacity-75">${tradeCount} trade${tradeCount > 1 ? 's' : ''}</div>`;
                    }
                    if (calendarDisplay.showWinRate) {
                        const winRateColor = winRate >= 50 ? 'text-green-700' : 'text-red-700';
                        statsHtml += `<div class="${winRateColor} font-medium">${winRate}% win</div>`;
                    }
                    
                    statsHtml += '</div>';
                    cellContent += statsHtml;
                }
                
                dayElement.innerHTML = cellContent;
                
                // CLICK HANDLER: Ouvrir le Daily Journal √† la date cliqu√©e
                if (isCurrentMonth) {
                    dayElement.addEventListener('click', () => {
                        // Sauvegarder la date s√©lectionn√©e
                        window.selectedJournalDate = dateString;
                        
                        // Passer √† la section Daily Journal
                        showSection('dailyjournal');
                        
                        // Pr√©-remplir la date dans le formulaire de note
                        const noteDate = document.getElementById('noteDate');
                        if (noteDate) {
                            noteDate.value = dateString;
                        }
                        
                        // Filtrer et afficher les notes de cette date
                        filterJournalByDate(dateString);
                        
                        // Afficher les trades de cette date
                        displayTradesForDate(dateString, dayTrades);
                    });
                }
                
                calendarGrid.appendChild(dayElement);
            }
            
            // Mettre √† jour les statistiques hebdomadaires
            updateWeeklyStats();
            // Mettre √† jour les statistiques mensuelles
            updateMonthlyStats();
        }
        
        // NOUVELLE FONCTION: Calcul des statistiques mensuelles
        function updateMonthlyStats() {
            // Filtrer par comptes actifs
            const activeAccountIds = accounts.filter(a => a.active).map(a => a.id);
            const filteredTrades = trades.filter(trade => activeAccountIds.includes(trade.accountId));
            
            // Filtrer les trades du mois courant
            const monthTrades = filteredTrades.filter(trade => {
                // Normaliser la date du trade
                const tradeDateStr = String(trade.date).trim().split('T')[0].split(' ')[0];
                const parts = tradeDateStr.split('-');
                const tradeYear = parseInt(parts[0]);
                const tradeMonth = parseInt(parts[1]) - 1; // Mois commence √† 0
                
                const isMatch = tradeYear === currentYear && tradeMonth === currentMonth;
                
                console.log(`üìä Monthly: trade ${tradeDateStr} ‚Üí year=${tradeYear} month=${tradeMonth} match=${isMatch}`);
                
                return isMatch;
            });
            
            // Calculer le P&L total du mois
            const monthlyPnl = monthTrades.reduce((sum, trade) => sum + trade.pnl, 0);
            
            // Compter le nombre de jours uniques trad√©s
            const uniqueDays = new Set(monthTrades.map(trade => trade.date));
            const daysCount = uniqueDays.size;
            
            // Mettre √† jour le DOM
            const monthlyPnlEl = document.getElementById('monthlyPnl');
            const monthlyDaysEl = document.getElementById('monthlyDays');
            
            if (monthlyPnlEl) {
                if (monthlyPnl !== 0) {
                    monthlyPnlEl.textContent = monthlyPnl >= 0 ? `+$${monthlyPnl.toFixed(2)}` : `-$${Math.abs(monthlyPnl).toFixed(2)}`;
                    monthlyPnlEl.className = 'font-semibold ' + (monthlyPnl >= 0 ? 'text-green-600' : 'text-red-600');
                } else {
                    monthlyPnlEl.textContent = '$0.00';
                    monthlyPnlEl.className = 'font-semibold text-gray-600';
                }
            }
            
            if (monthlyDaysEl) {
                monthlyDaysEl.textContent = daysCount === 0 ? '0 jour' : (daysCount === 1 ? '1 jour' : `${daysCount} jours`);
            }
        }

                // NOUVELLE FONCTION: Calcul des statistiques hebdomadaires
        // Les semaines commencent le 1er du mois et se terminent au dimanche suivant
        function updateWeeklyStats() {
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            
            // Filtrer par comptes actifs
            const activeAccountIds = accounts.filter(a => a.active).map(a => a.id);
            const filteredTrades = trades.filter(trade => activeAccountIds.includes(trade.accountId));
            
            // Grouper les trades par semaine du mois
            const weekData = [
                { pnl: 0, days: new Set(), startDate: null, endDate: null },
                { pnl: 0, days: new Set(), startDate: null, endDate: null },
                { pnl: 0, days: new Set(), startDate: null, endDate: null },
                { pnl: 0, days: new Set(), startDate: null, endDate: null },
                { pnl: 0, days: new Set(), startDate: null, endDate: null }
            ];
            
            // Calculer les dates de d√©but/fin pour chaque semaine
            let currentDate = new Date(firstDay);
            let weekIndex = 0;
            
            while (currentDate <= lastDay && weekIndex < 5) {
                if (!weekData[weekIndex].startDate) {
                    weekData[weekIndex].startDate = new Date(currentDate);
                }
                
                // Si on est dimanche OU si c'est le dernier jour du mois, on termine la semaine
                if (currentDate.getDay() === 0 || currentDate.getTime() === lastDay.getTime()) {
                    weekData[weekIndex].endDate = new Date(currentDate);
                    weekIndex++;
                }
                
                // Passer au jour suivant
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // Assigner les trades aux bonnes semaines
            filteredTrades.forEach(trade => {
                // Normaliser la date du trade
                const tradeDateStr = trade.date.split('T')[0]; // Format YYYY-MM-DD
                const tradeDate = new Date(tradeDateStr + 'T12:00:00'); // Midi pour √©viter probl√®mes timezone
                
                // V√©rifier si le trade est dans le mois actuel
                if (tradeDate.getFullYear() === currentYear && tradeDate.getMonth() === currentMonth) {
                    // Trouver la bonne semaine
                    for (let i = 0; i < weekData.length; i++) {
                        if (weekData[i].startDate && weekData[i].endDate) {
                            // Normaliser les dates de comparaison √† midi
                            const weekStart = new Date(weekData[i].startDate);
                            weekStart.setHours(12, 0, 0, 0);
                            const weekEnd = new Date(weekData[i].endDate);
                            weekEnd.setHours(12, 0, 0, 0);
                            const tradeNorm = new Date(tradeDate);
                            tradeNorm.setHours(12, 0, 0, 0);
                            
                            if (tradeNorm >= weekStart && tradeNorm <= weekEnd) {
                                weekData[i].pnl += trade.pnl;
                                weekData[i].days.add(tradeDateStr);
                                break;
                            }
                        }
                    }
                }
            });
            
            // Mettre √† jour le DOM
            for (let i = 0; i < 5; i++) {
                const pnlEl = document.getElementById(`week${i + 1}Pnl`);
                const daysEl = document.getElementById(`week${i + 1}Days`);
                
                if (pnlEl && daysEl) {
                    const pnl = weekData[i].pnl;
                    const daysCount = weekData[i].days.size;
                    
                    // Afficher le P&L
                    if (pnl !== 0) {
                        pnlEl.textContent = pnl >= 0 ? `+$${pnl.toFixed(2)}` : `-$${Math.abs(pnl).toFixed(2)}`;
                        pnlEl.className = 'text-lg font-bold ' + (pnl >= 0 ? 'text-green-600' : 'text-red-600');
                    } else {
                        pnlEl.textContent = '$0.00';
                        pnlEl.className = 'text-lg font-bold text-gray-400';
                    }
                    
                    // Afficher le nombre de jours
                    daysEl.textContent = daysCount === 0 ? '0 jour' : (daysCount === 1 ? '1 jour' : `${daysCount} jours`);
                }
            }
        }

        function previousMonth() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            updateCalendar();
        }

        function nextMonth() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            updateCalendar();
        }
        
        // Nouvelle fonction: Toggle du menu des param√®tres
        function toggleCalendarSettings() {
            const settingsMenu = document.getElementById('calendarSettings');
            if (settingsMenu.style.display === 'none') {
                settingsMenu.style.display = 'block';
            } else {
                settingsMenu.style.display = 'none';
            }
        }
        
        // Fermer le menu si on clique ailleurs
        document.addEventListener('click', function(event) {
            const settingsMenu = document.getElementById('calendarSettings');
            const settingsButton = event.target.closest('button[onclick*="toggleCalendarSettings"]');
            
            if (settingsMenu && !settingsMenu.contains(event.target) && !settingsButton) {
                settingsMenu.style.display = 'none';
            }
        });
        
        // Nouvelle fonction: Mise √† jour de l'affichage selon les pr√©f√©rences

        function updateRecentTrades() {
            console.log("  ‚Üí updateRecentTrades() appel√©e");
            
            const container = document.getElementById('recentTradesContainer');
            if (!container) return;
            
            // R√©cup√©rer les comptes actifs
            const activeAccounts = accounts.filter(a => a.active).map(a => a.id);
            let filteredTrades = activeAccounts.length > 0 
                ? trades.filter(trade => activeAccounts.includes(trade.accountId))
                : trades;
            
            if (filteredTrades.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-inbox text-4xl mb-2"></i>
                        <p>Aucun trade r√©cent</p>
                    </div>
                `;
                return;
            }
            
            // Trier par date d√©croissante (plus r√©cent en premier) puis par timestamp
            const sortedTrades = [...filteredTrades].sort((a, b) => {
                const dateCompare = new Date(b.date) - new Date(a.date);
                if (dateCompare !== 0) return dateCompare;
                return b.timestamp?.localeCompare(a.timestamp || '') || 0;
            });
            
            // Prendre les 5 derniers trades
            const recentTrades = sortedTrades.slice(0, 5);
            
            // G√©n√©rer le HTML
            container.innerHTML = recentTrades.map(trade => {
                const pnlColor = trade.pnl > 0 ? 'text-green-600' : trade.pnl < 0 ? 'text-red-600' : 'text-gray-600';
                const pnlBg = trade.pnl > 0 ? 'bg-green-50' : trade.pnl < 0 ? 'bg-red-50' : 'bg-gray-50';
                const pnlIcon = trade.pnl > 0 ? 'fa-arrow-up' : trade.pnl < 0 ? 'fa-arrow-down' : 'fa-minus';
                
                // Formater la date
                const tradeDate = new Date(trade.date);
                const dateStr = tradeDate.toLocaleDateString('fr-FR', { 
                    day: '2-digit', 
                    month: 'short' 
                });
                
                // Formater l'heure
                const timeStr = trade.entryTime || '--:--';
                
                return `
                    <div class="border-l-4 ${trade.pnl > 0 ? 'border-green-500' : trade.pnl < 0 ? 'border-red-500' : 'border-gray-400'} pl-3 py-2 ${pnlBg} rounded-r">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <span class="font-semibold text-sm">${trade.symbol}</span>
                                    <span class="text-xs px-2 py-0.5 rounded ${trade.type === 'Long' ? 'bg-blue-100 text-blue-700' : 'bg-orange-100 text-orange-700'}">
                                        ${trade.type}
                                    </span>
                                    <span class="text-xs text-gray-500">${trade.accountName}</span>
                                </div>
                                <div class="text-xs text-gray-600 mt-1">
                                    <i class="far fa-calendar-alt"></i> ${dateStr} 
                                    <i class="far fa-clock ml-2"></i> ${timeStr}
                                    ${trade.setup ? `<span class="ml-2 text-purple-600"><i class="fas fa-tag"></i> ${trade.setup}</span>` : ''}
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="${pnlColor} font-bold text-sm flex items-center justify-end gap-1">
                                    <i class="fas ${pnlIcon} text-xs"></i>
                                    $${Math.abs(trade.pnl).toFixed(2)}
                                </div>
                                <div class="text-xs text-gray-500 mt-1">
                                    ${trade.quantity} ${trade.quantity > 1 ? 'contracts' : 'contract'}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            console.log('üìã Recent Trades mis √† jour:', recentTrades.length, 'trades affich√©s');
        }

        function updateProtectionAnalysis() {
            console.log("  ‚Üí updateProtectionAnalysis() appel√©e");
            
            const container = document.getElementById('protectionAnalysisContainer');
            if (!container) return;
            
            // R√©cup√©rer les comptes actifs
            const activeAccounts = accounts.filter(a => a.active).map(a => a.id);
            let filteredTrades = activeAccounts.length > 0 
                ? trades.filter(trade => activeAccounts.includes(trade.accountId))
                : trades;
            
            if (filteredTrades.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-6">
                        <i class="fas fa-chart-bar text-3xl mb-2"></i>
                        <p class="text-sm">Aucune donn√©e disponible</p>
                    </div>
                `;
                return;
            }
            
            // Analyser chaque type de protection
            const protectionTypes = ['VWAP', 'MM20', 'Pivot', 'Cl√¥ture veille', 'Liquidit√© 30m/H1/H4'];
            const protectionStats = {};
            
            protectionTypes.forEach(protType => {
                // Filtrer les trades qui utilisent cette protection
                const tradesWithProt = filteredTrades.filter(trade => 
                    trade.protections && trade.protections.includes(protType)
                );
                
                if (tradesWithProt.length > 0) {
                    const winners = tradesWithProt.filter(t => t.pnl > 0);
                    const losers = tradesWithProt.filter(t => t.pnl < 0);
                    const winRate = (winners.length / tradesWithProt.length) * 100;
                    const totalPnl = tradesWithProt.reduce((sum, t) => sum + t.pnl, 0);
                    
                    protectionStats[protType] = {
                        total: tradesWithProt.length,
                        winners: winners.length,
                        losers: losers.length,
                        winRate: winRate,
                        totalPnl: totalPnl,
                        avgPnl: totalPnl / tradesWithProt.length
                    };
                }
            });
            
            // Ajouter l'analyse des trades SANS protection
            const tradesWithoutProt = filteredTrades.filter(trade => 
                !trade.protections || trade.protections.length === 0
            );
            
            if (tradesWithoutProt.length > 0) {
                const winners = tradesWithoutProt.filter(t => t.pnl > 0);
                const losers = tradesWithoutProt.filter(t => t.pnl < 0);
                const winRate = (winners.length / tradesWithoutProt.length) * 100;
                const totalPnl = tradesWithoutProt.reduce((sum, t) => sum + t.pnl, 0);
                
                protectionStats['Sans protection'] = {
                    total: tradesWithoutProt.length,
                    winners: winners.length,
                    losers: losers.length,
                    winRate: winRate,
                    totalPnl: totalPnl,
                    avgPnl: totalPnl / tradesWithoutProt.length
                };
            }
            
            // Si aucune protection utilis√©e
            if (Object.keys(protectionStats).length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-6">
                        <i class="fas fa-info-circle text-3xl mb-2"></i>
                        <p class="text-sm">Aucune protection utilis√©e dans les trades</p>
                    </div>
                `;
                return;
            }
            
            // G√©n√©rer le HTML pour chaque protection
            container.innerHTML = Object.entries(protectionStats)
                .sort((a, b) => b[1].winRate - a[1].winRate) // Trier par win rate d√©croissant
                .map(([protType, stats]) => {
                    const winRateColor = stats.winRate >= 60 ? 'text-green-600' : 
                                        stats.winRate >= 40 ? 'text-orange-500' : 'text-red-600';
                    const pnlColor = stats.totalPnl > 0 ? 'text-green-600' : 'text-red-600';
                    const bgColor = stats.totalPnl > 0 ? 'bg-green-50' : 'bg-red-50';
                    
                    // Ic√¥ne selon le type de protection
                    const icon = protType === 'VWAP' ? 'fa-chart-line' :
                                protType === 'MM20' ? 'fa-wave-square' :
                                protType === 'Pivot' ? 'fa-crosshairs' :
                                protType === 'Cl√¥ture veille' ? 'fa-history' :
                                protType === 'Liquidit√© 30m/H1/H4' ? 'fa-tint' :
                                'fa-ban'; // Sans protection
                    
                    return `
                        <div class="border-l-4 ${stats.totalPnl > 0 ? 'border-green-500' : 'border-red-500'} pl-3 py-3 ${bgColor} rounded-r">
                            <div class="flex justify-between items-center">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <i class="fas ${icon} text-purple-600"></i>
                                        <span class="font-semibold text-sm">${protType}</span>
                                        <span class="text-xs text-gray-500">${stats.total} trade${stats.total > 1 ? 's' : ''}</span>
                                    </div>
                                    <div class="flex items-center gap-3 text-xs">
                                        <div>
                                            <span class="text-gray-600">Win Rate:</span>
                                            <span class="${winRateColor} font-semibold ml-1">${stats.winRate.toFixed(1)}%</span>
                                        </div>
                                        <div class="text-gray-400">|</div>
                                        <div>
                                            <span class="text-green-600">${stats.winners}W</span>
                                            <span class="text-gray-400 mx-1">/</span>
                                            <span class="text-red-600">${stats.losers}L</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="${pnlColor} font-bold text-sm">
                                        ${stats.totalPnl > 0 ? '+' : ''}$${stats.totalPnl.toFixed(2)}
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">
                                        Avg: ${stats.avgPnl > 0 ? '+' : ''}$${stats.avgPnl.toFixed(2)}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Barre de progression du Win Rate -->
                            <div class="mt-2">
                                <div class="w-full bg-gray-200 rounded-full h-1.5">
                                    <div class="h-1.5 rounded-full ${stats.winRate >= 60 ? 'bg-green-500' : stats.winRate >= 40 ? 'bg-orange-500' : 'bg-red-500'}" 
                                         style="width: ${stats.winRate}%"></div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            
            console.log('üõ°Ô∏è Protection Analysis mis √† jour:', Object.keys(protectionStats).length, 'protections analys√©es');
        }

        function updateCalendarDisplay() {
            calendarDisplay.showPnl = document.getElementById('showPnl').checked;
            calendarDisplay.showTradeCount = document.getElementById('showTradeCount').checked;
            calendarDisplay.showWinRate = document.getElementById('showWinRate').checked;
            
            // Sauvegarder les pr√©f√©rences
            localStorage.setItem('calendarDisplay', JSON.stringify(calendarDisplay));
            
            // Rafra√Æchir le calendrier
            updateCalendar();
        }
        
        // Charger les pr√©f√©rences au d√©marrage
        function loadCalendarPreferences() {
            const saved = localStorage.getItem('calendarDisplay');
            if (saved) {
                calendarDisplay = JSON.parse(saved);
                document.getElementById('showPnl').checked = calendarDisplay.showPnl;
                document.getElementById('showTradeCount').checked = calendarDisplay.showTradeCount;
                document.getElementById('showWinRate').checked = calendarDisplay.showWinRate;
            }
        }

        // Charts functions
        function initCharts() {
            initTraderScoreChart();
            initTradeTimeChart();
            initDailyPnlChart();
            initCumulativePnlChart();
            initDrawdownChart();
            initDurationChart();
            updateCharts();
        }

        function initTraderScoreChart() {
            if (traderScoreChart) traderScoreChart.destroy();
            const ctx = document.getElementById('traderScoreChart').getContext('2d');
            traderScoreChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Win %', 'Consistency', 'Profit factor', 'Max drawdown', 'Avg win/loss', 'Recovery factor'],
                    datasets: [{
                        label: 'Trader 360 Score',
                        data: [75, 68, 82, 45, 70, 60],
                        backgroundColor: 'rgba(172, 134, 43, 0.2)',
                        borderColor: '#ac862b',
                        borderWidth: 2,
                        pointBackgroundColor: '#ac862b',
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                color: 'rgba(0, 11, 37, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        function initTradeTimeChart() {
            if (tradeTimeChart) tradeTimeChart.destroy();
            const ctx = document.getElementById('tradeTimeChart').getContext('2d');
            tradeTimeChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Winning Trades',
                        data: generateScatterData(20, true),
                        backgroundColor: '#10b981',
                        pointRadius: 3
                    }, {
                        label: 'Losing Trades',
                        data: generateScatterData(15, false),
                        backgroundColor: '#ef4444',
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'P&L'
                            }
                        }
                    }
                }
            });
        }

        function initDailyPnlChart() {
            const ctx = document.getElementById('dailyPnlChart').getContext('2d');
            dailyPnlChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: generateDateLabels(30),
                    datasets: [{
                        data: generateDailyPnlData(30),
                        backgroundColor: function(context) {
                            const value = context.parsed.y;
                            return value >= 0 ? '#10b981' : '#ef4444';
                        },
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function initCumulativePnlChart() {
            const ctx = document.getElementById('cumulativePnlChart').getContext('2d');
            cumulativePnlChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: generateDateLabels(30),
                    datasets: [{
                        data: generateCumulativeData(30),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function initDrawdownChart() {
            const ctx = document.getElementById('drawdownChart').getContext('2d');
            drawdownChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: generateDateLabels(30),
                    datasets: [{
                        data: generateDrawdownData(30),
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            max: 0
                        }
                    }
                }
            });
        }

        function updateDrawdownChart(filteredTrades) {
            if (!drawdownChart || filteredTrades.length === 0) return;
            
            // Trier les trades par date
            const sortedTrades = [...filteredTrades].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Calculer le P&L cumul√© et le drawdown
            let cumulativePnl = 0;
            let peak = 0;
            const drawdowns = [];
            const dates = [];
            
            sortedTrades.forEach(trade => {
                cumulativePnl += trade.pnl;
                
                // Mettre √† jour le pic si on atteint un nouveau sommet
                if (cumulativePnl > peak) {
                    peak = cumulativePnl;
                }
                
                // Calculer le drawdown (toujours n√©gatif ou z√©ro)
                const drawdown = cumulativePnl - peak;
                
                drawdowns.push(drawdown);
                dates.push(trade.date);
            });
            
            // Mettre √† jour le graphique
            drawdownChart.data.labels = dates;
            drawdownChart.data.datasets[0].data = drawdowns;
            drawdownChart.update();
            
            console.log('üìâ Drawdown mis √† jour:', drawdowns.length, 'points');
        }

        function initDurationChart() {
            const ctx = document.getElementById('durationChart').getContext('2d');
            durationChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Winning Trades',
                        data: generateDurationData(20, true),
                        backgroundColor: '#10b981',
                        pointRadius: 3
                    }, {
                        label: 'Losing Trades',
                        data: generateDurationData(15, false),
                        backgroundColor: '#ef4444',
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Duration (minutes)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'P&L'
                            }
                        }
                    }
                }
            });
        }

        function updateCharts() {
            console.log("  ‚Üí updateCharts() appel√©e");
            // Si aucun compte actif, utiliser tous les trades
            const activeAccounts = accounts.filter(a => a.active).map(a => a.id);
            const filteredTrades = activeAccounts.length === 0 
                ? trades 
                : trades.filter(trade => activeAccounts.includes(trade.accountId));
            
            console.log('üìà updateCharts - Trades filtr√©s:', filteredTrades.length, 'sur', trades.length, 'total');
            
            if (filteredTrades.length === 0) {
                // Pas de donn√©es, r√©initialiser
                if (document.getElementById('traderScore')) {
                    document.getElementById('traderScore').textContent = '0.0';
                }
                return;
            }
            
            // 1. TRADER 360 SCORE
            updateTraderScoreChart(filteredTrades);
            
            // 2. TRADE TIME PERFORMANCE
            updateTradeTimeChart(filteredTrades);
            
            // 3. DAILY PNL
            updateDailyPnlChart(filteredTrades);
            
            // 4. CUMULATIVE PNL
            updateCumulativePnlChart(filteredTrades);
            
            // 5. DRAWDOWN
            updateDrawdownChart(filteredTrades);
            
            // 6. TRADE DURATION
            updateDurationChart(filteredTrades);
        }
        
        // ==========================================
        // FONCTIONS DE MISE √Ä JOUR DES GRAPHIQUES
        // ==========================================
        
        function updateTraderScoreChart(filteredTrades) {
            if (!traderScoreChart) return;
            
            if (filteredTrades.length === 0) {
                traderScoreChart.data.datasets[0].data = [0, 0, 0, 0, 0, 0];
                traderScoreChart.update();
                if (document.getElementById('traderScore')) {
                    document.getElementById('traderScore').textContent = '0.0';
                }
                return;
            }
            
            const winningTrades = filteredTrades.filter(t => t.pnl > 0);
            const losingTrades = filteredTrades.filter(t => t.pnl < 0);
            
            // 1. WIN RATE (0-100)
            const winRate = filteredTrades.length > 0 
                ? (winningTrades.length / filteredTrades.length) * 100 
                : 0;
            
            // 2. PROFIT FACTOR (normalis√© sur 100)
            const grossProfit = winningTrades.reduce((sum, t) => sum + t.pnl, 0);
            const grossLoss = Math.abs(losingTrades.reduce((sum, t) => sum + t.pnl, 0));
            const profitFactor = grossLoss > 0 ? grossProfit / grossLoss : (grossProfit > 0 ? 3 : 0);
            const profitFactorScore = Math.min(100, (profitFactor / 3) * 100); // PF de 3+ = 100 points
            
            // 3. AVG WIN / AVG LOSS RATIO (normalis√© sur 100)
            const avgWin = winningTrades.length > 0 ? grossProfit / winningTrades.length : 0;
            const avgLoss = losingTrades.length > 0 ? grossLoss / losingTrades.length : 0;
            const avgRatio = avgLoss > 0 ? avgWin / avgLoss : (avgWin > 0 ? 2 : 0);
            const avgRatioScore = Math.min(100, (avgRatio / 2) * 100); // Ratio de 2+ = 100 points
            
            // 4. CONSISTENCY (√©cart-type du P&L normalis√©)
            const avgPnl = filteredTrades.reduce((sum, t) => sum + t.pnl, 0) / filteredTrades.length;
            const variance = filteredTrades.reduce((sum, t) => sum + Math.pow(t.pnl - avgPnl, 2), 0) / filteredTrades.length;
            const stdDev = Math.sqrt(variance);
            const cv = Math.abs(avgPnl) > 0 ? (stdDev / Math.abs(avgPnl)) : 0; // Coefficient de variation
            const consistencyScore = Math.max(0, 100 - (cv * 20)); // Moins de variance = meilleur score
            
            // 5. MAX DRAWDOWN (calcul√© sur cumulative PnL)
            let cumulativePnl = 0;
            let maxPnl = 0;
            let maxDrawdown = 0;
            filteredTrades.forEach(trade => {
                cumulativePnl += trade.pnl;
                maxPnl = Math.max(maxPnl, cumulativePnl);
                const drawdown = maxPnl - cumulativePnl;
                maxDrawdown = Math.max(maxDrawdown, drawdown);
            });
            const totalProfit = Math.abs(cumulativePnl);
            const drawdownPct = totalProfit > 0 ? (maxDrawdown / totalProfit) * 100 : 0;
            const drawdownScore = Math.max(0, 100 - drawdownPct); // Moins de drawdown = meilleur score
            
            // 6. RECOVERY FACTOR (Total Profit / Max Drawdown)
            const recoveryFactor = maxDrawdown > 0 ? totalProfit / maxDrawdown : (totalProfit > 0 ? 5 : 0);
            const recoveryScore = Math.min(100, (recoveryFactor / 5) * 100); // RF de 5+ = 100 points
            
            // SCORE GLOBAL (moyenne pond√©r√©e)
            const weights = {
                winRate: 0.20,          // 20%
                profitFactor: 0.25,     // 25%
                avgRatio: 0.20,         // 20%
                consistency: 0.15,      // 15%
                drawdown: 0.10,         // 10%
                recovery: 0.10          // 10%
            };
            
            const globalScore = (
                winRate * weights.winRate +
                profitFactorScore * weights.profitFactor +
                avgRatioScore * weights.avgRatio +
                consistencyScore * weights.consistency +
                drawdownScore * weights.drawdown +
                recoveryScore * weights.recovery
            );
            
            // Mettre √† jour le graphique radar
            traderScoreChart.data.datasets[0].data = [
                winRate.toFixed(1),              // Win %
                consistencyScore.toFixed(1),     // Consistency
                profitFactorScore.toFixed(1),    // Profit Factor
                drawdownScore.toFixed(1),        // Max Drawdown
                avgRatioScore.toFixed(1),        // Avg Win/Loss
                recoveryScore.toFixed(1)         // Recovery Factor
            ];
            traderScoreChart.update();
            
            // Afficher le score global
            if (document.getElementById('traderScore')) {
                document.getElementById('traderScore').textContent = globalScore.toFixed(1);
            }
            
            console.log('üìä Trader 360 Score D√©tails:');
            console.log('  Win Rate:', winRate.toFixed(1) + '%');
            console.log('  Profit Factor:', profitFactor.toFixed(2), '‚Üí', profitFactorScore.toFixed(1) + ' pts');
            console.log('  Avg Ratio:', avgRatio.toFixed(2), '‚Üí', avgRatioScore.toFixed(1) + ' pts');
            console.log('  Consistency:', consistencyScore.toFixed(1) + ' pts');
            console.log('  Drawdown:', drawdownPct.toFixed(1) + '%', '‚Üí', drawdownScore.toFixed(1) + ' pts');
            console.log('  Recovery:', recoveryFactor.toFixed(2), '‚Üí', recoveryScore.toFixed(1) + ' pts');
            console.log('  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('  üéØ SCORE GLOBAL:', globalScore.toFixed(1) + '/100');
        }
        
        function updateTradeTimeChart(filteredTrades) {
            if (!tradeTimeChart) return;
            
            // Grouper les trades par heure
            const tradesByHour = {};
            filteredTrades.forEach(trade => {
                if (trade.entryTime) {
                    const hour = parseInt(trade.entryTime.split(':')[0]);
                    if (!tradesByHour[hour]) {
                        tradesByHour[hour] = { wins: 0, losses: 0, pnl: 0 };
                    }
                    if (trade.pnl > 0) {
                        tradesByHour[hour].wins++;
                    } else {
                        tradesByHour[hour].losses++;
                    }
                    tradesByHour[hour].pnl += trade.pnl;
                }
            });
            
            // Pr√©parer les donn√©es pour le scatter plot
            const winData = [];
            const lossData = [];
            
            Object.keys(tradesByHour).forEach(hour => {
                const hourData = tradesByHour[hour];
                if (hourData.wins > 0) {
                    winData.push({ x: parseInt(hour), y: hourData.pnl > 0 ? hourData.pnl : 100 });
                }
                if (hourData.losses > 0) {
                    lossData.push({ x: parseInt(hour), y: hourData.pnl < 0 ? hourData.pnl : -100 });
                }
            });
            
            tradeTimeChart.data.datasets[0].data = winData;
            tradeTimeChart.data.datasets[1].data = lossData;
            tradeTimeChart.update();
        }
        
        function updateDailyPnlChart(filteredTrades) {
            if (!dailyPnlChart) return;
            
            // Grouper les trades par jour
            const tradesByDay = {};
            filteredTrades.forEach(trade => {
                const date = trade.date;
                if (!tradesByDay[date]) {
                    tradesByDay[date] = 0;
                }
                tradesByDay[date] += trade.pnl;
            });
            
            // Trier les dates
            const sortedDates = Object.keys(tradesByDay).sort();
            const labels = sortedDates.map(date => {
                const d = new Date(date);
                return `${d.getMonth()+1}/${d.getDate()}`;
            });
            
            const data = sortedDates.map(date => tradesByDay[date]);
            
            // Couleurs : vert si positif, rouge si n√©gatif
            const backgroundColors = data.map(pnl => pnl >= 0 ? '#10b981' : '#ef4444');
            
            dailyPnlChart.data.labels = labels;
            dailyPnlChart.data.datasets[0].data = data;
            dailyPnlChart.data.datasets[0].backgroundColor = backgroundColors;
            dailyPnlChart.update();
        }
        
        function updateCumulativePnlChart(filteredTrades) {
            if (!cumulativePnlChart) return;
            
            // Trier les trades par date
            const sortedTrades = [...filteredTrades].sort((a, b) => 
                new Date(a.date) - new Date(b.date)
            );
            
            // Calculer le P&L cumulatif
            let cumulative = 0;
            const cumulativeData = [];
            const labels = [];
            
            sortedTrades.forEach((trade, index) => {
                cumulative += trade.pnl;
                cumulativeData.push(cumulative);
                const d = new Date(trade.date);
                labels.push(`${d.getMonth()+1}/${d.getDate()}`);
            });
            
            cumulativePnlChart.data.labels = labels;
            cumulativePnlChart.data.datasets[0].data = cumulativeData;
            cumulativePnlChart.update();
        }
        
        function updateDurationChart(filteredTrades) {
            if (!durationChart) return;
            
            const winData = [];
            const lossData = [];
            
            console.log('‚è±Ô∏è DEBUG Duration - Nombre de trades:', filteredTrades.length);
            
            filteredTrades.forEach((trade, index) => {
                // Calculer la vraie dur√©e en minutes si entryTime et exitTime existent
                let durationMinutes = 30; // Dur√©e par d√©faut
                
                console.log(`Trade ${index}:`, {
                    date: trade.date,
                    entryTime: trade.entryTime,
                    exitTime: trade.exitTime,
                    hasEntry: !!trade.entryTime,
                    hasExit: !!trade.exitTime
                });
                
                if (trade.entryTime && trade.exitTime) {
                    const [entryHour, entryMin] = trade.entryTime.split(':').map(Number);
                    const [exitHour, exitMin] = trade.exitTime.split(':').map(Number);
                    
                    const entryTotalMin = entryHour * 60 + entryMin;
                    const exitTotalMin = exitHour * 60 + exitMin;
                    
                    durationMinutes = exitTotalMin - entryTotalMin;
                    
                    // G√©rer le cas o√π le trade traverse minuit
                    if (durationMinutes < 0) {
                        durationMinutes += 24 * 60; // Ajouter 24 heures
                    }
                    
                    console.log(`  ‚Üí Dur√©e calcul√©e: ${durationMinutes} min (${entryHour}:${entryMin} ‚Üí ${exitHour}:${exitMin})`);
                } else {
                    console.log(`  ‚Üí Dur√©e par d√©faut: 30 min (exitTime manquant)`);
                }
                
                // Cr√©er le point de donn√©es
                const dataPoint = { x: durationMinutes, y: trade.pnl };
                
                if (trade.pnl > 0) {
                    winData.push(dataPoint);
                } else if (trade.pnl < 0) {
                    lossData.push(dataPoint);
                }
            });
            
            durationChart.data.datasets[0].data = winData;
            durationChart.data.datasets[1].data = lossData;
            durationChart.update();
            
            console.log('‚è±Ô∏è Duration chart mis √† jour:', winData.length, 'gagnants,', lossData.length, 'perdants');
        }

        function calculateProfitFactor(trades) {
            const winningTrades = trades.filter(t => t.pnl > 0);
            const losingTrades = trades.filter(t => t.pnl < 0);
            
            const grossProfit = winningTrades.reduce((sum, trade) => sum + trade.pnl, 0);
            const grossLoss = Math.abs(losingTrades.reduce((sum, trade) => sum + trade.pnl, 0));
            
            return grossLoss > 0 ? grossProfit / grossLoss : grossProfit > 0 ? 99.99 : 0;
        }

        // Helper functions for generating chart data
        function generateScatterData(count, isWinning) {
            const data = [];
            for (let i = 0; i < count; i++) {
                data.push({
                    x: Math.random() * 24,
                    y: isWinning ? Math.random() * 2000 + 100 : -(Math.random() * 1500 + 100)
                });
            }
            return data;
        }

        function generateDurationData(count, isWinning) {
            const data = [];
            for (let i = 0; i < count; i++) {
                data.push({
                    x: Math.random() * 120 + 5,
                    y: isWinning ? Math.random() * 2000 + 100 : -(Math.random() * 1500 + 100)
                });
            }
            return data;
        }

        function generateDateLabels(days) {
            const labels = [];
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                // Format DD/MM/YYYY pour la France
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                labels.push(`${day}/${month}/${year}`);
            }
            return labels;
        }

        function generateDailyPnlData(days) {
            const filteredTrades = getFilteredTrades();
            const labels = generateDateLabels(days);
            const data = [];
            
            // Pour chaque date, calculer le P&L total de la journ√©e
            labels.forEach(label => {
                // Convertir le label en format YYYY-MM-DD pour comparaison
                const labelDate = parseLabelToDate(label);
                
                // Filtrer les trades de cette date
                const dayTrades = filteredTrades.filter(trade => {
                    return trade.date === labelDate;
                });
                
                // Calculer le P&L total du jour
                const dayPnl = dayTrades.reduce((sum, trade) => sum + (trade.pnl || 0), 0);
                data.push(dayPnl);
            });
            
            return data;
        }
        
        function parseLabelToDate(label) {
            // Convertir "13/11/2024" en "2024-11-13"
            const parts = label.split('/');
            if (parts.length === 3) {
                const day = parts[0].padStart(2, '0');
                const month = parts[1].padStart(2, '0');
                const year = parts[2];
                return `${year}-${month}-${day}`;
            }
            return label;
        }

        function generateCumulativeData(days) {
            const dailyPnl = generateDailyPnlData(days);
            const data = [];
            let cumulative = 0;
            
            dailyPnl.forEach(pnl => {
                cumulative += pnl;
                data.push(cumulative);
            });
            
            return data;
        }

        function generateDrawdownData(days) {
            const cumulativeData = generateCumulativeData(days);
            const data = [];
            let peak = 0;
            
            cumulativeData.forEach(current => {
                if (current > peak) peak = current;
                const drawdown = current - peak;
                data.push(Math.min(0, drawdown));
            });
            
            return data;
        }

        // Storage functions
        function saveToStorage() {
            // Si utilisateur connect√©, sauvegarder ses donn√©es sp√©cifiques
            if (currentUser && currentUser.role === 'student') {
                saveUserData(currentUser.id);
                console.log('‚úÖ Donn√©es utilisateur sauvegard√©es:', trades.length, 'trades,', accounts.length, 'comptes');
            } else {
                // Sauvegarde g√©n√©rique (compatibilit√© ancienne version)
                const userData = {
                    trades: trades,
                    journalEntries: journalEntries,
                    accounts: accounts,
                    accountCosts: accountCosts,
                    payouts: payouts
                };
                localStorage.setItem('trader360_data', JSON.stringify(userData));
                console.log('‚úÖ Donn√©es sauvegard√©es (mode compatibilit√©)');
            }
        }

        function loadFromStorage() {
            // Charger depuis la cl√© simple
            const userData = localStorage.getItem('trader360_data');
            
            if (userData) {
                try {
                    const parsed = JSON.parse(userData);
                    trades = parsed.trades || [];
                    journalEntries = parsed.journalEntries || [];
                    accounts = parsed.accounts || [];
                    accountCosts = parsed.accountCosts || [];
                    payouts = parsed.payouts || [];
                    console.log('‚úÖ Donn√©es charg√©es:', trades.length, 'trades,', accounts.length, 'comptes,', accountCosts.length, 'co√ªts,', payouts.length, 'payouts');
                    
                    // DEBUG: Verification exitTime dans les trades charg√©s
                    if (trades.length > 0) {
                        console.log('DEBUG loadFromStorage - Premier trade:', {
                            id: trades[0].id,
                            entryTime: trades[0].entryTime,
                            exitTime: trades[0].exitTime,
                            hasExitTime: !!trades[0].exitTime
                        });
                        console.log('DEBUG loadFromStorage - Dernier trade:', {
                            id: trades[trades.length-1].id,
                            entryTime: trades[trades.length-1].entryTime,
                            exitTime: trades[trades.length-1].exitTime,
                            hasExitTime: !!trades[trades.length-1].exitTime
                        });
                    }
                } catch (e) {
                    console.error('‚ùå Erreur chargement:', e);
                }
            } else {
                // Essayer de charger depuis les cl√©s individuelles (compatibilit√©)
                trades = JSON.parse(localStorage.getItem('trades') || '[]');
                accounts = JSON.parse(localStorage.getItem('accounts') || '[]');
                journalEntries = JSON.parse(localStorage.getItem('journalEntries') || '[]');
                console.log('üîÑ Charg√© depuis cl√©s individuelles:', trades.length, 'trades');
            }
        }

        // ===== FONCTIONS MULTI-UTILISATEURS =====
        
        function loadAllUsers() {
            const usersData = localStorage.getItem('club_trader_360_users');
            allUsers = usersData ? JSON.parse(usersData) : [];
            return allUsers;
        }
        
        function saveAllUsers() {
            localStorage.setItem('club_trader_360_users', JSON.stringify(allUsers));
        }
        
        function loadUserData(userId) {
            const userDataKey = `club_trader_360_user_${userId}_data`;
            const userData = localStorage.getItem(userDataKey);
            
            if (userData) {
                try {
                    const parsed = JSON.parse(userData);
                    trades = parsed.trades || [];
                    journalEntries = parsed.journalEntries || [];
                    accounts = parsed.accounts || [];
                    accountCosts = parsed.accountCosts || [];
                    payouts = parsed.payouts || [];
                    console.log(`‚úÖ Donn√©es utilisateur ${userId} charg√©es:`, trades.length, 'trades');
                } catch (e) {
                    console.error('‚ùå Erreur chargement donn√©es utilisateur:', e);
                    // Initialiser avec donn√©es vides
                    trades = [];
                    journalEntries = [];
                    accounts = [];
                    accountCosts = [];
                    payouts = [];
                }
            } else {
                // Premi√®re connexion - initialiser avec donn√©es vides
                trades = [];
                journalEntries = [];
                accounts = [];
                accountCosts = [];
                payouts = [];
                console.log('üÜï Nouvel utilisateur - donn√©es initialis√©es');
            }
        }
        
        function saveUserData(userId) {
            const userDataKey = `club_trader_360_user_${userId}_data`;
            const userData = {
                trades: trades,
                journalEntries: journalEntries,
                accounts: accounts,
                accountCosts: accountCosts,
                payouts: payouts
            };
                    }
        
        function getAllStudentsData() {
            // Fonction pour le coach : r√©cup√©rer toutes les donn√©es de tous les √©l√®ves actifs
                        loadAllUsers();
            const activeStudents = allUsers.filter(u => u.role === 'student' && u.status === 'active');
            console.log('üîç √âl√®ves actifs trouv√©s:', activeStudents.length);
            
            const allStudentsData = [];
            activeStudents.forEach(student => {
                const userDataKey = `club_trader_360_user_${student.id}_data`;
                                                const userData = localStorage.getItem(userDataKey);
                                
                if (userData) {
                    try {
                        const parsed = JSON.parse(userData);
                                                allStudentsData.push({
                            user: student,
                            data: parsed
                        });
                    } catch (e) {
                        console.error(`‚ùå Erreur chargement donn√©es √©l√®ve ${student.email}:`, e);
                    }
                } else {
                    }
            });
            
            console.log('üîç Total √©l√®ves avec donn√©es:', allStudentsData.length);
            return allStudentsData;
        }
        
        // ===== FONCTIONS INTERFACE COACH =====
        
        function showCoachSection(sectionName) {
            // Masquer toutes les sections
            document.querySelectorAll('#coachApp .section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // D√©sactiver tous les items du menu
            document.querySelectorAll('#coachApp .sidebar-item').forEach(item => {
                item.classList.remove('coach-active');
            });
            
            // Afficher la section demand√©e
            document.getElementById(sectionName).classList.remove('hidden');
            
            // Activer l'item du menu correspondant
            const navId = 'coachNav' + sectionName.replace('coach', '');
            const navItem = document.getElementById(navId);
            if (navItem) {
                navItem.classList.add('coach-active');
            }
            
            // Charger les donn√©es de la section
            if (sectionName === 'coachDashboard') {
                loadCoachDashboard();
            } else if (sectionName === 'coachStudents') {
                loadCoachStudents();
            } else if (sectionName === 'coachAccounting') {
                loadCoachAccounting();
            } else if (sectionName === 'coachRegistrations') {
                loadCoachRegistrations();
            }
        }
        
        function loadCoachDashboard() {
            console.log('üìä Chargement dashboard coach...');
            const studentsData = getAllStudentsData();
            
            // Calculer les stats globales
            let totalTrades = 0;
            let totalWins = 0;
            let totalLosses = 0;
            let totalPnL = 0;
            
            studentsData.forEach(studentData => {
                const trades = studentData.data.trades || [];
                totalTrades += trades.length;
                totalWins += trades.filter(t => t.pnl > 0).length;
                totalLosses += trades.filter(t => t.pnl < 0).length;
                totalPnL += trades.reduce((sum, t) => sum + (t.pnl || 0), 0);
            });
            
            const globalWinRate = totalTrades > 0 ? ((totalWins / totalTrades) * 100).toFixed(1) : 0;
            
            // Mettre √† jour le banner
            document.getElementById('coachTotalStudents').textContent = studentsData.length;
            document.getElementById('coachGlobalWinRate').textContent = globalWinRate + '%';
            document.getElementById('coachTotalTrades').textContent = totalTrades;
            document.getElementById('coachTotalWins').textContent = totalWins;
            document.getElementById('coachTotalLosses').textContent = totalLosses;
            
            // Mettre √† jour P&L avec couleur
            const pnlElement = document.getElementById('coachGlobalPnL');
            if (pnlElement) {
                pnlElement.textContent = '$' + totalPnL.toFixed(2);
                pnlElement.style.color = totalPnL < 0 ? '#ef4444' : '#10b981'; // Rouge si n√©gatif, vert sinon
            }
            
            // Mettre √† jour la barre de win rate
            const winRateBar = document.getElementById('coachWinRateBar');
            if (winRateBar) {
                winRateBar.style.width = globalWinRate + '%';
            }
            
            // G√©n√©rer le tableau breakdown par √©l√®ve
            if (studentsData.length === 0) {
                document.getElementById('coachStudentsBreakdown').innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center text-gray-500">Aucun √©l√®ve actif</td>
                    </tr>
                `;
            } else {
                const breakdownHTML = studentsData.map(studentData => {
                    const student = studentData.user;
                    const trades = studentData.data.trades || [];
                    const accounts = studentData.data.accounts || [];
                    const wins = trades.filter(t => t.pnl > 0).length;
                    const winRate = trades.length > 0 ? ((wins / trades.length) * 100).toFixed(1) : 0;
                    const pnl = trades.reduce((sum, t) => sum + (t.pnl || 0), 0);
                    const avgPnL = trades.length > 0 ? (pnl / trades.length).toFixed(2) : 0;
                    
                    return `
                        <tr class="border-b border-gray-200 hover:bg-gray-50 transition-colors">
                            <td class="px-6 py-4">
                                <div class="font-semibold">${student.name}</div>
                                <div class="text-sm text-gray-600">${student.email}</div>
                            </td>
                            <td class="px-6 py-4">
                                <span class="text-gray-700">${accounts.length}</span>
                            </td>
                            <td class="px-6 py-4">
                                <span class="font-semibold">${trades.length}</span>
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex items-center">
                                    <span class="font-semibold text-green-600">${winRate}%</span>
                                    <div class="ml-2 w-16 h-2 bg-gray-200 rounded-full overflow-hidden">
                                        <div class="h-full bg-green-500" style="width: ${winRate}%"></div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <span class="font-semibold ${pnl >= 0 ? 'text-green-600' : 'text-red-600'}">$${pnl.toFixed(2)}</span>
                            </td>
                            <td class="px-6 py-4">
                                <span class="${avgPnL >= 0 ? 'text-green-600' : 'text-red-600'}">$${avgPnL}</span>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                document.getElementById('coachStudentsBreakdown').innerHTML = breakdownHTML;
            }
        }
        
        function loadCoachStudents() {
            console.log('üë• Chargement liste √©l√®ves...');
            const studentsData = getAllStudentsData();
            
            if (studentsData.length === 0) {
                document.getElementById('coachStudentsTable').innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-4 text-center text-gray-500">Aucun √©l√®ve actif</td>
                    </tr>
                `;
                return;
            }
            
            const tableHTML = studentsData.map(studentData => {
                const student = studentData.user;
                const trades = studentData.data.trades || [];
                const accounts = studentData.data.accounts || [];
                const wins = trades.filter(t => t.pnl > 0).length;
                const winRate = trades.length > 0 ? ((wins / trades.length) * 100).toFixed(1) : 0;
                const pnl = trades.reduce((sum, t) => sum + (t.pnl || 0), 0);
                
                return `
                    <tr class="border-b border-gray-200 hover:bg-gray-50">
                        <td class="px-6 py-4">
                            <div class="font-semibold">${student.name}</div>
                            <div class="text-sm text-gray-600">${student.email}</div>
                        </td>
                        <td class="px-6 py-4">${accounts.length} compte(s)</td>
                        <td class="px-6 py-4">
                            <span class="text-green-600 font-semibold">${winRate}%</span>
                        </td>
                        <td class="px-6 py-4">${trades.length}</td>
                        <td class="px-6 py-4">
                            <span class="${pnl >= 0 ? 'text-green-600' : 'text-red-600'} font-semibold">$${pnl.toFixed(2)}</span>
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 rounded text-xs bg-green-100 text-green-800">Actif</span>
                        </td>
                        <td class="px-6 py-4">
                            <button onclick="viewStudentDetails(${student.id})" class="text-blue-600 hover:text-blue-800 mr-2" title="Voir d√©tails">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="revokeStudent(${student.id})" class="text-orange-600 hover:text-orange-800 mr-2" title="Suspendre">
                                <i class="fas fa-ban"></i>
                            </button>
                            <button onclick="deleteStudent(${student.id})" class="text-red-600 hover:text-red-800" title="Supprimer">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('coachStudentsTable').innerHTML = tableHTML;
        }
        
        function loadCoachAccounting() {
            // Charger depuis Supabase au lieu de localStorage
            loadCoachAccountingFromSupabase();
            return; // Exit early - fonction Supabase g√®re tout
            
            // Code ancien (ne s'ex√©cute plus):
            const studentsData = getAllStudentsData();
            console.log('üí∞ Nombre d\'\u00e9tudiants actifs:', studentsData.length);
            
            let totalInvested = 0;
            let totalPayouts = 0;
            const studentAccountingData = [];
            const allCosts = [];
            const allPayouts = [];
            
            // Agr√©ger les donn√©es de tous les √©l√®ves
            studentsData.forEach(studentData => {
                const student = studentData.user;
                const costs = studentData.data.accountCosts || [];
                const payouts = studentData.data.payouts || [];
                
                if (costs.length > 0) {
                    console.log('üí∞ D√©tail des co√ªts:', costs);
                    costs.forEach((c, idx) => {
                        console.log(`  - Co√ªt ${idx + 1}:`, c);
                    });
                }
                                if (payouts.length > 0) {
                    console.log('üí∞ D√©tail des payouts:', payouts);
                    payouts.forEach((p, idx) => {
                        console.log(`  - Payout ${idx + 1}:`, p);
                    });
                }
                
                const studentTotalCosts = costs.reduce((sum, c) => sum + (c.cost || c.amount || 0), 0);
                const studentTotalPayouts = payouts.reduce((sum, p) => sum + (p.amount || 0), 0);
                
                totalInvested += studentTotalCosts;
                totalPayouts += studentTotalPayouts;
                
                // Ajouter au tableau de breakdown
                if (studentTotalCosts > 0 || studentTotalPayouts > 0) {
                    const balance = studentTotalPayouts - studentTotalCosts;
                    const roi = studentTotalCosts > 0 ? ((balance / studentTotalCosts) * 100).toFixed(1) : 0;
                    
                    studentAccountingData.push({
                        student: student,
                        costs: studentTotalCosts,
                        payouts: studentTotalPayouts,
                        balance: balance,
                        roi: roi
                    });
                }
                
                // Ajouter √† la liste globale avec nom √©l√®ve
                costs.forEach(cost => {
                    allCosts.push({
                        ...cost,
                        studentName: student.name
                    });
                });
                
                payouts.forEach(payout => {
                    allPayouts.push({
                        ...payout,
                        studentName: student.name
                    });
                });
            });
            
            const netProfit = totalPayouts - totalInvested;
            const globalROI = totalInvested > 0 ? ((netProfit / totalInvested) * 100).toFixed(1) : 0;
            
                        console.log('üí∞ Total investi:', totalInvested);
            console.log('üí∞ Total payouts:', totalPayouts);
            console.log('üí∞ B√©n√©fice net:', netProfit);
            console.log('üí∞ ROI global:', globalROI + '%');
            console.log('üí∞ Nombre de lignes breakdown √©l√®ves:', studentAccountingData.length);
            console.log('üí∞ Nombre total de co√ªts:', allCosts.length);
            console.log('üí∞ Nombre total de payouts:', allPayouts.length);
                        
            // Mettre √† jour les KPIs
            document.getElementById('coachTotalInvested').textContent = '$' + totalInvested.toFixed(2);
            document.getElementById('coachTotalPayouts').textContent = '$' + totalPayouts.toFixed(2);
            
            const netProfitEl = document.getElementById('coachNetProfit');
            netProfitEl.textContent = '$' + netProfit.toFixed(2);
            netProfitEl.style.color = netProfit >= 0 ? '#10b981' : '#dc2626';
            
            const netProfitIcon = document.getElementById('coachNetProfitIcon');
            if (netProfit >= 0) {
                netProfitIcon.style.backgroundColor = 'rgba(16, 185, 129, 0.1)';
                netProfitIcon.innerHTML = '<i class="fas fa-check" style="color: #10b981;"></i>';
            } else {
                netProfitIcon.style.backgroundColor = 'rgba(220, 38, 38, 0.1)';
                netProfitIcon.innerHTML = '<i class="fas fa-times" style="color: #dc2626;"></i>';
            }
            
            const roiEl = document.getElementById('coachROI');
            roiEl.textContent = globalROI + '%';
            roiEl.style.color = globalROI >= 0 ? '#10b981' : '#dc2626';
            
            // Remplir le tableau breakdown par √©l√®ve
            if (studentAccountingData.length === 0) {
                document.getElementById('coachAccountingBreakdown').innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-8 text-gray-500">
                            <i class="fas fa-inbox text-4xl mb-2 opacity-30"></i>
                            <p>Aucune donn√©e comptable</p>
                        </td>
                    </tr>
                `;
            } else {
                const breakdownHTML = studentAccountingData.map(data => `
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="py-3 px-4">
                            <div class="font-semibold">${data.student.name || data.student.email}</div>
                            <div class="text-sm text-gray-600">${data.student.email}</div>
                        </td>
                        <td class="py-3 px-4 text-right text-red-600 font-semibold">$${(data.costs || 0).toFixed(2)}</td>
                        <td class="py-3 px-4 text-right text-green-600 font-semibold">$${(data.payouts || 0).toFixed(2)}</td>
                        <td class="py-3 px-4 text-right font-semibold ${data.balance >= 0 ? 'text-green-600' : 'text-red-600'}">$${(data.balance || 0).toFixed(2)}</td>
                        <td class="py-3 px-4 text-right font-semibold ${data.roi >= 0 ? 'text-green-600' : 'text-red-600'}">${data.roi || 0}%</td>
                    </tr>
                `).join('');
                document.getElementById('coachAccountingBreakdown').innerHTML = breakdownHTML;
            }
            
            // Remplir le tableau des co√ªts
            if (allCosts.length === 0) {
                document.getElementById('coachAllCostsTable').innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center py-8 text-gray-500">
                            <i class="fas fa-inbox text-4xl mb-2 opacity-30"></i>
                            <p>Aucun co√ªt enregistr√©</p>
                        </td>
                    </tr>
                `;
            } else {
                // Trier par date
                allCosts.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                const costsHTML = allCosts.slice(0, 20).map(cost => `
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="py-3 px-2 text-sm">${cost.date || 'N/A'}</td>
                        <td class="py-3 px-2 text-sm">${cost.studentName || 'N/A'}</td>
                        <td class="py-3 px-2 text-sm">${cost.accountName || cost.name || 'N/A'}</td>
                        <td class="py-3 px-2 text-sm text-right text-red-600 font-semibold">$${(cost.cost || cost.amount || 0).toFixed(2)}</td>
                    </tr>
                `).join('');
                document.getElementById('coachAllCostsTable').innerHTML = costsHTML;
            }
            
            // Remplir le tableau des payouts
            if (allPayouts.length === 0) {
                document.getElementById('coachAllPayoutsTable').innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center py-8 text-gray-500">
                            <i class="fas fa-inbox text-4xl mb-2 opacity-30"></i>
                            <p>Aucun payout enregistr√©</p>
                        </td>
                    </tr>
                `;
            } else {
                // Trier par date
                allPayouts.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                const payoutsHTML = allPayouts.slice(0, 20).map(payout => `
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="py-3 px-2 text-sm">${payout.date || 'N/A'}</td>
                        <td class="py-3 px-2 text-sm">${payout.studentName || 'N/A'}</td>
                        <td class="py-3 px-2 text-sm">${payout.accountName || payout.account || 'N/A'}</td>
                        <td class="py-3 px-2 text-sm text-right text-green-600 font-semibold">$${(payout.amount || 0).toFixed(2)}</td>
                    </tr>
                `).join('');
                document.getElementById('coachAllPayoutsTable').innerHTML = payoutsHTML;
            }
        }
        
        function loadCoachRegistrations() {
            console.log('‚úÖ Chargement inscriptions...');
            // Charger depuis Supabase
            loadCoachRegistrationsFromSupabase();
            return; // Exit early
            
            // Code ancien:
            loadAllUsers();
            
            // Demandes en attente
            const pendingUsers = allUsers.filter(u => u.role === 'student' && u.status === 'pending');
            if (pendingUsers.length === 0) {
                document.getElementById('coachPendingUsers').innerHTML = `
                    <p class="text-gray-500 text-center py-4">Aucune demande en attente</p>
                `;
            } else {
                const pendingHTML = pendingUsers.map(user => `
                    <div class="border border-yellow-200 bg-yellow-50 rounded-lg p-4 mb-3">
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="font-semibold">${user.email}</div>
                                <div class="text-sm text-gray-600">Inscrit le ${new Date(user.createdAt).toLocaleDateString('fr-FR')}</div>
                            </div>
                            <div>
                                <button onclick="approveStudent(${user.id})" class="trader-btn mr-2">
                                    <i class="fas fa-check"></i> Valider
                                </button>
                                <button onclick="rejectStudent(${user.id})" class="trader-btn-secondary">
                                    <i class="fas fa-times"></i> Refuser
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
                document.getElementById('coachPendingUsers').innerHTML = pendingHTML;
            }
            
            // Tous les √©l√®ves
            const allStudents = allUsers.filter(u => u.role === 'student');
            if (allStudents.length === 0) {
                document.getElementById('coachAllUsers').innerHTML = `
                    <p class="text-gray-500 text-center py-4">Aucun √©l√®ve</p>
                `;
            } else {
                const allHTML = allStudents.map(user => {
                    let statusBadge = '';
                    if (user.status === 'active') {
                        statusBadge = '<span class="px-2 py-1 rounded text-xs bg-green-100 text-green-800">Actif</span>';
                    } else if (user.status === 'pending') {
                        statusBadge = '<span class="px-2 py-1 rounded text-xs bg-yellow-100 text-yellow-800">En attente</span>';
                    } else if (user.status === 'revoked') {
                        statusBadge = '<span class="px-2 py-1 rounded text-xs bg-orange-100 text-orange-800">Suspendu</span>';
                    }
                    
                    return `
                        <div class="border-b border-gray-200 py-3 flex justify-between items-center">
                            <div>
                                <div class="font-semibold">${user.email}</div>
                                <div class="text-sm text-gray-600">Inscrit le ${new Date(user.createdAt).toLocaleDateString('fr-FR')}</div>
                            </div>
                            <div class="flex items-center gap-3">
                                ${statusBadge}
                                ${user.status === 'revoked' ? `
                                    <button onclick="reactivateStudent(${user.id})" class="text-green-600 hover:text-green-800" title="R√©activer">
                                        <i class="fas fa-check-circle"></i>
                                    </button>
                                ` : ''}
                                ${user.status === 'active' ? `
                                    <button onclick="revokeStudent(${user.id})" class="text-orange-600 hover:text-orange-800" title="Suspendre">
                                        <i class="fas fa-ban"></i>
                                    </button>
                                ` : ''}
                                <button onclick="deleteStudent(${user.id})" class="text-red-600 hover:text-red-800" title="Supprimer">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
                document.getElementById('coachAllUsers').innerHTML = allHTML;
            }
        }
        
        function approveStudent(userId) {
            if (!confirm('Valider cette inscription ?')) return;
            
            loadAllUsers();
            const user = allUsers.find(u => u.id === userId);
            if (user) {
                user.status = 'active';
                saveAllUsers();
                alert(`‚úÖ √âl√®ve ${user.email} valid√© !`);
                loadCoachRegistrations();
            }
        }
        
        function rejectStudent(userId) {
            if (!confirm('Refuser cette inscription ? L\'utilisateur sera supprim√©.')) return;
            
            loadAllUsers();
            allUsers = allUsers.filter(u => u.id !== userId);
            saveAllUsers();
            alert('‚ùå Inscription refus√©e');
            loadCoachRegistrations();
        }
        
        function revokeStudent(userId) {
            if (!confirm('Suspendre l\'acc√®s de cet √©l√®ve ?')) return;
            
            loadAllUsers();
            const user = allUsers.find(u => u.id === userId);
            if (user) {
                user.status = 'revoked';
                saveAllUsers();
                alert(`‚õî Acc√®s suspendu pour ${user.email}`);
                loadCoachStudents();
                loadCoachRegistrations();
            }
        }
        
        function reactivateStudent(userId) {
            if (!confirm('R√©activer l\'acc√®s de cet √©l√®ve ?')) return;
            
            loadAllUsers();
            const user = allUsers.find(u => u.id === userId);
            if (user) {
                user.status = 'active';
                saveAllUsers();
                alert(`‚úÖ Acc√®s r√©activ√© pour ${user.email}`);
                loadCoachRegistrations();
            }
        }
        
        function deleteStudent(userId) {
            if (!confirm('‚ö†Ô∏è ATTENTION !\n\nSupprimer d√©finitivement cet √©l√®ve et toutes ses donn√©es ?\n\nCette action est IRR√âVERSIBLE !')) return;
            
            loadAllUsers();
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;
            
            // Supprimer l'utilisateur
            allUsers = allUsers.filter(u => u.id !== userId);
            saveAllUsers();
            
            // Supprimer ses donn√©es
            const userDataKey = `club_trader_360_user_${userId}_data`;
            localStorage.removeItem(userDataKey);
            
            alert(`üóëÔ∏è √âl√®ve ${user.email} supprim√© d√©finitivement`);
            loadCoachStudents();
            loadCoachRegistrations();
        }
        
        function viewStudentDetails(userId) {
            console.log('üëÅÔ∏è Affichage d√©tails √©l√®ve:', userId);
            
            // Charger les donn√©es de l'√©l√®ve
            loadAllUsers();
            const student = allUsers.find(u => u.id === userId);
            if (!student) {
                alert('‚ùå √âl√®ve non trouv√©');
                return;
            }
            
            // Charger les donn√©es de trading de l'√©l√®ve
            const userDataKey = `club_trader_360_user_${userId}_data`;
            const userData = localStorage.getItem(userDataKey);
            let studentTrades = [];
            let studentAccounts = [];
            
            if (userData) {
                try {
                    const parsed = JSON.parse(userData);
                    studentTrades = parsed.trades || [];
                    studentAccounts = parsed.accounts || [];
                } catch (e) {
                    console.error('Erreur chargement donn√©es √©l√®ve:', e);
                }
            }
            
            // Calculer les stats
            const totalTrades = studentTrades.length;
            const wins = studentTrades.filter(t => t.pnl > 0).length;
            const winRate = totalTrades > 0 ? ((wins / totalTrades) * 100).toFixed(1) : 0;
            const totalPnL = studentTrades.reduce((sum, t) => sum + (t.pnl || 0), 0);
            
            // Remplir le modal
            document.getElementById('studentDetailTitle').textContent = `D√©tails de ${student.name}`;
            document.getElementById('studentDetailEmail').textContent = student.email;
            document.getElementById('studentDetailCreatedAt').textContent = new Date(student.createdAt).toLocaleDateString('fr-FR');
            document.getElementById('studentDetailLastLogin').textContent = student.lastLogin ? new Date(student.lastLogin).toLocaleDateString('fr-FR') : 'Jamais';
            
            document.getElementById('studentDetailAccounts').textContent = studentAccounts.length;
            document.getElementById('studentDetailTrades').textContent = totalTrades;
            document.getElementById('studentDetailWinRate').textContent = winRate + '%';
            
            const pnlElement = document.getElementById('studentDetailPnL');
            pnlElement.textContent = '$' + totalPnL.toFixed(2);
            pnlElement.style.color = totalPnL < 0 ? '#ef4444' : '#10b981';
            
            // Afficher les comptes
            if (studentAccounts.length === 0) {
                document.getElementById('studentDetailAccountsList').innerHTML = `
                    <p class="text-gray-500">Aucun compte</p>
                `;
            } else {
                const accountsHTML = studentAccounts.map(account => `
                    <div class="inline-flex items-center mr-4 mb-2 px-3 py-2 rounded" style="background-color: ${account.color}20; border: 1px solid ${account.color};">
                        <div class="w-2 h-2 rounded-full mr-2" style="background-color: ${account.color};"></div>
                        <span class="font-semibold" style="color: ${account.color};">${account.name}</span>
                        <span class="text-gray-600 ml-2">(${formatAccountSize(account.size)})</span>
                    </div>
                `).join('');
                document.getElementById('studentDetailAccountsList').innerHTML = accountsHTML;
            }
            
            // Afficher les trades
            if (studentTrades.length === 0) {
                document.getElementById('studentDetailTradesTable').innerHTML = `
                    <tr>
                        <td colspan="9" class="px-4 py-8 text-center text-gray-500">Aucun trade</td>
                    </tr>
                `;
            } else {
                // Trier par date (plus r√©cent en premier)
                const sortedTrades = [...studentTrades].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                const tradesHTML = sortedTrades.slice(0, 50).map(trade => { // Limiter √† 50 trades
                    const pnlClass = trade.pnl >= 0 ? 'text-green-600' : 'text-red-600';
                    const typeClass = trade.type === 'Long' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                    
                    return `
                        <tr class="border-b border-gray-200 hover:bg-gray-50">
                            <td class="px-4 py-3 text-sm">${trade.date}</td>
                            <td class="px-4 py-3 text-sm">${trade.accountName || '-'}</td>
                            <td class="px-4 py-3 text-sm font-medium">${trade.symbol}</td>
                            <td class="px-4 py-3 text-sm">
                                <span class="px-2 py-1 rounded text-xs ${typeClass}">${trade.type}</span>
                            </td>
                            <td class="px-4 py-3 text-sm">$${trade.entryPrice}</td>
                            <td class="px-4 py-3 text-sm">$${trade.exitPrice}</td>
                            <td class="px-4 py-3 text-sm">${trade.quantity}</td>
                            <td class="px-4 py-3 text-sm font-semibold ${pnlClass}">$${trade.pnl.toFixed(2)}</td>
                            <td class="px-4 py-3 text-sm">${trade.setup || '-'}</td>
                        </tr>
                    `;
                }).join('');
                
                document.getElementById('studentDetailTradesTable').innerHTML = tradesHTML;
            }
            
            // Ouvrir le modal
            document.getElementById('studentDetailModal').style.display = 'block';
        }
        
        function closeStudentDetail() {
            document.getElementById('studentDetailModal').style.display = 'none';
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    
        
        // Fonction pour voir les d√©tails d'un trade
        function viewTrade(tradeId) {
            const trade = trades.find(t => t.id === tradeId);
            if (!trade) {
                alert('Trade non trouv√©');
                return;
            }
            
            const account = accounts.find(a => a.id === trade.accountId);
            const pnlClass = trade.pnl >= 0 ? 'text-green-600' : 'text-red-600';
            
            let html = `
                <div class="view-modal-section">
                    <span class="view-modal-label">Compte</span>
                    <div class="view-modal-value">
                        <span class="px-3 py-1 rounded" style="background-color: ${account?.color}20; color: ${account?.color}">
                            ${trade.accountName}
                        </span>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="view-modal-section">
                        <span class="view-modal-label">Date</span>
                        <div class="view-modal-value">${trade.date}</div>
                    </div>
                    <div class="view-modal-section">
                        <span class="view-modal-label">Symbole</span>
                        <div class="view-modal-value">${trade.symbol}</div>
                    </div>
                </div>
            `;
            
            if (trade.entryTime || trade.exitTime) {
                html += `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        ${trade.entryTime ? `
                            <div class="view-modal-section">
                                <span class="view-modal-label">Heure d'entr√©e</span>
                                <div class="view-modal-value">${trade.entryTime}</div>
                            </div>
                        ` : ''}
                        ${trade.exitTime ? `
                            <div class="view-modal-section">
                                <span class="view-modal-label">Heure de sortie</span>
                                <div class="view-modal-value">${trade.exitTime}</div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            html += `
                <div class="view-modal-section">
                    <span class="view-modal-label">Type de Trade</span>
                    <div class="view-modal-value">
                        <span class="px-3 py-1 rounded text-sm ${trade.type === 'Long' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${trade.type}
                        </span>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <div class="view-modal-section">
                        <span class="view-modal-label">Prix d'entr√©e</span>
                        <div class="view-modal-value">$${trade.entryPrice}</div>
                    </div>
                    <div class="view-modal-section">
                        <span class="view-modal-label">Prix de sortie</span>
                        <div class="view-modal-value">$${trade.exitPrice}</div>
                    </div>
                    <div class="view-modal-section">
                        <span class="view-modal-label">Quantit√©</span>
                        <div class="view-modal-value">${trade.quantity}</div>
                    </div>
                </div>
            `;
            
            if (trade.stopLoss || trade.takeProfit) {
                html += `<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">`;
                if (trade.stopLoss) {
                    html += `
                        <div class="view-modal-section">
                            <span class="view-modal-label">Stop Loss</span>
                            <div class="view-modal-value">$${trade.stopLoss}</div>
                        </div>
                    `;
                }
                if (trade.takeProfit) {
                    html += `
                        <div class="view-modal-section">
                            <span class="view-modal-label">Take Profit</span>
                            <div class="view-modal-value">$${trade.takeProfit}</div>
                        </div>
                    `;
                }
                html += `</div>`;
            }
            
            html += `
                <div class="view-modal-section">
                    <span class="view-modal-label">P&L</span>
                    <div class="view-modal-value ${pnlClass}" style="font-size: 2rem; font-weight: bold;">$${trade.pnl.toFixed(2)}</div>
                </div>
            `;
            
            if (trade.setup) {
                html += `
                    <div class="view-modal-section">
                        <span class="view-modal-label">Setup</span>
                        <div class="view-modal-value">${trade.setup}</div>
                    </div>
                `;
            }
            
            if (trade.protections && trade.protections.length > 0) {
                html += `
                    <div class="view-modal-section">
                        <span class="view-modal-label">Protections</span>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
                            ${trade.protections.map(p => `
                                <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded text-sm">${p}</span>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            if (trade.notes) {
                html += `
                    <div class="view-modal-section">
                        <span class="view-modal-label">Notes</span>
                        <div class="view-modal-value" style="white-space: pre-wrap;">${trade.notes}</div>
                    </div>
                `;
            }
            
            document.getElementById('tradeDetailsContent').innerHTML = html;
            document.getElementById('viewTradeModal').style.display = 'block';
        }
        
        function closeViewTradeModal() {
            document.getElementById('viewTradeModal').style.display = 'none';
        }
        
        // Fonction pour voir les d√©tails d'une note quotidienne
        function viewJournalEntry(timestamp) {
            const entry = journalEntries.find(e => e.timestamp === timestamp);
            if (!entry) {
                alert('Note non trouv√©e');
                return;
            }
            
            const stars = '‚≠ê'.repeat(entry.rating);
            
            let html = `
                <div class="view-modal-section">
                    <span class="view-modal-label">Date</span>
                    <div class="view-modal-value">${entry.date}</div>
                </div>
                
                <div class="view-modal-section">
                    <span class="view-modal-label">√âvaluation</span>
                    <div class="view-modal-value">${stars}</div>
                </div>
            `;
            
            if (entry.emotionBefore || entry.emotionAfter) {
                html += `<div class="view-modal-section"><span class="view-modal-label">√âmotions</span>`;
                if (entry.emotionBefore) {
                    html += `<div class="view-modal-value" style="margin-bottom: 8px;">Avant: ${entry.emotionBefore}</div>`;
                }
                if (entry.emotionAfter) {
                    html += `<div class="view-modal-value">Apr√®s: ${entry.emotionAfter}</div>`;
                }
                html += `</div>`;
            }
            
            html += `
                <div class="view-modal-section">
                    <span class="view-modal-label">Notes</span>
                    <div class="view-modal-value" style="white-space: pre-wrap;">${entry.text}</div>
                </div>
            `;
            
            if (entry.image) {
                html += `
                    <div class="view-modal-section">
                        <span class="view-modal-label">Image</span>
                        <img src="${entry.image}" alt="Note image" 
                             style="max-width: 100%; height: auto; border-radius: 10px; cursor: pointer; margin-top: 10px;"
                             onclick="viewImageZoom('${entry.image}')"
                             title="Cliquer pour agrandir">
                    </div>
                `;
            }
            
            document.getElementById('journalDetailsContent').innerHTML = html;
            document.getElementById('viewJournalModal').style.display = 'block';
        }
        
        function closeViewJournalModal() {
            document.getElementById('viewJournalModal').style.display = 'none';
        }
        
        // Fonction pour agrandir une image
        function viewImageZoom(imageSrc) {
            document.getElementById('imageZoomImg').src = imageSrc;
            document.getElementById('imageZoomModal').style.display = 'block';
        }
        
        function closeImageZoom() {
            document.getElementById('imageZoomModal').style.display = 'none';
        }
        
        // Fermer les modals en cliquant en dehors
        window.onclick = function(event) {
            const tradeModal = document.getElementById('viewTradeModal');
            const journalModal = document.getElementById('viewJournalModal');
            
            if (event.target === tradeModal) {
                tradeModal.style.display = 'none';
            }
            if (event.target === journalModal) {
                journalModal.style.display = 'none';
            }
        }

</script>

    <!-- Modal pour voir les d√©tails du trade -->
    <div id="viewTradeModal" class="view-modal">
        <div class="view-modal-content">
            <span class="view-modal-close" onclick="closeViewTradeModal()">&times;</span>
            <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 20px;">D√©tails du Trade</h2>
            <div id="tradeDetailsContent"></div>
        </div>
    </div>
    
    <!-- Modal pour voir les d√©tails de la note quotidienne -->
    <div id="viewJournalModal" class="view-modal">
        <div class="view-modal-content">
            <span class="view-modal-close" onclick="closeViewJournalModal()">&times;</span>
            <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 20px;">D√©tails de la Note</h2>
            <div id="journalDetailsContent"></div>
        </div>
    </div>
    
    <!-- Modal Vue D√©taill√©e √âl√®ve -->
    <div id="studentDetailModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 1200px; max-height: 90vh; overflow-y: auto;">
            <span class="close" onclick="closeStudentDetail()">&times;</span>
            <h2 style="font-size: 1.75rem; font-weight: bold; margin-bottom: 20px; color: #000B25;" id="studentDetailTitle">D√©tails de l'√âl√®ve</h2>
            
            <!-- Informations √âl√®ve -->
            <div class="trader-card mb-6" style="padding: 24px;">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <div class="text-sm text-gray-600">Email</div>
                        <div class="font-semibold" id="studentDetailEmail">-</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-600">Date d'inscription</div>
                        <div class="font-semibold" id="studentDetailCreatedAt">-</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-600">Derni√®re connexion</div>
                        <div class="font-semibold" id="studentDetailLastLogin">-</div>
                    </div>
                </div>
            </div>
            
            <!-- Stats √âl√®ve -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="trader-card" style="padding: 20px;">
                    <div class="text-sm text-gray-600 mb-2">Comptes</div>
                    <div class="text-2xl font-bold" id="studentDetailAccounts">0</div>
                </div>
                <div class="trader-card" style="padding: 20px;">
                    <div class="text-sm text-gray-600 mb-2">Total Trades</div>
                    <div class="text-2xl font-bold" id="studentDetailTrades">0</div>
                </div>
                <div class="trader-card" style="padding: 20px;">
                    <div class="text-sm text-gray-600 mb-2">Win Rate</div>
                    <div class="text-2xl font-bold text-green-600" id="studentDetailWinRate">0%</div>
                </div>
                <div class="trader-card" style="padding: 20px;">
                    <div class="text-sm text-gray-600 mb-2">P&L Total</div>
                    <div class="text-2xl font-bold" id="studentDetailPnL">$0</div>
                </div>
            </div>
            
            <!-- Comptes de l'√©l√®ve -->
            <div class="trader-card mb-6" style="padding: 24px;">
                <h3 class="text-lg font-bold mb-3">üìä Comptes Trading</h3>
                <div id="studentDetailAccountsList">
                    <p class="text-gray-500">Aucun compte</p>
                </div>
            </div>
            
            <!-- Journal des Trades -->
            <div class="trader-card" style="padding: 24px;">
                <h3 class="text-lg font-bold mb-3">üìã Journal des Trades</h3>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Compte</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Symbole</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Entr√©e</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sortie</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Qt√©</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">P&L</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Setup</th>
                            </tr>
                        </thead>
                        <tbody id="studentDetailTradesTable">
                            <tr>
                                <td colspan="9" class="px-4 py-8 text-center text-gray-500">Aucun trade</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal pour zoom sur images -->
    <div id="imageZoomModal" class="image-zoom-modal" onclick="closeImageZoom()">
        <span class="image-zoom-close">&times;</span>
        <div class="image-zoom-content">
            <img id="imageZoomImg" src="" alt="Image agrandie">
        </div>
    </div>
    
    <!-- COACH APP -->
    <div id="coachApp" style="display: none;" class="flex">
        <!-- Sidebar Coach -->
        <div class="sidebar">
            <div class="p-6 border-b border-gray-700" style="text-align: center;">
                <img src="https://page.gensparksite.com/v1/base64_upload/3b1a581410ba30561b2214b0a075af1a" alt="Trader 360 Logo" style="width: 80px; height: auto; margin: 0 auto;">
                <div class="text-gray-300 text-sm mt-3">MODE COACH</div>
                <div class="text-gray-400 text-xs mt-1" id="coachUserInfo"></div>
            </div>
            
            <nav class="mt-6">
                <div class="sidebar-item coach-active" id="coachNavDashboard" onclick="showCoachSection('coachDashboard')">
                    <i class="fas fa-chart-line mr-3"></i>Dashboard Global
                </div>
                <div class="sidebar-item" id="coachNavStudents" onclick="showCoachSection('coachStudents')">
                    <i class="fas fa-users mr-3"></i>Mes √âl√®ves
                </div>
                <div class="sidebar-item" id="coachNavAccounting" onclick="showCoachSection('coachAccounting')">
                    <i class="fas fa-euro-sign mr-3"></i>Comptabilit√©
                </div>
                <div class="sidebar-item" id="coachNavRegistrations" onclick="showCoachSection('coachRegistrations')">
                    <i class="fas fa-user-check mr-3"></i>Inscriptions
                </div>
            </nav>

            <nav class="mt-6">
                <div class="sidebar-item" onclick="logout()" style="margin-top: 20px; border-top: 1px solid #374151; padding-top: 20px;">
                    <i class="fas fa-sign-out-alt mr-3"></i>D√©connexion
                </div>
            </nav>
        </div>

        <!-- Main Content Coach -->
        <div class="flex-1 p-8 bg-gray-50">
            <!-- Dashboard Global -->
            <div id="coachDashboard" class="section">
                <!-- Banner Style Coach -->
                <div class="traderzella-banner">
                    <!-- √âl√®ves Actifs -->
                    <div class="metric-item">
                        <div class="metric-header">
                            √âl√®ves Actifs <i class="fas fa-info-circle info-icon" style="color: #ccc;"><span class="tooltip">Nombre d'√©l√®ves avec le statut actif dans l'√©cole</span></i>
                        </div>
                        <div class="metric-main">
                            <div class="metric-value-large" id="coachTotalStudents">0</div>
                            <i class="fas fa-users" style="color: #3b82f6; font-size: 20px;"></i>
                        </div>
                    </div>

                    <!-- Win Rate Global -->
                    <div class="metric-item">
                        <div class="metric-header">
                            Win Rate Global <i class="fas fa-info-circle info-icon" style="color: #ccc;"><span class="tooltip">Pourcentage de trades gagnants de tous les √©l√®ves actifs combin√©s</span></i>
                        </div>
                        <div class="metric-main">
                            <div class="metric-value-medium" id="coachGlobalWinRate">0%</div>
                            <div class="metric-bar-container">
                                <div class="metric-bar-bg">
                                    <div class="metric-bar-fill green" id="coachWinRateBar" style="width: 0%;"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Total Trades -->
                    <div class="metric-item">
                        <div class="metric-header">
                            Total Trades <i class="fas fa-info-circle info-icon" style="color: #ccc;"><span class="tooltip">Nombre total de trades ex√©cut√©s par tous les √©l√®ves</span></i>
                        </div>
                        <div class="metric-main">
                            <div class="metric-value-medium" id="coachTotalTrades">0</div>
                            <div class="metric-counters">
                                <div class="counter-item">
                                    <div class="counter-label">Gagnants</div>
                                    <div class="counter-value green" id="coachTotalWins">0</div>
                                </div>
                                <div class="counter-item">
                                    <div class="counter-label">Perdants</div>
                                    <div class="counter-value red" id="coachTotalLosses">0</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- P&L Global -->
                    <div class="metric-item net-pnl">
                        <div class="metric-header">
                            P&L Global <i class="fas fa-info-circle info-icon" style="color: #ccc;"><span class="tooltip">Profit ou perte total de tous les √©l√®ves combin√©s</span></i>
                        </div>
                        <div class="metric-main">
                            <div class="metric-value-large" id="coachGlobalPnL">$0.00</div>
                            <i class="fas fa-dollar-sign" style="color: #10b981; font-size: 20px;"></i>
                        </div>
                    </div>
                </div>

                <!-- R√©partition par √âl√®ve -->
                <div class="trader-card mt-6" style="padding: 24px;">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-chart-bar mr-2" style="color: #ac862b;"></i>
                        R√©partition par √âl√®ve
                    </h2>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">√âl√®ve</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Comptes</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Trades</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Win Rate</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">P&L</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Avg P&L/Trade</th>
                                </tr>
                            </thead>
                            <tbody id="coachStudentsBreakdown">
                                <tr>
                                    <td colspan="6" class="px-6 py-8 text-center text-gray-500">Aucun √©l√®ve actif</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Mes √âl√®ves -->
            <div id="coachStudents" class="section hidden">
                <div class="section-header">
                    <h1>Mes √âl√®ves</h1>
                    <p class="text-gray-600">Liste de tous les √©l√®ves avec vue d√©taill√©e</p>
                </div>

                <div class="trader-card" style="padding: 24px;">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nom/Email</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Comptes</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Win Rate</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Trades</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">P&L</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Statut</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="coachStudentsTable">
                                <tr>
                                    <td colspan="7" class="px-6 py-4 text-center text-gray-500">Aucun √©l√®ve</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Comptabilit√© -->
            <div id="coachAccounting" class="section hidden">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">Comptabilit√© Globale</h1>
                        <p class="text-gray-600 mt-1">Vue d'ensemble financi√®re de tous les √©l√®ves actifs</p>
                    </div>
                </div>

                <!-- KPIs Comptabilit√© Globaux -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div class="trader-card p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm mb-1">Total Investi</p>
                                <p class="text-2xl font-bold" id="coachTotalInvested" style="color: #dc2626;">$0.00</p>
                            </div>
                            <div class="w-12 h-12 rounded-full flex items-center justify-center" style="background-color: rgba(220, 38, 38, 0.1);">
                                <i class="fas fa-arrow-down" style="color: #dc2626;"></i>
                            </div>
                        </div>
                    </div>

                    <div class="trader-card p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm mb-1">Total Payouts</p>
                                <p class="text-2xl font-bold" id="coachTotalPayouts" style="color: #10b981;">$0.00</p>
                            </div>
                            <div class="w-12 h-12 rounded-full flex items-center justify-center" style="background-color: rgba(16, 185, 129, 0.1);">
                                <i class="fas fa-arrow-up" style="color: #10b981;"></i>
                            </div>
                        </div>
                    </div>

                    <div class="trader-card p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm mb-1">B√©n√©fice Net</p>
                                <p class="text-2xl font-bold" id="coachNetProfit">$0.00</p>
                            </div>
                            <div class="w-12 h-12 rounded-full flex items-center justify-center" id="coachNetProfitIcon">
                                <i class="fas fa-equals"></i>
                            </div>
                        </div>
                    </div>

                    <div class="trader-card p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm mb-1">ROI Global</p>
                                <p class="text-2xl font-bold" id="coachROI">0%</p>
                            </div>
                            <div class="w-12 h-12 rounded-full flex items-center justify-center" style="background-color: rgba(172, 134, 43, 0.1);">
                                <i class="fas fa-percent" style="color: #ac862b;"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- R√©partition par √âl√®ve -->
                <div class="trader-card mb-6" style="padding: 24px;">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800">
                        <i class="fas fa-users mr-2" style="color: #ac862b;"></i>
                        D√©tail par √âl√®ve
                    </h3>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-3 px-4 text-sm font-semibold text-gray-700">√âl√®ve</th>
                                    <th class="text-right py-3 px-4 text-sm font-semibold text-gray-700">Co√ªts</th>
                                    <th class="text-right py-3 px-4 text-sm font-semibold text-gray-700">Payouts</th>
                                    <th class="text-right py-3 px-4 text-sm font-semibold text-gray-700">Balance</th>
                                    <th class="text-right py-3 px-4 text-sm font-semibold text-gray-700">ROI</th>
                                </tr>
                            </thead>
                            <tbody id="coachAccountingBreakdown">
                                <tr>
                                    <td colspan="5" class="text-center py-8 text-gray-500">
                                        <i class="fas fa-inbox text-4xl mb-2 opacity-30"></i>
                                        <p>Aucune donn√©e comptable</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tableaux -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Tous les Co√ªts -->
                    <div class="trader-card" style="padding: 24px;">
                        <h3 class="text-lg font-semibold mb-4 text-gray-800">
                            <i class="fas fa-credit-card mr-2" style="color: #dc2626;"></i>
                            Tous les Comptes Achet√©s
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b">
                                        <th class="text-left py-3 px-2 text-sm font-semibold text-gray-700">Date</th>
                                        <th class="text-left py-3 px-2 text-sm font-semibold text-gray-700">√âl√®ve</th>
                                        <th class="text-left py-3 px-2 text-sm font-semibold text-gray-700">Compte</th>
                                        <th class="text-right py-3 px-2 text-sm font-semibold text-gray-700">Co√ªt</th>
                                    </tr>
                                </thead>
                                <tbody id="coachAllCostsTable">
                                    <tr>
                                        <td colspan="4" class="text-center py-8 text-gray-500">
                                            <i class="fas fa-inbox text-4xl mb-2 opacity-30"></i>
                                            <p>Aucun co√ªt enregistr√©</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Tous les Payouts -->
                    <div class="trader-card" style="padding: 24px;">
                        <h3 class="text-lg font-semibold mb-4 text-gray-800">
                            <i class="fas fa-money-bill-wave mr-2" style="color: #10b981;"></i>
                            Tous les Payouts
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b">
                                        <th class="text-left py-3 px-2 text-sm font-semibold text-gray-700">Date</th>
                                        <th class="text-left py-3 px-2 text-sm font-semibold text-gray-700">√âl√®ve</th>
                                        <th class="text-left py-3 px-2 text-sm font-semibold text-gray-700">Compte</th>
                                        <th class="text-right py-3 px-2 text-sm font-semibold text-gray-700">Montant</th>
                                    </tr>
                                </thead>
                                <tbody id="coachAllPayoutsTable">
                                    <tr>
                                        <td colspan="4" class="text-center py-8 text-gray-500">
                                            <i class="fas fa-inbox text-4xl mb-2 opacity-30"></i>
                                            <p>Aucun payout enregistr√©</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Inscriptions -->
            <div id="coachRegistrations" class="section hidden">
                <div class="section-header">
                    <h1>Gestion des Inscriptions</h1>
                    <p class="text-gray-600">Valider, suspendre ou supprimer des acc√®s √©l√®ves</p>
                </div>

                <div class="trader-card mb-6" style="padding: 24px;">
                    <h2 class="text-xl font-bold mb-4">‚è≥ Demandes en Attente</h2>
                    <div id="coachPendingUsers">
                        <p class="text-gray-500 text-center py-4">Aucune demande en attente</p>
                    </div>
                </div>

                <div class="trader-card" style="padding: 24px;">
                    <h2 class="text-xl font-bold mb-4">üë• Tous les √âl√®ves</h2>
                    <div id="coachAllUsers">
                        <p class="text-gray-500 text-center py-4">Aucun √©l√®ve</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    

    <!-- Scripts Supabase - Charg√©s APR√àS toutes les fonctions -->

    <script src="supabase-config.js"></script>
    <script src="supabase-auth.js"></script>
    <script src="supabase-trades.js"></script>
    <script src="supabase-journal.js"></script>
    <script src="supabase-coach.js"></script>
</body>
</html>
    <script id="html_badge_script1">
        window.__genspark_remove_badge_link = "https://www.genspark.ai/api/html_badge/" +
            "remove_badge?token=To%2FBnjzloZ3UfQdcSaYfDtmR9J3Zk59wryHt2pl53MPm1g%2FQPzKtth6tnX8M6nlB%2Bqn2cuvoD3993xhfwoh7Pa6rv5f2xC9mUocjGF9uPCcelr4EGRzpRq8%2BzROvPQttO9L7A6ZFM12OGlApFYuvjg%2BiVgHASYq0e7k0FsYVba8JKSfbBvlIq%2BLvcR2Qxxz5A6XwvRmit7svdf%2FaqhlVRTqjjsVI3aMeqv0jRI3OZpJaJWaMvpGpbRcJc3b7PQsDNV2%2BE05PKsiWIddzg5fdeC8OWDESMxSxwQ2r2bAUBuwZ11PcfeBsNMjBufTJBakGtg6y8C%2BYandxw76e6Kf9QG5z%2FalomSf%2FaOv3S0kRuPnmFs1OtOJTvS3BBrcmkX2AiUd2irPWzkW%2B3RMWRw2kgRjLFs4sRGwvhM6DgSPELUHfzi1evgJPtQboDRIw7g13Ib4AgU%2BsZgVDiO%2Fa%2Bwr5itIskIAmGj2lVDbTGbXWLZ0sOJoRazQwW0YEKsNU9lb5nfDDqBIY0E4RbpvNdV0wxCLFbOQ5qe0sqK7tWdBcEfw%3D";
        window.__genspark_locale = "fr-FR";
        window.__genspark_token = "To/BnjzloZ3UfQdcSaYfDtmR9J3Zk59wryHt2pl53MPm1g/QPzKtth6tnX8M6nlB+qn2cuvoD3993xhfwoh7Pa6rv5f2xC9mUocjGF9uPCcelr4EGRzpRq8+zROvPQttO9L7A6ZFM12OGlApFYuvjg+iVgHASYq0e7k0FsYVba8JKSfbBvlIq+LvcR2Qxxz5A6XwvRmit7svdf/aqhlVRTqjjsVI3aMeqv0jRI3OZpJaJWaMvpGpbRcJc3b7PQsDNV2+E05PKsiWIddzg5fdeC8OWDESMxSxwQ2r2bAUBuwZ11PcfeBsNMjBufTJBakGtg6y8C+Yandxw76e6Kf9QG5z/alomSf/aOv3S0kRuPnmFs1OtOJTvS3BBrcmkX2AiUd2irPWzkW+3RMWRw2kgRjLFs4sRGwvhM6DgSPELUHfzi1evgJPtQboDRIw7g13Ib4AgU+sZgVDiO/a+wr5itIskIAmGj2lVDbTGbXWLZ0sOJoRazQwW0YEKsNU9lb5nfDDqBIY0E4RbpvNdV0wxCLFbOQ5qe0sqK7tWdBcEfw=";
    </script>
    
    <script id="html_notice_dialog_script" src="https://www.genspark.ai/notice_dialog.js"></script>
    
    <script>
        // ==========================================
        // FONCTIONS DE MISE √Ä JOUR DU BANDEAU
        // ==========================================
        
        function updateBanner() {
            console.log("  ‚Üí updateBanner() appel√©e");
            // Si aucun compte n'existe, utiliser tous les trades
            let filteredTrades;
            if (accounts.length === 0) {
                console.log('‚ö†Ô∏è Aucun compte d√©fini, utilisation de tous les trades');
                filteredTrades = trades;
            } else {
                const activeAccountIds = accounts.filter(a => a.active).map(a => a.id);
                console.log('üìÅ Comptes actifs:', activeAccountIds);
                filteredTrades = trades.filter(t => activeAccountIds.includes(t.accountId));
            }

            console.log('üìä Trades filtr√©s pour le bandeau:', filteredTrades.length);

            if (filteredTrades.length === 0) {
                resetBanner();
                return;
            }

            // Calculate metrics
            const totalPnl = filteredTrades.reduce((sum, t) => sum + t.pnl, 0);
            const winningTrades = filteredTrades.filter(t => t.pnl > 0);
            const losingTrades = filteredTrades.filter(t => t.pnl < 0);
            const neutralTrades = filteredTrades.filter(t => t.pnl === 0);
            
            const tradeWinRate = (winningTrades.length / filteredTrades.length) * 100;
            
            const grossProfit = winningTrades.reduce((sum, t) => sum + t.pnl, 0);
            const grossLoss = Math.abs(losingTrades.reduce((sum, t) => sum + t.pnl, 0));
            const profitFactor = grossLoss > 0 ? grossProfit / grossLoss : (grossProfit > 0 ? 99.99 : 0);
            
            const avgWin = winningTrades.length > 0 ? grossProfit / winningTrades.length : 0;
            const avgLoss = losingTrades.length > 0 ? grossLoss / losingTrades.length : 0;
            const avgRatio = avgLoss > 0 ? avgWin / avgLoss : (avgWin > 0 ? 99.99 : 0);
            
            // DEBUG: Logger les valeurs calcul√©es
            console.log('üìä Bandeau - Winning trades:', winningTrades.length, 'Gross Profit:', grossProfit, 'Avg Win:', avgWin);
            console.log('üìä Bandeau - Losing trades:', losingTrades.length, 'Gross Loss:', grossLoss, 'Avg Loss:', avgLoss);

            // Group by day for day win %
            const tradesByDay = {};
            filteredTrades.forEach(trade => {
                if (!tradesByDay[trade.date]) {
                    tradesByDay[trade.date] = 0;
                }
                tradesByDay[trade.date] += trade.pnl;
            });
            
            const dayResults = Object.values(tradesByDay);
            const winningDays = dayResults.filter(d => d > 0).length;
            const losingDays = dayResults.filter(d => d < 0).length;
            const neutralDays = dayResults.filter(d => d === 0).length;
            const dayWinRate = dayResults.length > 0 ? (winningDays / dayResults.length) * 100 : 0;

            // Update DOM
            const netPnlEl = document.getElementById('netPnlValue');
            if (netPnlEl) {
                netPnlEl.textContent = `$${totalPnl.toFixed(2)}`;
                netPnlEl.style.color = totalPnl < 0 ? '#ef4444' : '#10b981'; // Rouge si n√©gatif, vert sinon
            }

            const tradeWinEl = document.getElementById('tradeWinValue');
            if (tradeWinEl) tradeWinEl.textContent = `${tradeWinRate.toFixed(1)}%`;

            const profitFactorEl = document.getElementById('profitFactorValue');
            if (profitFactorEl) profitFactorEl.textContent = profitFactor.toFixed(2);

            const dayWinEl = document.getElementById('dayWinValue');
            if (dayWinEl) dayWinEl.textContent = `${dayWinRate.toFixed(1)}%`;

            const avgRatioEl = document.getElementById('avgWinLossValue');
            if (avgRatioEl) avgRatioEl.textContent = avgRatio.toFixed(2);

            // Update visual indicators
            updateBar('tradeWinBar', tradeWinRate, 60, 40);
            updateBar('profitFactorBar', Math.min(profitFactor / 1.5 * 100, 100), 66, 33);
            updateBar('dayWinBar', dayWinRate, 60, 40);
            
            // Compteurs Win/Loss supprim√©s - on garde uniquement les pourcentages
            
            // Gross Profit/Loss ne sont plus affich√©s dans le bandeau
            
            // Update win/loss bars
            console.log('üéØ Appel updateWinLossBars avec avgWin:', avgWin, 'avgLoss:', avgLoss);
            updateWinLossBars(avgWin, avgLoss);
        }

        function updateBar(barId, percentage, thresholdGreen = 60, thresholdOrange = 40) {
            const bar = document.getElementById(barId);
            if (!bar) return;
            
            // Update width
            bar.style.width = `${Math.min(percentage, 100)}%`;
            
            // Update color
            bar.className = 'metric-bar-fill';
            if (percentage >= thresholdGreen) {
                bar.classList.add('green');
            } else if (percentage >= thresholdOrange) {
                bar.classList.add('orange');
            } else {
                bar.classList.add('red');
            }
        }

        function updateCounts(winId, neutralId, lossId, wins, neutral, losses) {
            const winEl = document.getElementById(winId);
            const neutralEl = document.getElementById(neutralId);
            const lossEl = document.getElementById(lossId);
            
            if (winEl) winEl.textContent = wins;
            if (neutralEl) neutralEl.textContent = neutral;
            if (lossEl) lossEl.textContent = losses;
        }
        
        // Nouvelle fonction simplifi√©e pour Win/Loss uniquement
        function updateWinLossCounts(winId, lossId, wins, losses) {
            const winEl = document.getElementById(winId);
            const lossEl = document.getElementById(lossId);
            
            if (winEl) {
                winEl.textContent = wins;
                console.log(`‚úÖ ${winId} mis √† jour:`, wins);
            } else {
                console.error(`‚ùå ${winId} introuvable`);
            }
            
            if (lossEl) {
                lossEl.textContent = losses;
                console.log(`‚úÖ ${lossId} mis √† jour:`, losses);
            } else {
                console.error(`‚ùå ${lossId} introuvable`);
            }
        }

        function updateWinLossBars(avgWin, avgLoss) {
            console.log('üîß updateWinLossBars re√ßu - avgWin:', avgWin, 'avgLoss:', avgLoss);
            
            // Mettre √† jour les labels avec IDs
            const winLabel = document.getElementById('avgWinLabel');
            const lossLabel = document.getElementById('avgLossLabel');
            
            console.log('üéØ El√©ments DOM - winLabel:', winLabel, 'lossLabel:', lossLabel);
            
            // Afficher avec 2 d√©cimales si < 100, sinon arrondir
            const formatValue = (val) => {
                if (val === 0) return '0';
                if (val < 100) return val.toFixed(2);
                return Math.round(val).toString();
            };
            
            const formattedWin = formatValue(avgWin);
            const formattedLoss = formatValue(avgLoss);
            
            console.log('üíµ Valeurs format√©es - Win:', formattedWin, 'Loss:', formattedLoss);
            
            if (winLabel) {
                winLabel.textContent = `$${formattedWin}`;
                console.log('‚úÖ winLabel mis √† jour:', winLabel.textContent);
            } else {
                console.error('‚ùå winLabel introuvable!');
            }
            
            if (lossLabel) {
                lossLabel.textContent = `-$${formattedLoss}`;
                console.log('‚úÖ lossLabel mis √† jour:', lossLabel.textContent);
            } else {
                console.error('‚ùå lossLabel introuvable!');
            }
            
            // Mettre √† jour les largeurs des barres proportionnellement
            const maxValue = Math.max(avgWin, avgLoss);
            const winBar = document.getElementById('avgWinBar');
            const lossBar = document.getElementById('avgLossBar');
            
            if (winBar) {
                if (maxValue > 0) {
                    const winWidth = (avgWin / maxValue) * 50 + 30; // Min 30px, max 80px
                    winBar.style.width = `${Math.min(winWidth, 80)}px`;
                } else {
                    winBar.style.width = '40px'; // Largeur par d√©faut
                }
            }
            
            if (lossBar) {
                if (maxValue > 0) {
                    const lossWidth = (avgLoss / maxValue) * 50 + 30; // Min 30px, max 80px
                    lossBar.style.width = `${Math.min(lossWidth, 80)}px`;
                } else {
                    lossBar.style.width = '40px'; // Largeur par d√©faut
                }
            }
        }

        function resetBanner() {
            const netPnlEl = document.getElementById('netPnlValue');
            if (netPnlEl) {
                netPnlEl.textContent = '$0.00';
                netPnlEl.style.color = '#10b981'; // Vert pour $0
            }
            if (document.getElementById('tradeWinValue')) 
                document.getElementById('tradeWinValue').textContent = '0%';
            if (document.getElementById('profitFactorValue')) 
                document.getElementById('profitFactorValue').textContent = '0.00';
            if (document.getElementById('dayWinValue')) 
                document.getElementById('dayWinValue').textContent = '0%';
            if (document.getElementById('avgWinLossValue')) 
                document.getElementById('avgWinLossValue').textContent = '0.00';
            
            // Compteurs supprim√©s
            
            // R√©initialiser aussi les barres Win/Loss
            updateWinLossBars(0, 0);
        }

        // ==================== COMPTABILIT√â & PAYOUTS ====================
        
        function showAddAccountCostModal() {
            document.getElementById('accountCostDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('addAccountCostModal').style.display = 'block';
        }

        function showAddPayoutModal() {
            document.getElementById('payoutDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('addPayoutModal').style.display = 'block';
        }

        // addAccountCost d√©plac√© vers supabase-journal.js

        // addPayout d√©plac√© vers supabase-journal.js

        // deleteAccountCost d√©plac√© vers supabase-journal.js

        // deletePayout d√©plac√© vers supabase-journal.js

        function updateAccountingSection() {
            // Calculs
            const totalInvested = accountCosts.reduce((sum, ac) => sum + ac.amount, 0);
            const totalPayouts = payouts.reduce((sum, p) => sum + p.amount, 0);
            const netProfit = totalPayouts - totalInvested;
            const roi = totalInvested > 0 ? ((netProfit / totalInvested) * 100) : 0;

            // Mise √† jour des KPIs
            document.getElementById('totalInvested').textContent = '$' + totalInvested.toFixed(2);
            document.getElementById('totalPayouts').textContent = '$' + totalPayouts.toFixed(2);
            
            const netProfitEl = document.getElementById('netProfit');
            netProfitEl.textContent = '$' + Math.abs(netProfit).toFixed(2);
            if (netProfit > 0) {
                netProfitEl.style.color = '#10b981';
            } else if (netProfit < 0) {
                netProfitEl.style.color = '#dc2626';
                netProfitEl.textContent = '-$' + Math.abs(netProfit).toFixed(2);
            } else {
                netProfitEl.style.color = '#6b7280';
            }

            const netProfitIcon = document.getElementById('netProfitIcon');
            if (netProfit > 0) {
                netProfitIcon.style.backgroundColor = 'rgba(16, 185, 129, 0.1)';
                netProfitIcon.querySelector('i').className = 'fas fa-arrow-up';
                netProfitIcon.querySelector('i').style.color = '#10b981';
            } else if (netProfit < 0) {
                netProfitIcon.style.backgroundColor = 'rgba(220, 38, 38, 0.1)';
                netProfitIcon.querySelector('i').className = 'fas fa-arrow-down';
                netProfitIcon.querySelector('i').style.color = '#dc2626';
            } else {
                netProfitIcon.style.backgroundColor = 'rgba(107, 114, 128, 0.1)';
                netProfitIcon.querySelector('i').className = 'fas fa-equals';
                netProfitIcon.querySelector('i').style.color = '#6b7280';
            }

            const roiEl = document.getElementById('roi');
            roiEl.textContent = roi.toFixed(1) + '%';
            roiEl.style.color = roi > 0 ? '#10b981' : roi < 0 ? '#dc2626' : '#6b7280';

            // Mise √† jour des tableaux
            updateAccountCostsTable();
            updatePayoutsTable();
            updateAccountingChart();
        }

        function updateAccountCostsTable() {
            const tbody = document.getElementById('accountCostsTable');
            
            if (accountCosts.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center py-8 text-gray-500">
                            <i class="fas fa-inbox text-4xl mb-2 opacity-30"></i>
                            <p>Aucun compte enregistr√©</p>
                        </td>
                    </tr>
                `;
                return;
            }

            const sortedCosts = [...accountCosts].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            tbody.innerHTML = sortedCosts.map(ac => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="py-3 px-2 text-sm">${new Date(ac.date).toLocaleDateString('fr-FR')}</td>
                    <td class="py-3 px-2 text-sm font-medium">${ac.name}</td>
                    <td class="py-3 px-2 text-sm text-right font-semibold" style="color: #dc2626;">-$${ac.amount.toFixed(2)}</td>
                    <td class="py-3 px-2 text-center">
                        <button onclick="deleteAccountCost(${ac.id})" class="text-red-600 hover:text-red-800" title="Supprimer">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function updatePayoutsTable() {
            const tbody = document.getElementById('payoutsTable');
            
            if (payouts.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center py-8 text-gray-500">
                            <i class="fas fa-inbox text-4xl mb-2 opacity-30"></i>
                            <p>Aucun payout enregistr√©</p>
                        </td>
                    </tr>
                `;
                return;
            }

            const sortedPayouts = [...payouts].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            tbody.innerHTML = sortedPayouts.map(p => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="py-3 px-2 text-sm">${new Date(p.date).toLocaleDateString('fr-FR')}</td>
                    <td class="py-3 px-2 text-sm font-medium">${p.account}</td>
                    <td class="py-3 px-2 text-sm text-right font-semibold" style="color: #10b981;">+$${p.amount.toFixed(2)}</td>
                    <td class="py-3 px-2 text-center">
                        <button onclick="deletePayout(${p.id})" class="text-red-600 hover:text-red-800" title="Supprimer">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function updateAccountingChart() {
            const canvas = document.getElementById('accountingChart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');

            // Combiner et trier toutes les transactions par date
            const allTransactions = [
                ...accountCosts.map(ac => ({ date: ac.date, amount: -ac.amount, type: 'cost' })),
                ...payouts.map(p => ({ date: p.date, amount: p.amount, type: 'payout' }))
            ].sort((a, b) => new Date(a.date) - new Date(b.date));

            // Calculer le cumul
            let cumulative = 0;
            const chartData = allTransactions.map(t => {
                cumulative += t.amount;
                return {
                    date: new Date(t.date).toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' }),
                    value: cumulative
                };
            });

            if (accountingChart) {
                accountingChart.destroy();
            }

            accountingChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.map(d => d.date),
                    datasets: [{
                        label: 'B√©n√©fice Net Cumul√©',
                        data: chartData.map(d => d.value),
                        borderColor: '#ac862b',
                        backgroundColor: 'rgba(172, 134, 43, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointBackgroundColor: '#ac862b'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Cumul: $' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toFixed(0);
                                }
                            }
                        }
                    }
                }
            });
        }

        // ==================== IMPORT CSV ====================
        
        function showImportCSVModal() {
            // R√©initialiser
            document.getElementById('csvUploadStep').style.display = 'block';
            document.getElementById('csvPreviewStep').style.display = 'none';
            document.getElementById('csvFileInput').value = '';
            document.getElementById('csvFileName').style.display = 'none';
            csvParsedTrades = [];
            
            // Remplir la liste des comptes
            const select = document.getElementById('csvTargetAccount');
            select.innerHTML = '<option value="">Choisir un compte...</option>';
            accounts.forEach(account => {
                select.innerHTML += `<option value="${account.id}">${account.name}</option>`;
            });
            
            document.getElementById('importCSVModal').style.display = 'block';
        }

        function handleCSVUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const accountId = document.getElementById('csvTargetAccount').value;
            if (!accountId) {
                alert('Veuillez s√©lectionner un compte de destination avant d\'importer le fichier.');
                document.getElementById('csvFileInput').value = '';
                return;
            }

            document.getElementById('csvFileName').style.display = 'block';
            document.getElementById('csvFileNameText').textContent = file.name;

            const reader = new FileReader();
            reader.onload = function(e) {
                const csvText = e.target.result;
                parseCSV(csvText, parseInt(accountId));
            };
            reader.readAsText(file);
        }

        function parseCSV(csvText, accountId) {
            try {
                // S√©parer les lignes
                const lines = csvText.split('\n').filter(line => line.trim());
                if (lines.length < 2) {
                    alert('Le fichier CSV doit contenir au moins un en-t√™te et une ligne de donn√©es.');
                    return;
                }

                // Parser l'en-t√™te
                const headers = parseCSVLine(lines[0]);
                console.log('Headers d√©tect√©s:', headers);

                // D√©tecter les colonnes
                const columnMap = detectColumns(headers);
                console.log('Colonnes mapp√©es:', columnMap);

                if (!columnMap.date || !columnMap.symbol || !columnMap.type || !columnMap.entryPrice || !columnMap.exitPrice) {
                    alert('Colonnes obligatoires manquantes. V√©rifiez que votre CSV contient : Date, Symbole, Type, Prix d\'entr√©e, Prix de sortie');
                    return;
                }

                const account = accounts.find(a => a.id === accountId);
                if (!account) {
                    alert('Compte non trouv√©');
                    return;
                }

                // Parser les donn√©es
                csvParsedTrades = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = parseCSVLine(lines[i]);
                    if (values.length < 3) continue; // Ligne vide ou incompl√®te

                    try {
                        const trade = parseTradeLine(values, columnMap, accountId, account.name);
                        if (trade) {
                            csvParsedTrades.push(trade);
                        }
                    } catch (err) {
                        console.warn(`Ligne ${i} ignor√©e:`, err.message);
                    }
                }

                if (csvParsedTrades.length === 0) {
                    alert('Aucun trade valide trouv√© dans le fichier CSV.');
                    return;
                }

                // Afficher la pr√©visualisation
                showCSVPreview();
            } catch (error) {
                console.error('Erreur lors du parsing CSV:', error);
                alert('Erreur lors de la lecture du fichier CSV. V√©rifiez le format du fichier.');
            }
        }

        function parseCSVLine(line) {
            // Parser une ligne CSV en g√©rant les guillemets et virgules
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            
            return result;
        }

        function detectColumns(headers) {
            const map = {};
            
            headers.forEach((header, index) => {
                const h = header.toLowerCase().replace(/[^a-z0-9]/g, '');
                
                // Date - TopStep utilise "TradeDay"
                if (h.includes('date') || h === 'tradeday') {
                    if (!map.date) map.date = index;
                }
                // TopStep: EnteredAt contient date + heure d'entr√©e
                if (h === 'enteredat') {
                    map.enteredAt = index;
                    if (!map.date) map.date = index; // Utiliser comme date aussi
                }
                // TopStep: ExitedAt contient date + heure de sortie
                if (h === 'exitedat') {
                    map.exitedAt = index;
                }
                // Heure d'entr√©e
                if (h.includes('entrytime') || h.includes('timeentry') || h.includes('opentime')) {
                    map.entryTime = index;
                }
                // Heure de sortie
                if (h.includes('exittime') || h.includes('timeexit') || h.includes('closetime')) {
                    map.exitTime = index;
                }
                // Symbole - TopStep utilise "ContractName"
                if (h.includes('symbol') || h.includes('instrument') || h.includes('ticker') || h === 'contractname') {
                    map.symbol = index;
                }
                // Type (Long/Short)
                if (h.includes('type') || h.includes('side') || h.includes('direction') || h.includes('buysell')) {
                    map.type = index;
                }
                // Prix d'entr√©e
                if (h.includes('entry') && (h.includes('price') || h.includes('open'))) {
                    map.entryPrice = index;
                } else if (h.includes('openprice') || h.includes('entryprice')) {
                    map.entryPrice = index;
                }
                // Prix de sortie
                if (h.includes('exit') && (h.includes('price') || h.includes('close'))) {
                    map.exitPrice = index;
                } else if (h.includes('closeprice') || h.includes('exitprice')) {
                    map.exitPrice = index;
                }
                // Quantit√©
                if (h.includes('quantity') || h.includes('qty') || h.includes('contracts') || h.includes('size') || h.includes('volume')) {
                    map.quantity = index;
                }
                // P&L
                if (h.includes('pnl') || h.includes('pl') || h.includes('profit') || h.includes('gain') || h.includes('loss')) {
                    map.pnl = index;
                }
                // Setup
                if (h.includes('setup') || h.includes('strategy')) {
                    map.setup = index;
                }
                // Notes
                if (h.includes('note') || h.includes('comment') || h.includes('remark')) {
                    map.notes = index;
                }
            });
            
            return map;
        }

        function parseTradeLine(values, columnMap, accountId, accountName) {
            // Date - g√©rer le format TopStep (EnteredAt/ExitedAt)
            let dateStr = '';
            let entryTimeStr = '';
            let exitTimeStr = '';
            
            if (columnMap.enteredAt !== undefined) {
                // Format TopStep: "08/13/2025 14:20:54 +08:00"
                const enteredAtFull = values[columnMap.enteredAt] || '';
                const enteredAtParts = enteredAtFull.split(' ');
                dateStr = enteredAtParts[0]; // Date
                entryTimeStr = enteredAtParts[1] || ''; // Heure
                
                if (columnMap.exitedAt !== undefined) {
                    const exitedAtFull = values[columnMap.exitedAt] || '';
                    const exitedAtParts = exitedAtFull.split(' ');
                    exitTimeStr = exitedAtParts[1] || ''; // Heure de sortie
                }
            } else {
                dateStr = values[columnMap.date] || '';
            }
            
            let date = parseDate(dateStr);
            if (!date) {
                throw new Error('Date invalide');
            }

            // Symbole - g√©rer ContractName de TopStep (ex: ESU5 -> ES)
            let symbol = (values[columnMap.symbol] || 'ES').toUpperCase().trim();
            // Nettoyer le symbole et extraire le code de base
            symbol = symbol.replace(/[^A-Z0-9]/g, '');
            // Extraire le symbole de base (ES, MES, NQ, etc.) depuis le contract name
            if (symbol.match(/^(ES|MES|NQ|MNQ|YM|MYM|RTY|M2K|GC|MGC|SI|CL|NG)[A-Z0-9]*$/)) {
                symbol = symbol.match(/^(ES|MES|NQ|MNQ|YM|MYM|RTY|M2K|GC|MGC|SI|CL|NG)/)[1];
            }
            if (!symbol) symbol = 'ES';

            // Type (Long/Short)
            let type = (values[columnMap.type] || '').toLowerCase();
            if (type.includes('buy') || type.includes('long')) {
                type = 'Long';
            } else if (type.includes('sell') || type.includes('short')) {
                type = 'Short';
            } else {
                type = 'Long'; // Par d√©faut
            }

            // Prix
            const entryPrice = parseFloat(values[columnMap.entryPrice]);
            const exitPrice = parseFloat(values[columnMap.exitPrice]);
            if (isNaN(entryPrice) || isNaN(exitPrice)) {
                throw new Error('Prix invalides');
            }

            // Quantit√©
            let quantity = 1;
            if (columnMap.quantity !== undefined) {
                quantity = parseInt(values[columnMap.quantity]) || 1;
            }

            // Heures (optionnelles) - utiliser les heures extraites de EnteredAt/ExitedAt si disponibles
            let entryTime = entryTimeStr;
            let exitTime = exitTimeStr;
            
            // Sinon, chercher dans les colonnes d√©di√©es
            if (!entryTime && columnMap.entryTime !== undefined) {
                entryTime = values[columnMap.entryTime] || '';
            }
            if (!exitTime && columnMap.exitTime !== undefined) {
                exitTime = values[columnMap.exitTime] || '';
            }

            // Setup (optionnel)
            const setup = columnMap.setup !== undefined ? values[columnMap.setup] : 'Breakout';

            // Notes (optionnel)
            const notes = columnMap.notes !== undefined ? values[columnMap.notes] : '';

            // P&L - TopStep fournit d√©j√† le P&L calcul√© (avec fees d√©duites)
            let pnl = 0;
            if (columnMap.pnl !== undefined && values[columnMap.pnl]) {
                pnl = parseFloat(values[columnMap.pnl]);
                if (isNaN(pnl)) pnl = 0;
            } else {
                // Calculer le P&L selon le symbole si non fourni
                if (symbol === 'DEMO') {
                    pnl = 0; // Sera √† saisir manuellement
                } else if (symbol === 'ES' || symbol === 'MES') {
                    const pointsDiff = exitPrice - entryPrice;
                    const multiplier = symbol === 'MES' ? 5 : 50;
                    pnl = pointsDiff * quantity * multiplier;
                    if (type === 'Short') {
                        pnl = -pnl;
                    }
                } else if (symbol === 'GC' || symbol === 'MGC') {
                    // Gold: $100/point pour GC, $10/point pour MGC
                    const pointsDiff = exitPrice - entryPrice;
                    const multiplier = symbol === 'MGC' ? 10 : 100;
                    pnl = pointsDiff * quantity * multiplier;
                    if (type === 'Short') {
                        pnl = -pnl;
                    }
                } else {
                    // Autres symboles - essayer de calculer avec $50/point par d√©faut
                    const pointsDiff = exitPrice - entryPrice;
                    pnl = pointsDiff * quantity * 50;
                    if (type === 'Short') {
                        pnl = -pnl;
                    }
                }
            }

            return {
                id: Date.now() + Math.random(), // ID temporaire unique
                accountId: accountId,
                accountName: accountName,
                date: date,
                entryTime: entryTime,
                exitTime: exitTime,
                symbol: symbol,
                type: type,
                entryPrice: entryPrice,
                exitPrice: exitPrice,
                quantity: quantity,
                stopLoss: null,
                takeProfit: null,
                setup: setup,
                protections: [],
                notes: notes,
                pnl: pnl,
                timestamp: new Date().toISOString()
            };
        }

        function parseDate(dateStr) {
            if (!dateStr) return null;
            
            // Nettoyer la cha√Æne (enlever les timezone et heures si pr√©sentes)
            dateStr = dateStr.split(' ')[0].trim();
            
            // Format YYYY-MM-DD ou YYYY/MM/DD (ISO)
            let match = dateStr.match(/(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})/);
            if (match) {
                const year = match[1];
                const month = match[2].padStart(2, '0');
                const day = match[3].padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            // Format MM/DD/YYYY ou MM-DD-YYYY (format US - TopStep)
            // D√©tecter si c'est du format US : si le premier nombre > 12, c'est forc√©ment du DD/MM
            match = dateStr.match(/(\d{1,2})[-\/](\d{1,2})[-\/](\d{4})/);
            if (match) {
                const first = parseInt(match[1]);
                const second = parseInt(match[2]);
                const year = match[3];
                
                // Si le premier nombre > 12, c'est forc√©ment du DD/MM/YYYY
                if (first > 12) {
                    const day = match[1].padStart(2, '0');
                    const month = match[2].padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
                // Si le deuxi√®me nombre > 12, c'est forc√©ment du MM/DD/YYYY
                else if (second > 12) {
                    const month = match[1].padStart(2, '0');
                    const day = match[2].padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
                // Sinon, on assume format US (MM/DD/YYYY) car c'est TopStep
                else {
                    const month = match[1].padStart(2, '0');
                    const day = match[2].padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
            }
            
            // Format avec ann√©e sur 2 chiffres
            match = dateStr.match(/(\d{1,2})[-\/](\d{1,2})[-\/](\d{2})/);
            if (match) {
                const first = parseInt(match[1]);
                const second = parseInt(match[2]);
                let year = '20' + match[3];
                
                if (first > 12) {
                    const day = match[1].padStart(2, '0');
                    const month = match[2].padStart(2, '0');
                    return `${year}-${month}-${day}`;
                } else {
                    const month = match[1].padStart(2, '0');
                    const day = match[2].padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
            }
            
            return null;
        }

        function showCSVPreview() {
            document.getElementById('csvUploadStep').style.display = 'none';
            document.getElementById('csvPreviewStep').style.display = 'block';
            
            document.getElementById('csvTradeCount').textContent = csvParsedTrades.length;
            document.getElementById('csvImportCount').textContent = csvParsedTrades.length;
            
            const tbody = document.getElementById('csvPreviewTable');
            tbody.innerHTML = csvParsedTrades.map(trade => {
                const pnlClass = trade.pnl >= 0 ? 'text-green-600' : 'text-red-600';
                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-3 py-2 text-xs">${new Date(trade.date).toLocaleDateString('fr-FR')}</td>
                        <td class="px-3 py-2 text-xs font-medium">${trade.symbol}</td>
                        <td class="px-3 py-2 text-xs">
                            <span class="px-2 py-1 rounded text-xs ${trade.type === 'Long' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${trade.type}
                            </span>
                        </td>
                        <td class="px-3 py-2 text-xs">$${trade.entryPrice.toFixed(2)}</td>
                        <td class="px-3 py-2 text-xs">$${trade.exitPrice.toFixed(2)}</td>
                        <td class="px-3 py-2 text-xs">${trade.quantity}</td>
                        <td class="px-3 py-2 text-xs font-semibold ${pnlClass}">$${trade.pnl.toFixed(2)}</td>
                        <td class="px-3 py-2 text-center">
                            <span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs">
                                <i class="fas fa-check-circle"></i> OK
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function confirmCSVImport() {
            if (csvParsedTrades.length === 0) {
                alert('Aucun trade √† importer');
                return;
            }

            // Ajouter tous les trades
            csvParsedTrades.forEach((trade, index) => {
                // G√©n√©rer un ID unique (entier) pour chaque trade
                trade.id = Date.now() + index; // ID unique bas√© sur timestamp + index
                trades.push(trade);
            });

            saveToStorage();
            refreshAllModules();
            
            closeModal('importCSVModal');
            
            alert(`‚úÖ ${csvParsedTrades.length} trade(s) import√©(s) avec succ√®s !\n\nVous pouvez maintenant les modifier individuellement pour ajouter des protections, notes, etc.`);
            
            csvParsedTrades = [];
        }

        function cancelCSVImport() {
            if (confirm('Voulez-vous vraiment annuler l\'import ?')) {
                csvParsedTrades = [];
                closeModal('importCSVModal');
            }
        }

</script>
    
